<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
  // _paq array initialization and tracking script
  var _paq = _paq || [];
  _paq.push(["trackPageView"]);
  _paq.push(["enableLinkTracking"]);
  (function () {
    let u="//unicef-etools-trial.innocraft.cloud/";
    _paq.push(["setTrackerUrl", u + "piwik.php"]);
    _paq.push(["setSiteId", '1']);
    let d = document, g = d.createElement("script"), s = d.getElementsByTagName("script")[0];
    g.type = "text/javascript"; g.defer = true; g.async = true; g.src = u + "piwik.js";
    s.parentNode.insertBefore(g, s);
  })();
</script>

<dom-module id="etools-piwik-analytics">
  <script>
    Polymer({
      is: 'etools-piwik-analytics',
      properties: {
        page: {
          type: String,
          observer: 'pageView'
        },
        queryEntered: {
          type: Boolean,
          value: false
        },
      },

      // tracks exports and filtering
      trackEvent: function(e) {
        switch (e.detail.sourceEvent.currentTarget.innerText) {
        // tracks document exports
          case 'EXPORT':
            _paq.push([
              'trackEvent',
              this.page,
              'export',
              this.user.groups.map(g => g.name)
            ])
            break
          // tracks filtered charts on dashboard/trips
          case 'GET CHART':
            _paq.push([
              'trackEvent',
              this.page,
              'chart filtered',
              this.user.groups.map(g => g.name)
            ])
            break
          // tracks drop-down filtering in PMP
          case 'ADD FILTER':
            _paq.push([
              'trackEvent',
              this.page,
              'chart filtered',
              this.user.groups.map(g => g.name)
            ])
        }
      },

      // sets global event listeners, sets global error listener
      attached: function() {
        document.addEventListener('tap', this.trackEvent.bind(this));
        document.addEventListener('keyup', this.typing.bind(this));
        // window.onerror = this.error
      },

      // checks if typing is in relevant input field, tracks search bar filtering
      typing: function() {
        if (event.path[0].value && event.path[7].id === 'query' && this.queryEntered === false) {
          _paq.push([
            'trackEvent',
            this.page,
            'search bar used',
            this.user.groups.map(g => g.name)
          ])
          this.set('queryEntered', true)
        }
      },

      // handles tracking error messages
      // error: function (msg, url, lineNo, columnNo, error) {
      //   let message = [
      //     'Message: ' + msg,
      //     'URL: ' + url,
      //     'Line: ' + lineNo,
      //     'Column: ' + columnNo,
      //     'Error object: ' + JSON.stringify(error)
      //   ].join(' - ');
      //   _paq.push(['trackEvent', 'error', 'javascript error', message])
      // },

      // tracks internal pageviews that aren't picked up with trackPageView
      pageView: function() {
        debugger
        _paq.push([
          'trackEvent',
          this.page,
          'tap',
          'in-app navigation'
        ])
      },
    });
  </script>
</dom-module>
