<!--
App global configuration
-->
<link rel="import" href="../../bower_components/etools-dexiejs/etools-dexiejs.html">
<link rel="import" href="../../scripts/lodash/lodash.html">

<script>
  'use strict';

  /**
   * for db versioning check
   * https://github.com/dfahlander/Dexie.js/wiki/Design#database-versioning
   */
  let etoolsCustomDexieDb = new Dexie('dashApp');
  etoolsCustomDexieDb.version(1).stores({
    collectionsList: 'name, expire',
    countries: 'id',
    user: 'id',
    unicefUsers: 'id',
    countryProgrammes: 'id, name, wbs, from_date',
    offices: 'id, name',
    partners: 'id, name',
    cso_dashboard: 'intervention_id, partner_name',
    trips: 'id, supervisor_name, purpose_of_travel, traveler, created_date',
    tripsSupervised: 'id,traveler',
    mapInterventions: 'id, status',
    locations: 'id',
    actionPointsByMe: 'id',
    actionPointsForMe: 'id',
    partnerships: 'id',
    hactGraphs: 'programmatic_visits',
    listsExpireMapTable: "&name, expire",
    ajaxDefaultDataTable: "&cacheKey, data, expire",
    attachments: "url, created, filename"
  });

  window.EtoolsRequestCacheDb = etoolsCustomDexieDb;

  let etoolsAjaxDefaultDexieDbPrefix = 'dashboard';

  var etoolsAppConfig = {

    db: etoolsCustomDexieDb,

    // globals
    globals: {

      baseSite: window.location.origin,
      basePath: (window.location.port === '8080') ? '/' : '/dash/',
      serverBackend: (window.location.port !== '8080'),
      loginPath: window.location.origin + '/login/',

      getEndpoint: function(endpointName, data) {
        let endpoint = JSON.parse(JSON.stringify(etoolsAppConfig.endpoints[endpointName]));
        if (endpoint && endpoint.hasOwnProperty('template') && endpoint.template !== '') {
          endpoint.url = window.location.origin + _.template(endpoint.template)(data);
        }

        return endpoint;
      },

      getAllPermissions: function() {
        return etoolsAppConfig.permissions;
      }
    },

    // permissions
    permissions: {
      defaultPermissions: [
        'loggedInDefault',
        'userInfoMenu',
        'viewPartnerDetails'
      ],
      partnerOnlyPermissions: ['interventionsMenu'],
      partnerPermissions: ['interventionsMenu'],
      managementPermissions: [
        'statsMenu',
        'editPartnerDetails'
      ],
      superPermissions: [
        'loggedInDefault',
        'userInfoMenu',
        'interventionsMenu',
        'statsMenu',
        'viewPartnerDetails',
        'editPartnerDetails'
      ]
    }
  };

  let localEps = {
    user: {
      url: '/users/api/profile/',
      exp: 30 * 60 * 1000, // 30min
      cachingKey: 'user',
      cacheTableName: 'user'
    },
    agreements: {
      // template: '/management/api/stats/agreements/',
      url: '../../data/agreements.json',
      exp: 30 * 60 * 1000, // 30min
      cachingKey: 'agreements',
      cacheTableName: 'agreements'
    },
    countries: {
      url: '../../data/countries.json',
      exp: 6 * 60 * 60 * 1000, // 6h
      cachingKey: 'countries',
      cacheTableName: 'countries'
    },
    partners: {
      url: '../../data/partners.json',
      exp: 6 * 60 * 60 * 1000, // 6h
      cachingKey: 'partners',
      cacheTableName: 'partners'
    }

  };

  let serverEps = {
    unicefUsers: {
      url: '/api/v3/users/',
      exp: 60 * 60 * 1000, // 1h
      cachingKey: 'unicefUsers',
      cacheTableName: 'unicefUsers'
    },
    user: {
      url: '/users/api/profile/',
      exp: 30 * 60 * 1000, // 30min
      cacheTableName: 'user'
    },
    countryProgrammes: {
      url: '/api/v2/reports/countryprogramme/',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'countryProgrammes'
    },
    offices: {
      url: '/api/offices/',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'offices'
    },
    countries: {
      url: '/api/countries/', // API request receives a 404 for now
      exp: 6 * 60 * 60 * 1000, // 6h
      cacheTableName: 'countries'
    },
    userCountry: {
      url: '/api/v2/users/country'
    },
    changeCountry: {
      url: '/users/api/changecountry/'
    },
    partners: {
      url: '/api/v2/partners/hact',
      exp: 6 * 60 * 60 * 1000, // 6h
      cacheTableName: 'partners'
    },
    partnersDropdown: {
      url: '/api/v2/partners',
      exp: 6 * 60 * 60 * 1000, // 6h
      cacheTableName: 'partnersDropdown'
    },
    static: {
      url: '/api/v2/dropdowns/static',
      exp: 6 * 60 * 60 * 1000, // 6h
      cacheTableName: 'static'
    },
    sections: {
      url: '/api/sections',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'sections'
    },
    sectors: {
      url: '/api/reports/sectors',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'sectors'
    },
    actionPointsByMe: {
      template: '/api/t2f/action_points/?f_assigned_by=<%=id%>&mf_status=ongoing,open',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'actionPointsByMe'
    },
    actionPointsForMe: {
      template: '/api/t2f/action_points/?f_person_responsible=<%=id%>&mf_status=ongoing,open',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'actionPointsForMe'
    },
    mapInterventions: {
      template: '/api/v2/interventions/map<%=filter%>',
      cacheTableName: 'mapInterventions'
    },
    locations: {
      url: '/api/locations',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'locations'
    },
    partnerships: {
      template: '/api/v2/interventions/dash',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'partnerships'
    },
    cso_dashboard: {
      template: '/api/v2/interventions/partnership-dash',
      exp: 6 * 60 * 60 * 1000, // 6h
      cacheTableName: 'cso_dashboard'
    },
    trips: {
      template: '/api/t2f/travels/?f_traveler=<%=id%>',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'trips'
    },
    tripsSupervised: {
      template: '/api/t2f/travels/?f_supervisor=<%=id%>',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'tripsSupervised'
    },
    tripsDashboard: {
      template: '/api/t2f/travels/dashboard/?'
    },
    actionPointsBySection: {
      template: '/api/t2f/action_points/dashboard/'
    },
    actionPointsBySectionOffice: {
      template: '/api/t2f/action_points/dashboard/?office_id=<%=office%>'
    },
    myProfile: {
      template: '/api/v3/users/profile/',
    },
    hactGraphs: {
      template: '/api/v2/hact/graph/2018/',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'hactGraphs',
    },
    attachments: {
      template: '/api/v2/attachments/',
      exp: 6 * 60 * 60 * 1000,
      cacheTableName: 'attachments'
    }


  };
  /* jshint ignore:start */
  etoolsAppConfig.endpoints = etoolsAppConfig.globals.serverBackend ? serverEps : localEps;
  /* jshint ignore:end */

</script>
