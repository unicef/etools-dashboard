<!--
App global configuration
-->
<link rel="import" href="../../bower_components/etools-dexiejs/etools-dexiejs.html">
<link rel="import" href="../../scripts/lodash/lodash.html">

<script>
    'use strict';

    /**
     * for db versioning check
     * https://github.com/dfahlander/Dexie.js/wiki/Design#database-versioning
     */
    let etoolsCustomDexieDb = new Dexie('dashApp');
    etoolsCustomDexieDb.version(1).stores({
      collectionsList: 'name, expire',
      countries: 'id',
      user: 'id',
      countryProgrammes: 'id, name, wbs, from_date',
      offices: 'id, name',
      partners: 'id',
      cso_dashboard: 'intervention_id, partner_name',
      trips: 'id, supervisor_name, purpose_of_travel, traveler, created_date',
      mapInterventions: 'id, status',
      locations: 'id',

      // etools-ajax v2.0.0 requirements
      listsExpireMapTable: '&name, expire',
      ajaxDefaultDataTable: '&cacheKey, data, expire',
    });

    let etoolsAjaxDefaultDexieDbPrefix = 'dashboard';

    // configure app dexie db to be used for caching
    window.EtoolsRequestCacheDb = window.EtoolsRequestCacheDb || etoolsCustomDexieDb;

    var etoolsAppConfig = {

      db: etoolsCustomDexieDb,

      // globals
      globals: {

        baseSite: window.location.origin,
        basePath: (window.location.port === '8080') ? '/' : '/dash/',
        serverBackend: (window.location.port !== '8080'),
        loginPath: window.location.origin + '/login/',

        getEndpoint: function(endpointName, data) {
          let endpoint = JSON.parse(JSON.stringify(etoolsAppConfig.endpoints[endpointName]));
          if (endpoint && endpoint.hasOwnProperty('template') && endpoint.template !== '') {
            endpoint.url = window.location.origin + _.template(endpoint.template)(data);
          }

          return endpoint;
        },

        getAllPermissions: function() {
          return etoolsAppConfig.permissions;
        }
      },

      // permissions
      permissions: {
        defaultPermissions: [
          'loggedInDefault',
          'userInfoMenu',
          'viewPartnerDetails'
        ],
        partnerOnlyPermissions: ['interventionsMenu'],
        partnerPermissions: ['interventionsMenu'],
        managementPermissions: [
          'statsMenu',
          'editPartnerDetails'
        ],
        superPermissions: [
          'loggedInDefault',
          'userInfoMenu',
          'interventionsMenu',
          'statsMenu',
          'viewPartnerDetails',
          'editPartnerDetails'
        ]
      }
    };

    let localEps = {
      user: {
        url: '/users/api/profile/',
        exp: 30 * 60 * 1000, // 30min
        cachingKey: 'user'
      },
      agreements: {
        // template: '/management/api/stats/agreements/',
        url: '../../data/agreements.json',
        exp: 30 * 60 * 1000, // 30min
        cachingKey: 'agreements'
      },
      countries: {
        url: '../../data/countries.json',
        exp: 6 * 60 * 60 * 1000, // 6h
        cachingKey: 'countries'
      },
      partners: {
        url: '../../data/partners.json',
        exp: 6 * 60 * 60 * 1000, // 6h
        cachingKey: 'partners'
      }

    };

    let serverEps = {
      unicefUsers: {
        url: '/users/api/',
        exp: 60 * 60 * 1000, // 1h
        cachingKey: 'unicefUsers'
      },
      user: {
        url: '/users/api/profile/',
        exp: 30 * 60 * 1000, // 30min
        cachingKey: 'user'
      },
      countryProgrammes: {
         url: '/api/v2/reports/countryprogramme/',
         exp: 6 * 60 * 60 * 1000,
         cachingKey: 'countryProgrammes'
       },
      offices: {
         url: '/api/offices/',
         exp: 6 * 60 * 60 * 1000,
         cachingKey: 'offices'
      },
      countries: {
        url: '/api/countries/', // API request receives a 404 for now
        exp: 6 * 60 * 60 * 1000, // 6h
        cachingKey: 'countries'
      },
      userCountry: {
//        url : '/users/country',
        url: '/api/v2/users/country'
      },
      changeCountry: {
        url: '/users/api/changecountry/'
      },
      partners: {
          url: '/api/v2/partners/hact',
          exp: 6 * 60 * 60 * 1000, // 6h
          cachingKey: 'partners'
      },
      partnersDropdown: {
        url: '/api/v2/partners',
        exp: 6 * 60 * 60 * 1000, // 6h
        cachingKey: 'partnersDropdown'
      },
      static: {
        url: '/api/v2/dropdowns/static',
        exp: 6 * 60 * 60 * 1000, // 6h
        cachingKey: 'static'
      },

      sections: {
        url: '/api/sections',
        exp: 6 * 60 * 60 * 1000,
        cachingKey: 'sections'
      },
      sectors: {
        url: '/api/reports/sectors',
        exp: 6 * 60 * 60 * 1000,
        cachingKey: 'sectors'
      },
			actionPointsByMe: {
        template: '/api/t2f/action_points/?f_assigned_by=<%=id%>&mf_status=ongoing,open'
      },
      actionPointsForMe: {
        template: '/api/t2f/action_points/?f_person_responsible=<%=id%>&mf_status=ongoing,open'
      },
      mapInterventions: {
        template: '/api/v2/interventions/map<%=filter%>',
      },
      locations: {
        url: '/api/locations',
        exp: 6 * 60 * 60 * 1000,
        cachingKey: 'locations'
      },
      partnerships: {
        template: '/api/v2/interventions/dash'
      },
      cso_dashboard: {
        template: '/api/v2/interventions/partnership-dash',
        exp: 6* 60 * 60 * 1000, // 6h
        cachingKey: 'cso_dashboard',
      },
      trips: {
        template: '/api/t2f/travels/?f_traveler=<%=id%>'
      },
      tripsSupervised: {
        template: '/api/t2f/travels/?f_supervisor=<%=id%>'
      },
      tripsDashboard: {
        template: '/api/t2f/travels/dashboard/?'
      },
      actionPointsBySection: {
        template: '/api/t2f/action_points/dashboard/'
      },
      actionPointsBySectionOffice: {
        template: '/api/t2f/action_points/dashboard/?office_id=<%=office%>'
      },
      myProfile: {
        template: '/api/v3/users/profile/',
      },

    };
    /* jshint ignore:start */
    etoolsAppConfig.endpoints = etoolsAppConfig.globals.serverBackend ? serverEps : localEps;
    /* jshint ignore:end */

</script>
