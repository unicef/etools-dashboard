<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-ajax/etools-ajax.html">

<link rel="import" href="redux-bahaviors/common-static-data-redux-bahavior.html">

<dom-module id="trips-data">

	<template>
		<etools-ajax id="ajax"
								 endpoint="[[endpoint]]"
								 caching-storage="dexie"
								 on-success="_handleResponse"></etools-ajax>
	</template>

	<script>
		(function () {
			'use strict';

			Polymer({

				is: 'trips-data',
				behaviors: [
					dashBehaviors.EtoolsStaticCommonDataReduxBehavior,
					etoolsAppConfig.globals
				],
				properties: {
					endpoint: {
						type: Object
					},
          user: {
            type: Object,
            observer: '_setEndpoint'
          },
				},
				actions: {
					setTripsData: function (trips) {
						return {
							type: 'SET_TRIPS_DATA',
							trips: trips
						};
					}
				},

				_setEndpoint: function () {
					this.set('endpoint', this.getEndpoint('trips', {id: this.user.id}));
				},

				_handleResponse: function (response) {
					var data = _.get(response, 'detail.data', []);
					if (data.length) {
						this.dispatch('setTripsData', this._prepareTripsData(data));
					}
				},

				_prepareTripsData: function (data) {
					return data.map(function (trip) {
						return _.pick(trip, ['id','start_date','purpose','reference_number','supervisor_name']);
					});
				}

			});
		})();
	</script>

</dom-module>
