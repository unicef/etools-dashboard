<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<dom-module id="map-interventions-data">
  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="mapInterventions"
                 on-success="_handleResponse">
    </etools-ajax>
  </template>

  <script>
    Polymer({
      is: "map-interventions-data",
      behaviors: [
        dashBehaviors.DataElementBehavior,
        etoolsAppConfig.globals
      ],
      properties: {
        filteredInterventions: {
          type: Array,
          readOnly: true,
          notify: true
        },
        intLocMap: {
          type: Object,
          readOnly: true,
          notify: true,
        },
        filter: {
          type: Object,
          observer: 'query',
          notify: true,
        }
      },
      // This function examines each intervention sector location and stores the sector data and intervention data
      // in a dictionary/object key with that location's id as the key. A location can appear in multiple interventions and in various sectors
      // so all interventions with a particular sector location will have their data appended to that sector locations object store;
      // here called 'intLocMap'.
      _normalizeIntData: function(data) {
        if (!_.isEmpty(this.intLocMap)) {
          return;
        }
        var interventionsLocationsMap = {};
        data.map(function(int, i) {
          var pickedInt = {};
          pickedInt[int.id] = _.pick(int, 'partner_name', 'number', 'title');
          var sec_locs = _.get(int, 'sector_locations');
          sec_locs = _.flatten(sec_locs.map(function(sec) {
            return _.get(sec, 'locations', []);
          }));
          var pickedSec = _.get(int, 'sector_locations').map(function(sector) {
            return _.get(sector, 'sector');
          }).reduce(function(curr, nxt) {
            curr[nxt.id] = nxt;
            return curr;
          }, {});
          pickedInt[int.id].sectors = pickedSec;
          sec_locs.map(function(loc) {
            var _loc = {};
            if (!_.isEmpty(interventionsLocationsMap[loc])) {
              var newInt = _.assign({}, interventionsLocationsMap[loc].interventions, pickedInt);
              _loc[loc] = {
                interventions: newInt
              };
            } else {
              _loc[loc] = {
                interventions: pickedInt,
              }
            }
            _.assign(interventionsLocationsMap, _loc);
          });
        });
        this._setIntLocMap(interventionsLocationsMap);
        this.set('filter', {status:'active'});
      },
      query: function(filter) {
        this.fire('global-loading', {message: 'Loading map...', active: true});
        if (_.isEmpty(this.intLocMap) && !_.isEmpty(filter)) {
          return;
        }
        var filterStr = '';
        if (!_.isEmpty(filter)) {
          var params = [];
          _.keys(filter).forEach(function(k) {
            params.push(k + '=' + filter[k]);
          });
          filterStr += '?' + params.join('&');
        }
        var newEp = this.getEndpoint('mapInterventions', {filter: filterStr});
        if (_.isEqual(this.endpoint, newEp)) {
          return;
        }
        this.set('endpoint', newEp);
      },
      _formatInterventions: function(data) {
        var self = this;
        var locations = _.flatten(data.map(function(intervention) {
          var sec_locs = _.flatten(intervention.sector_locations.map(function(locs) {
            return locs.locations;
          }));
          return sec_locs;
        }));
        locations = _.uniq(locations);
        self._setFilteredInterventions(locations);
        this.fire('global-loading');
      },
      _handleResponse: function(res) {
        var data = _.get(res, 'detail.data', res.detail);
        if (_.isEmpty(this.intLocMap)) {
          this._normalizeIntData(data);
        } else {
          this._formatInterventions(data);
        }
      }
    });
  </script>
</dom-module>