<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<dom-module id="trips-dashboard-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 on-success="_handleResponse"
                 on-fail="_handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'trips-dashboard-data',
        behaviors: [
          etoolsAppConfig.globals,
          dashBehaviors.DataElementBehavior
        ],
        properties: {
          tripsData: {
            type: Object,
            readOnly: true,
            notify: true
          },
          filter: {
            type: Object,
            observer: '_filterChanged'
          }

        },
        attached: function() {
          this.ajaxEl = this.$.ajax;
          this.ajaxEl.set('method', 'GET');
        },
        _filterChanged: function(filter) {
          if (!_.isEmpty(filter)) {
            this.async(function(){
              var endpointParams = _.keys(filter).filter(function(key){
                return filter[key];
              }).
              map(function(k){
                return k + '=' + filter[k];
              }).
              join('&');
              var endpoint = this.getEndpoint('tripsDashboard');
              endpoint.url += endpointParams;
              if (!_.isEqual(endpoint, this.endpoint)){
                this.fire('global-loading', {message: 'Loading trips chart data...', active: true});
                this.set('endpoint', endpoint);
              }
            }.bind(this));

          }else {
            this.ajaxEl.set('url', null);
          }
        },
        _handleResponse: function(response) {
          var data = _.get(response, 'detail', []);
          this._setTripsData(data);
          this.fire('global-loading');
        },

      });
    })();
  </script>
</dom-module>