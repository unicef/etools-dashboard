<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">

<dom-module id="partners-data">
  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="partners"
                 on-success="_handleResponse">
    </etools-ajax>
  </template>

  <script>



    (function() {
      'use strict';
       Polymer( {
        is: 'partners-data',
        behaviors: [
          dashBehaviors.DataElementBehavior,
          etoolsAppConfig.globals
        ],
        observers: ['init(active)'],
        properties: {
          endpointName: {
            type: String,
            value: 'partners'
          },
          currentQuery: {
            type: Object,
            value: null
          },
          filteredPartners: {
            type: Array,
            readOnly: true,
            notify: true
          },
          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },
          filteredTotalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },
          totals: {
            type: Array,
            notify: true,
            readOnly: true
          },
          dataLoadedEventName: {
            type: String,
            value: 'partners-loaded'
          },
          loadedInitially: {
            type: Boolean,
            value: false
          },
          resultsTotals: {
            type: Boolean,
            value: false
          }

        },
        init: function(active) {
          if (active && !this.loadedInitially) {
            this.fire('global-loading', {message: 'Loading partners data...', active: true});
            this._elementReady();
            this.set('loadedInitially', true);
          }
        },
        query: function(searchString, order, pageSize, pageNumber) {
          let self = this;
          this.db.partners.toArray().then(res=> {
            self._setTotals(self._computeTotals(res));
            self._setTotalResults(res.length);
          });
          this.db.transaction('r', this.db.partners, ()=> {
            let queryResult = self.db.partners;
            if (order === 'desc') {
              queryResult = queryResult.reverse();
            } else {
              queryResult = queryResult.toCollection();
            }
            if (!_.isEmpty(searchString)) {
              queryResult = queryResult.filter(function(partner) {
                return _.includes(partner.name.toLowerCase(), searchString.toLowerCase());
              });
            }
            return Dexie.Promise.all([
              queryResult.count(),
              // Use clone() as offset() and limit() otherwise mutates the same query that is counted
              queryResult.clone()
                  .offset((pageNumber - 1) * pageSize)
                  .limit(pageSize)
                  .toArray()]);
          }).then(function(countAndResult) {
            self._setFilteredTotalResults(countAndResult[0]);
            self._setFilteredPartners(countAndResult[1]);
          }).catch(function(error) {
            console.error('Error querying partners: ', error);
          });
        },
        _computeTotals: function(results) {
          this.resultsTotals = true;
          return _(results).reduce((sum, obj)=> {
            let picked = _(obj).pick([
              'shared_partner',
              'total_ct_cp',
              'hact_values',
              'total_ct_cy',
              'hact_min_requirements',
              'outstanding_findings'
            ]).value();
            _.assign(picked, _.pick(picked.hact_values, [
                  'planned_cash_transfer',
                ]), _.pick(picked.hact_min_requirements, 'programme_visits'),
                {
                  follow_up_required: picked.hact_values.spot_checks.follow_up_required
                },
                {
                  audits_completed: picked.hact_values.audits.completed
                },
                {
                  programmatic_visits_completed_total: picked.hact_values.programmatic_visits.completed.total
                },
                {
                  programmatic_visits_planned_total: picked.hact_values.programmatic_visits.planned.total
                },
                {
                  spot_checks_completed_total: picked.hact_values.spot_checks.completed.total
                },
                {
                  audits_mr: picked.hact_values.audits.minimum_requirements
                },
                {
                  outstanding_findings: picked.outstanding_findings
                },
                {
                  mr_spot_checks: picked.hact_min_requirements.spot_checks
                });
            picked = _.omit(picked, ['hact_values', 'hact_min_requirements']);
            _(picked).each((val, key)=> {
              let currValue = sum[key] ? sum[key] : 0;
              if (key === 'shared_partner') {
                sum[key] = currValue + (val === 'No' ? 0 : 1);
              } else {
                sum[key] = currValue + Number(val);
              }
            });
            return sum;
          }, {});
        },
      });
    }
    )();

  </script>
</dom-module>
