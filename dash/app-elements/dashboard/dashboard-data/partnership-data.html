<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">

<dom-module id="partnership-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="dexie"
                 on-success="_handleResponse"
                 on-fail="_handleErrorResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partnership-data',
        behaviors: [etoolsAppConfig.globals],
        properties: {
          partnership: {
            type: Object,
            readOnly: true,
            notify: true
          },
          filter: {
            type: Object,
            observer: '_filterChanged'
          }
        },
        attached: function() {
          this.ajaxEl = this.$.ajax;
          this.ajaxEl.set('method', 'GET');
        },
        _filterChanged: function(filter) {
          if (!_.isEmpty(filter)) {
            this.fire('global-loading', {message: 'Loading partnership data...', active: true});
            if(filter.office) {
              this.set('endpoint', this.getEndpoint('partnershipOffice',
                  {
                    country_programme: filter.country_programme,
                    office: filter.office
                  }
              ));
            } else {
              this.set('endpoint', this.getEndpoint('partnership',
                  {
                    country_programme: filter.country_programme,
                  }
              ));
            }
          }
        },
        _handleResponse: function(response) {
          var data = _.get(response,'detail');
          console.log('partnership response', data);
          this._setPartnership(data);
        },
        _handleErrorResponse: function(response) {
          this.fire('global-loading', {active: false});
          var errors = response.detail.request.detail.request.response;
          if (this.ajaxEl.method === 'POST' || this.ajaxEl.method === 'PATCH') {
            // TODO: improve etools-ajax on-fail event data model (received errors)
            var errorMessage = 'An error occurred during save!';
            if (errors) {
              var errorMessages = ['Errors occurred:\n'];
              if (Array.isArray(errors) && errors.length > 0) {
                errors.forEach(function(err) {
                  errorMessages.push(err + '\n');
                });
              } else if (typeof errors === 'object' && Object.keys(errors).length > 0) {
                for (var errField in errors) {
                  if (typeof errors[errField] === 'string') {
                    errorMessages.push('Field ' + errField + ' - ' + errors[errField] + '\n');
                  } else if (typeof errors[errField] === 'object' && Object.keys(errors[errField]).length > 0) {
                    for (var errF in errors[errField]) {
                      errorMessages.push('Field ' + errField + '(' + errF + ') - ' + errors[errField][errF] + '\n');
                    }
                  } else if (Array.isArray(errors[errField]) && errors[errField].length > 0) {
                    for(var key in errors[errField]) {
                      errorMessages.push(errors[errField][key] + '\n');
                    }
                  }
                }
              }
              if (errorMessages.length > 1) {
                errorMessage = errorMessages.join('');
              }
            }
            this.fire('toast', {text: errorMessage, showCloseBtn: true});
          }
        }

      });
    })();
  </script>
</dom-module>
