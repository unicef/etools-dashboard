<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<dom-module id="partnership-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="partnerships_cso"
                 on-success="_handleResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partnership-data',
        behaviors: [
            etoolsAppConfig.globals,
            dashBehaviors.DataElementBehavior
        ],
        observers:['init(active)'],
        properties: {
          endpointName: {
            type: String,
            value: 'partnerships_cso'
          },
          currentQuery: {
            type: Object,
            value: null
          },
          filteredPartnerships: {
            type: Array,
            readOnly: true,
            notify: true
          },
          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },
          dataLoadedEventName: {
            type: String,
            value: 'partnerships-loaded'
          }
        },

        init: function(active) {
          if (active) {
            this.fire('global-loading', {message: 'Loading interventions data...', active: true});
            this._elementReady();
          }
        },

        query: function(searchString, order, pageSize, pageNumber, status) {
          var self = this;
          this.db.transaction('r', this.db.partnerships_cso, function() {
            var queryResult = self.db.partnerships_cso;
            if (order === 'desc') {
              queryResult = queryResult.reverse();
            }else {
              queryResult = queryResult.toCollection();
            }
            if (!_.isEmpty(searchString)) {
              queryResult = queryResult.filter(function(partner) {
                return _.includes(partner.partner_name.toLowerCase(), searchString.toLowerCase());
              });
            }
            if (status) {
              queryResult = queryResult.filter(function(partner) {
                return partner.status === 'closed';
              });
            } else {
              queryResult = queryResult.filter(function(partner) {
                return partner.status !== 'closed';
              });
            }

            return Dexie.Promise.all([
              queryResult.count(),
              // Use clone() as offset() and limit() otherwise mutates the same query that is counted
              queryResult.clone()
                  .offset((pageNumber - 1) * pageSize)
                  .limit(pageSize)
                  .toArray()]);
          }).then(function(countAndResult) {
            self._setTotalResults(countAndResult[0]);
            self._setFilteredPartnerships(countAndResult[1]);
            self.fire('global-loading');
          }).catch(function(error) {
            console.error('Error querying partners: ', error);
          });
        },

      });
    })();
  </script>
</dom-module>
