<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<link rel="import" href="../../../app-behaviors/date-behavior.html">
<link rel="import" href="../../../app-behaviors/common-general-behavior.html">


<dom-module id="partnership-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="cso_dashboard"
                 on-success="_handleResponse"></etools-ajax>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'partnership-data',
        behaviors: [
          etoolsAppConfig,
          dashBehaviors.DataElementBehavior,
          dashBehaviors.DateBehavior,
          dashBehaviors.CommonGeneralBehavior,
        ],
        observers: ['init(active)'],
        properties: {
          endpointName: {
            type: String,
            value: 'cso_dashboard'
          },
          currentQuery: {
            type: Object,
            value: null
          },
          filteredPartnerships: {
            type: Array,
            readOnly: true,
            notify: true
          },
          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },
          dataLoadedEventName: {
            type: String,
            value: 'partnerships-loaded'
          },
          predicates: {
            type: Object,
            value: function() {
              return {
              searchString: (qs, partner)=> _.includes(partner.partner_name.toLowerCase(), qs.toLowerCase()),
              sectors: (sectors, partner)=> _.intersection(sectors, _.trim(partner.sectors)).length,
              offices: (offices, partner)=> _.intersection(offices, _.trim(partner.offices_names)).length,
              status: (status, partner)=> _.includes(status, partner.status)? true: partner.status==='closed'? false:true,
              startAfterDate: (date, partner)=> _.isEmpty(partner.start) ? true
                : this.prepareDate(partner.start) > this.prepareDate(date),
              endBeforeDate: (date, partner)=> _.isEmpty(partner.end) ? true
                : this.prepareDate(partner.end) < this.prepareDate(date),
              startBeforedate: (date, partner)=> _.isEmpty(partner.start) ? true
                :this.prepareDate(partner.start) < this.prepareDate(date),
              endAfterDate: (date, partner)=> _.isEmpty(partner.end) ? true
                : this.prepareDate(partner.end) > this.prepareDate(date)
            };
          }
          },
        },

        init: function(active) {
          if (active) {
            this.fire('global-loading', {
              message: 'Loading interventions data...',
              active: true,
              loadingSource: 'partner-data'
            });
            this._elementReady();
          }
        },

        query: function(searchString, sectors, offices, status, startAfterDate,
                        endBeforeDate, startBeforeDate, endAfterDate,
                        order, pageSize, pageNumber) {
          const params = [...arguments];
          const hasValue = val=> _.isNumber(val)? true : !_.isEmpty(val);
          const idxOfParamsToFilter = fp.compose(fp.without([8, 9, 10]), // no predicates for order, pageSize, pageNumber
            [fp.map(arg=> fp.indexOf(arg)(params)),
              fp.filter(hasValue)]);
          const fieldsToFilterIdxs = idxOfParamsToFilter(params);
          const predKeys = _.keys(this.predicates);
          const predicatesWithValues = _.pullAt([...predKeys], fieldsToFilterIdxs);
          console.log('filtering fields: ', predicatesWithValues);
          let self = this;
          this.db.transaction('r', this.db.cso_dashboard, function() {
            self.fire('global-loading', {active: true, message: 'Loading data...'});

            let queryResult = self.db.cso_dashboard.orderBy('partner_name');
            if (order === 'desc') {
              queryResult = queryResult.reverse();
            }

            const callPred = (pred, partner)=> self.predicates[pred](params[predKeys.indexOf(pred)], partner);
            queryResult = queryResult.filter(partner=> fp.every(
              pred=> callPred(pred, partner), predicatesWithValues));
            return Dexie.Promise.all([
              queryResult.count(),
              // Use clone() as offset() and limit() otherwise mutates the same query that is counted
              queryResult.clone()
                .offset((pageNumber - 1) * pageSize)
                .limit(pageSize)
                .toArray()]);
          }).then(function(countAndResult) {
            self._setTotalResults(countAndResult[0]);
            self._setFilteredPartnerships(countAndResult[1]);
            self.fire('global-loading');
            self.fire('global-loading', {loadingSource: 'partner-data'});
          }).catch(function(error) {
            console.error('Error querying partnerships-dash: ', error);
          });
        },

      });
    })();
  </script>
</dom-module>
