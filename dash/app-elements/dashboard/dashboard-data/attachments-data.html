<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<link rel="import" href="../../../app-behaviors/date-behavior.html">

<dom-module id="attachments-data">
  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="attachments"
                 on-success="_handleResponse">
    </etools-ajax>
  </template>

  <script>

    (function() {
      'use strict';
      Polymer({
        is: 'attachments-data',
        behaviors: [
          dashBehaviors.DataElementBehavior,
          dashBehaviors.DateBehavior,
          etoolsAppConfig.globals
        ],
        properties: {
          endpointName: {
            type: String,
            value: 'attachments'
          },
          filteredTotal: {
            type: Number,
            readOnly: true,
            notify: true
          },
          filteredAttachments: {
            type: Array,
            readOnly: true,
            notify: true
          },
          dataLoadedEventName: {
            type: String,
            value: 'attachments-loaded'
          },
          predicates: {
            type: Object,
            value: function() {
              return {
                searchString: (file, query) => _.includes(file.partner, query) || _.includes(file.intervention),
                doucumentType: (file, type) => file.file_type === type,
                uploadedBefore: (file, date) => this.prepareDate(file.created) < this.prepareDate(date),
                uploadedAfter: (file, date) => this.prepareDate(file.created) > this.prepareDate(date),
                uploadedBy: (file, name) => _.includes(file.uploaded_by, name)
              }
            }
          }

        },

        query: function(params) {
          const {pageNumber, pageSize, order} = params;
          this.db.transaction('r', this.db.attachments, () => {
            let queryResult = this.db.attachments.toCollection();
            queryResult.count().then(c=>console.log('count:', c))

            if (order === 'asc') {
              queryResult = queryResult.reverse();
            }
            queryResult = queryResult.filter(file => _.keys(params).reduce(
              (acc, next) => acc && this.predicates[next](file, params[next]), true));

            return Dexie.Promise.all([
              queryResult.count(),
              // Use clone() as offset() and limit() otherwise mutates the same query that is counted
              queryResult.clone()
                .offset((pageNumber - 1) * pageSize)
                .limit(pageSize)
                .toArray()])
              .then(countAndResult => {
                this._setFilteredTotal(countAndResult[0]);
                this._setFilteredAttachments(countAndResult[1]);
                this.fire('global-loading', {loadingSource: 'attachment-data'});
              })

          });
        }

      });
    })();

  </script>
</dom-module>