<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/etools-dropdown/etools-dropdown.html">
<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">
<link rel="import" href="../data-table/data-table-footer.html">
<link rel="import" href="dashboard-hact-detail.html">


<link rel="import" href="dashboard-data/partners-data.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-behavior.html">

<dom-module id="dashboard-hact-detail">
  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        --paper-input-container-label: {
          margin-left: 34px;
        };
        --paper-tooltip-opacity: 1;
        width: 100%;
      }

      #query {
        padding-bottom: 8px;
      }

      .hact-list {
        min-width: 1150px;
        overflow: scroll;
        padding: 0;
      }

      /* .fix {
        position: relative;
      }

      .fixie {
        position: fixed;
      } */

      .detail-list {
        min-width: 1600px;
      }

      /* .buffer {
        background-color: rgb(248, 248, 248);
        border-left: 1px solid rgba(0, 0, 0, 0.24);
      } */

      .nowrap {
        white-space: nowrap;
      }

      .padded {
        padding-right: 2px;
      }

      .group {
        padding-right: 16px;
        box-sizing: border-box;
      }

      .right {
        text-align: right;
      }

      .center {
        text-align: center;
      }

      /* .quarters {
        display: flex;
        flex-direction: row;
        justify-content: space-around;
      } */

      .right-side {
        text-align: right;
        border-left: 1px solid rgba(0, 0, 0, 0.24);
        box-sizing: border-box;
        padding-right: 2px;
      }

      .buffer-left {
        text-align: right;
        border-left: 15px solid rgb(248, 248, 248);
        box-sizing: border-box;
        padding-right: 2px;
      }

      .vertical {
        @apply(--layout-horizontal);
        @apply(--layout-flex);
        @apply(--layout-center);
      }

      /* data-table-header data-table-column {
        @apply(--layout-start);
        box-sizing: border-box;
      } */

      data-table-row.totals {
        --primary-background-color: var(--medium-theme-background-color);
        --custom-style: {
          background: var(--medium-theme-background-color);
          border-top: 1px solid rgba(0, 0, 0, 0.24);
          box-shadow: inset 0 -1px 0 0 rgba(0, 0, 0, 0.24);
        }
      }

      data-table-column.around {
        --custom-style: {
          @apply(--layout-around-justified);
        }
      }

      data-table-row.totals > div > div {
        font-weight: 500;
      }

      data-table-row:hover {
        background: var(--medium-theme-background-color);
      }

      /* .fixed {
        position: fixed;
      }

      .table-scroll {
        overflow-x: scroll;
      } */

      #center-toggle {
        width: 100%;
        text-align: center;
      }

      #toggle {
        font-size: 12px;
        cursor: pointer;
        font-weight: 500;
      }

      /* .toggle-fields {
        display: none;
        flex-grow: 2;
      } */

      /* data-table-header > div {
        display: flex;
      } */

      data-table-row > div[slot="row-data"] > div > div {
        display: flex;
        /* flex-flow: row nowrap; */
        /* align-items: center; */
        min-height: 40px;
      }

      /* data-table-header > div > data-table-column > data-table-column,  */
      /* data-table-row > div[slot="row-data"] > div:nth-of-type(2) > div > span {
        text-align: right;
        border-left: 1px solid rgba(0, 0, 0, 0.24);
        box-sizing: border-box;
        display: flex;
        align-items: center;
        flex-direction: row-reverse;
        height: 100%;
      } */

      /* .toggle-container {
        display: flex;
        flex-flow: row nowrap;
        justify-content: space-evenly;
        flex-grow: 1;
      } */

      .year-and-toggles {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .partner-link {
        overflow: hidden;
        cursor: pointer;
      }

      /* .hact-detail-table { */
        /* border: none; */
        /* border-right: solid 1px #DDEFEF; */
        /* border-collapse: separate; */
        /* border-spacing: 0; */
        /* font: normal 13px Arial, sans-serif; */
      /* } */

      /* .table-wrapper {
        position: relative
      } */

      .table-scroller {
        margin-left: 16.66667%;
        overflow-x: scroll;
        overflow-y: visible;
        /* padding-bottom: 5px; */
        /* width: 600px; */
      }

      /* .hact-detail-table .sticky-col { */
        /* border-left: solid 1px #DDEFEF; */
        /* border-right: solid 1px #DDEFEF; */
        /* left: 0; */
        /* position: absolute; */
        /* top: auto; */
        /* width: 120px; */
      /* } */
    </style>

    <paper-material id="detail-list" class="hact-list" elevation="1">
      <div id="detail-table" class="detail-list">
        <!-- <div class="table-scroller"> -->
          <!-- <div class="hact-detail-table"> -->
                  
            <!-- row of table headers -->
            <data-table-header no-collapse>
              <data-table-column class="col-2 layout horizontal" group-heading="OWEUF">
                <data-table-column class="col-12 layout horizontal" id="name" sortable>
                  IP Name
                </data-table-column>
              </data-table-column>
              <div class="col-5 layout horizontal">
                <data-table-column class="col-4 layout horizontal" group-heading="EFHISU">
                  <data-table-column class="col-4 vertical nowrap padded" id="total_ct_cp">
                    Risk Rating
                  </data-table-column>
                  <data-table-column class="col-2 vertical nowrap padded" id="hact_values.planned_cash_transfer">
                    Flags
                  </data-table-column>
                  <data-table-column class="col-6 right vertical padded nowrap" id="total_ct_cy">
                    Cash Transfers <br>
                    1 Jan - 31 Dec
                  </data-table-column>
                </data-table-column>
                <data-table-column class="col-8 layout horizontal" group-heading="PROGRAMMATIC VISITS">
                  <data-table-column class="col-3 nowrap padded right-side">
                    Cash Transfers <br>
                    1 Oct - 30 Sep
                  </data-table-column>
                  <data-table-column class="col-3 vertical right-side quarters" id="hact_values.micro_assessment_needed">
                    Planned <br>
                    <span class="col-3">Q1</span>
                    <span class="col-3 right-side">Q2</span>
                    <span class="col-3 right-side">Q3</span>
                    <span class="col-3 right-side">Q4</span>
                  </data-table-column>
                  <data-table-column class="col-2 nowrap vertical right-side" id="rating">
                    Minimum <br> Required
                  </data-table-column>
                  <data-table-column class="col-3 vertical right-side quarters">
                    Completed <br>
                    <span class="col-3">Q1</span>
                    <span class="col-3 right-side">Q2</span>
                    <span class="col-3 right-side">Q3</span>
                    <span class="col-3 right-side">Q4</span>
                  </data-table-column>
                  <!-- <data-table-column class="col-1 buffer"></data-table-column> -->
                </data-table-column>
              </div>
              <div class="col-5 layout horizontal">
                <data-table-column class="col-9 layout horizontal" group-heading="SPOT CHECKS">
                  <!-- <data-table-column class="col-half buffer right-side"></data-table-column> -->
                  <data-table-column class="col-2 vertical right-side">
                    Liquidations <br>
                    1 Oct - 30 Sep
                  </data-table-column>
                  <data-table-column class="col-3 vertical right-side quarters">
                    Planned <br>
                    <span class="col-3">Q1</span>
                    <span class="col-3 right-side">Q2</span>
                    <span class="col-3 right-side">Q3</span>
                    <span class="col-3 right-side">Q4</span>
                  </data-table-column>
                  <data-table-column class="col-2 vertical right-side">
                    Minimum <br> Required
                  </data-table-column>
                  <data-table-column class="col-2 vertical right-side">
                    Follow-up <br> Required
                  </data-table-column>
                  <data-table-column class="col-3 vertical right-side quarters">
                    Completed <br>
                    <span class="col-3">Q1</span>
                    <span class="col-3 right-side">Q2</span>
                    <span class="col-3 right-side">Q3</span>
                    <span class="col-3 right-side">Q4</span>
                  </data-table-column>
                  <!-- <data-table-column class="col-half buffer right-side"></data-table-column> -->
                </data-table-column>
                <data-table-column class="col-3 layout horizontal" group-heading="AUDITS">
                  <data-table-column class="col-4 right-side" id="hact_values.audits_mr">
                    Required
                  </data-table-column>
                  <data-table-column class="col-4 right-side" id="hact_values.audits_done">
                    Completed
                  </data-table-column>
                  <data-table-column class="col-4 right-side">
                    Outstanding <br> Findings
                  </data-table-column>
                </data-table-column>
              </div>
            </data-table-header>

            <!--Row of Totals-->
            <data-table-row class="totals" no-collapse>
              <div slot="row-data">
                <div class="col-2 sticky-col col-data layout horizontal">
                  <div class="col-12">
                    Total of [[totalResults]] IPs
                  </div>
                </div>
                <div class="col-5 layout horizontal">
                  <div class="col-4 layout horizontal">
                    <div class="col-4 nowrap padded vertical"></div>
                    <div class="col-2 nowrap padded vertical"></div>
                    <div class="col-6 padded right nowrap vertical ">$[[currencyFormat(totals.total_ct_cy)]]</div>
                  </div>
                  <div class="col-8 layout horizontal">
                    <div class="col-3 nowrap padded right-side"></div>
                    <div class="col-3 vertical right-side quarters">
                      <span class="col-3">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">[[totals.planned_visits]]</span>
                    </div>
                    <div class="col-2 nowrap vertical right-side">[[totals.programme_visits]]</div>
                    <div class="col-3 quarters vertical right-side">
                      <span class="col-3">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">[[totals.programmatic_visits]]</span>
                    </div>
                  </div>
                </div>
                <div class="col-5 layout horizontal">
                  <div class="col-9 layout horizontal">
                    <!-- <div class="col-1 buffer right-side right"></div> -->
                    <div class="col-2 right-side right"></div>
                    <div class="col-3 right-side right">
                      <span class="col-3">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">0</span>
                    </div>
                    <div class="col-2 right-side">[[totals.mr_spot_checks]]</div>
                    <div class="col-2 right-side">[[totals.follow_up_flags]]</div>
                    <div class="col-3 right-side">
                      <span class="col-3">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">0</span>
                      <span class="col-3 right-side">[[totals.spot_checks]]</span>
                    </div>
                    <!-- <div class="col-1 buffer right-side right"></div> -->
                  </div>
                  <div class="col-3 layout horizontal">
                    <div class="col-4 right-side">[[totals.audits_mr]]</div>
                    <div class="col-4 right-side">[[totals.audits_done]]</div>
                    <div class="col-4 right-side">X</div>
                  </div>
                </div>
              </div>
            </data-table-row>

            <template is="dom-repeat" items="[[filteredPartners]]" as="partner">
              <data-table-row no-collapse>
                <div slot="row-data">
                  <div class="col-2 sticky-col col-data padded fixed">
                    <span class="col-12 partner-link">
                      <a on-tap="_goToPage" id="[[partner.id]]">
                        [[partner.name]]
                        <paper-tooltip>[[partner.name]]</paper-tooltip>
                      </a>
                    </span>
                  </div>
                    <div class="col-5 layout horizontal">
                    <div class="col-4 layout horizontal">
                      <span class="col-4 nowrap padded">[[partner.rating]]</span>
                      <span class="col-2 nowrap padded">X</span>
                      <span class="col-6 right padded nowrap">$[[currencyFormat(partner.total_ct_cy)]]</span>
                    </div>
                    <div class="col-8 layout horizontalr">
                      <span class="col-3 nowrap padded right-side">X</span>
                      <span class="col-3 nowrapr vertical right-side">
                        <span class="col-3">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">[[_getGovernmentDisplay(partner,'hact_values.planned_visits')]]</span>
                      </span>
                      <span class="col-2 nowrap right-side">[[partner.hact_min_requirements.programme_visits]]</span>
                      <span class="col-3 right-side">
                        <span class="col-3">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">[[partner.hact_values.programmatic_visits]]</span>
                      </span>
                    </div>
                  </div>
                  <div class="col-5 layout horizontal">
                    <div class="col-9 layout horizontal"> 
                      <span class="col-2 right-side">X</span>
                      <span class="col-3 right-side">
                        <span class="col-3">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">0</span>
                      </span>
                      <span class="col-2 right-side">[[partner.hact_min_requirements.spot_checks]]</span>
                      <span class="col-2 right-side">X</span>
                      <span class="col-3 right-side">
                        <span class="col-3">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">0</span>
                        <span class="col-3 right-side">[[partner.hact_values.spot_checks]]</span>
                      </span>
                    </div>
                    <div class="col-3 layout horizontal">
                      <span class="col-4 right-side">[[partner.hact_values.audits_mr]]</span>
                      <span class="col-4 right-side">[[partner.hact_values.audits_done]]</span>
                      <span class="col-4 right-side">X</span>
                    </div>
                  </div>
                </div>
              </data-table-row>
            </template>
      </div>
      <data-table-footer class="fix" page-size="[[pageSize]]" page-number="[[pageNumber]]" visible-range="{{visibleRange}}" filtered-total-results="[[filteredTotalResults]]"
        on-page-size-changed="pageSizeChanged" on-page-number-changed="pageNumberChanged">
      </data-table-footer>
    </paper-material>
  </template>

  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'dashboard-hact-detail',
        behaviors: [
          dashBehaviors.CommonGeneralBehavior,
          dashBehaviors.PaginationBehavior,
          etoolsAppConfig.globals
        ],
        properties: {
          filteredPartners: {
            type: Array,
            notify: true
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false,
          },
          debounceTime: {
            type: Number,
            value: 50
          },
          urlParams: {
            type: Object,
          },
          totals: {
            type: Array,
          },
          displayDetail: {
            type: Boolean,
          },
        },

        // observers: [
        //   '_updateUrl(queryString, pageNumber, pageSize,' +
        //   'sortOrder, requiredDataLoaded, initComplete)'
        // ],

        // _filterPartnersData: function () {
        //   this.debounce('query', function () {
        //     this.$.partners.query(
        //       this.queryString,
        //       this.sortOrder,
        //       this.pageSize,
        //       this.pageNumber);
        //   }, 50);
        // },

        // _updateUrl: function () {
        //   if (!this.initComplete) {
        //     return;
        //   }
        //   this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
        //   const qs = this.buildQueryString();
        //   if (qs !== null) {
        //     this.updateAppState('dashboard/hact', qs, true);
        //     if (this.requiredDataLoaded) {
        //       this._filterPartnersData();
        //     }
        //   } else {
        //     if (location.search === '') {
        //       this.updateAppState('dashboard/hact', qs, false);
        //     }
        //     if (this.forceDataRefresh && this.requiredDataLoaded) {
        //       this._filterPartnersData();
        //       this.set('forceDataRefresh', false);
        //     }
        //   }
        // },

        _buildCsvDownloadUrl: function () {
          return this.queryString ?
            this.getEndpoint('partners').url + '?' + 'search=' + this.queryString + '&format=csv' :
            this.getEndpoint('partners').url + '?' + '&format=csv';
        },

        // _getProp: function (obj, propStr) {
        //   if (propStr === 'partner_type') {
        //     return this._getAbbr(_.get(obj, propStr));
        //   }
        //   return _.get(obj, propStr);
        // },

        // _getAbbr: function (str) {
        //   return str.length > 12 ?
        //     str
        //       .split(' ')
        //       .map(function (word) {
        //         return word[0].toUpperCase();
        //       }).join('') : str;
        // },

        _getGovernmentDisplay: function (partner, prop, toCurrency) {
          const partnerValue = _.get(partner, prop);
          if (partner.partner_type === 'Government') {
            return '-';
          } else {
            return toCurrency ? this.currencyFormat(partnerValue) : partnerValue;
          }
        },

        // _requiredDataHasBeenLoaded: function (e) {
        //   e.stopImmediatePropagation();
        //   let filtered = _.get(this, 'filteredPartners', []);
        //   if (_.isEmpty(filtered)) {
        //     this.set('forceDataRefresh', true);
        //   }
        //   this.set('requiredDataLoaded', true);
        //   this.init(this.active);
        // },

        // _goToPage: function (e) {
        //   window.location.href = this.baseSite + '/pmp/partners/' + e.target.id + '/details';
        // },
      });
    })();

  </script>
</dom-module>