<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-row.html">
<link rel="import" href="../data-table/data-table-footer.html">

<link rel="import" href="../../app-behaviors/list-filters-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-with-filters-behavior.html">

<link rel="import" href="../../app-elements/static-common-data/redux-bahaviors/common-static-data-redux-bahavior.html">


<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">

<link rel="import" href="dashboard-data/attachments-data.html">

<dom-module id="dashboard-attachments-lib">
  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex-factors">
      .wrap-controls paper-input {
        min-width: 280px;
      }

      .custom-width {
        width: 176px;
      }
    </style>
    <attachments-data
        id="attachments"
        active="[[active]]"
        filtered-total="{{filteredTotal}}"
        filtered-attachments="{{filteredAttachments}}"
        fire-data-loaded
        on-attachments-loaded="_attachmentsLoaded"
    ></attachments-data>

    <paper-material class="list-panel listControls" elevation="1">
      <div class="wrap-controls">
        <paper-input type="search" autocomplete="off" value="{{qs}}"
                     placeholder="Search by Partner or PD/SSFA"
                     always-float-label>
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">
          <!-- dropdown filters  -->
          <template is="dom-if" if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">
              <etools-multi-selection-menu
                  label="[[filter.filterName]]"
                  placeholder="&#8212;"
                  disabled$="[[!filter.selectionOptions.length]"
                  options="[[filter.selectionOptions]]"
                  option-value="[[filter.optionValue]]"
                  option-label="[[filter.optionLabel]]"
                  selected-values="[[filter.alreadySelected]]"
                  trigger-value-change-event
                  on-etools-selected-items-changed="esmmValueChanged"
                  data-filter-path$="[[filter.path]]">
              </etools-multi-selection-menu>
              <paper-icon-button
                  suffix class="remove-field remove" icon="cancel"
                  on-tap="removeFilter"
                  data-filter-name$="[[filter.filterName]]"
                  data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>
          <!-- date pickers -->
          <template is="dom-if" if="[[filterTypeIs('datepicker', filter.type)]]">
            <div class="filter">
              <paper-input
                  id$="datepicker_parent_[[filter.path]]"
                  label="[[filter.filterName]]"
                  value="[[prettyDate(filter.dateSelected)]]"
                  on-down="openDatePicker"
                  data-selector$="datepicker_[[filter.path]]">
                <etools-datepicker-button
                    prefix
                    id$="datepicker_[[filter.path]]"
                    date="[[prepareDate(filter.dateSelected)]]"
                    format="D MMM YYYY"
                    parent-id$="datepicker_parent_[[filter.path]]"
                    data-filter-path$="[[filter.path]]"
                    on-date-has-changed="_notifyDateChanged"
                    no-init show-clear-btn fire-date-has-changed>
                </etools-datepicker-button>
              </paper-input>
              <paper-icon-button
                  suffix class="remove-field remove" icon="cancel"
                  on-tap="removeFilter"
                  data-filter-name$="[[filter.filterName]]"
                  data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>
        </template>
      </div>
      <div class="fixed-controls">
        <div class="filters-divider"></div>
        <paper-menu-button id="filterMenu" dynamic-align>
          <paper-button class="button dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            add filter
          </paper-button>
          <paper-menu class="dropdown-content">
            <template is="dom-repeat" items="[[availableListFilterOptions]]">
              <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
            </template>
          </paper-menu>
        </paper-menu-button>
      </div>
    </paper-material>

    <paper-material id="list" elevation="1">
      <data-table-header no-collapse>
        <data-table-column class="col-2 col">
          Partner
        </data-table-column>
        <data-table-column class="col-1 col">
          Vendor #
        </data-table-column>
        <data-table-column class="custom-width col">
          Partner Type
        </data-table-column>
        <data-table-column class="custom-width col" sortable field="source">
          Source
        </data-table-column>
        <data-table-column class="custom-width col" sortable field="file_type">
          Document Type
        </data-table-column>
        <data-table-column class="col-3 col">
          File Download
        </data-table-column>
        <data-table-column class="col-1 col" sortable field="created">
          Date Uploaded
        </data-table-column>
      </data-table-header>

      <template is="dom-repeat" items="[[filteredAttachments]]">
        <data-table-row no-collapse>
          <div slot="row-data">
            <div class="col col-2">
              <span class="col-data">[[item.partner]]</span>
            </div>
            <div class="col col-1">
              <span class="col-data">[[item.vendor_number]]</span>
            </div>
            <div class="col custom-width">
              <span class="col-data">[[item.partner_type]]</span>
            </div>
            <div class="col custom-width">
              <span class="col-data">Partnership Management</span>
            </div>
            <div class="col custom-width">
              <span class="col-data">[[item.file_type]]</span>
            </div>
            <div class="col-3 col">
              <a class="col-data">[[item.filename]]</a>
            </div>
            <div class="col-1 col">
              <span class="col-data">[[item.created]]</span>
            </div>
          </div>
        </data-table-row>
      </template>
      <data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="pageSizeChanged"
          filtered-total-results="[[filteredTotal]]"
          on-page-number-changed="pageNumberChanged">
      </data-table-footer>
    </paper-material>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'dashboard-attachments-lib',
        behaviors: [
          dashBehaviors.ListFiltersBehavior,
          dashBehaviors.DateBehavior,
          dashBehaviors.DropdownBehavior,
          dashBehaviors.EtoolsStaticCommonDataReduxBehavior,
          dashBehaviors.PaginationWithFiltersBehavior,
          dashBehaviors.CommonGeneralBehavior,
        ],
        observers: [
          '_updateUrl(qs, pageNumber, pageSize, initComplete, sortOrder, selectedUnicefUsers,' +
          'uploadedAfterDate, uploadedBeforeDate, requiredDataLoaded)',
          '_initListFilters(unicefUsers)',
          '_init(active, attachmentTypes)',
        ],
        listeners: {
          'sort-changed': '_handleSortChange',
        },
        properties: {
          filteredAttachments: {
            type: Array,
            value: []
          },
          filteredTotal: {
            type: Number,
          },
          qs: {
            type: String
          },
          attachmentTypes: {
            type: Array,
            statePath: 'static.attachment_types'
          },
          selectedAttachmentTypes: {
            type: Array,
            observer: 'filterChanged'
          },
          uploadedAfterDate: {
            type: String,
            observer: 'dateChanged'
          },
          uploadedBeforeDate: {
            type: String,
            observer: 'dateChanged'
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          params: {
            type: Array,
            value: function() {
              return [
                {
                  qName: 'qs',
                  propName: 'qs',
                  xf: _.identity
                },
                {
                  qName: 'sort',
                  propName: 'sortOrder',
                  xf: _.identity
                },
                {
                  qName: 'sortBy',
                  propName: 'sortBy',
                  xf: _.identity
                },
                {
                  qName: 'type',
                  propName: 'docType',
                  xf: _.identity
                },
              ]
            }
          }
        },
        //unicefUsers required to ensure redux statePaths are loaded
        _init: function(active, attachmentTypes) {
          let params = this.urlParams;
          if (!active || !params || !_.isEmpty(this.filteredAttachments)) {
            return;
          }
          this.set('initComplete', false);
          this.set('qs', params.qs || '');
          this.set('pageNumber', params.page ? parseInt(params.page) : 1);
          this.set('pageSize', params.size ? parseInt(params.size) : 10);
          this.set('sortOrder', params.sort || 'desc');
          this.set('sortBy', params.sortBy || '');
          this.set('selectedAttachmentTypes', params.docType ? this._setSelectedFromCollection(params.docType, this.attachmentTypes) : []);
          this.set('initComplete', true);
          this._updateSelectedFiltersValues();
        },

        _attachmentsLoaded: function(e) {
          e.stopImmediatePropagation();
          this.set('requiredDataLoaded', true);
        },

        _initListFilters: function(unicefUsers) {
          this.debounce('init-list-filters', () => {
            this.initListFiltersData([
              {
                filterName: 'Uploaded By',
                type: 'esmm',
                optionValue: 'value',
                optionLabel: 'label',
                selectionOptions: this.unicefUsers,
                alreadySelected: [],
                path: 'selectedUnicefUsers'
              },
              {
                filterName: 'Uploaded Before',
                type: 'datepicker', // etools-datepicker
                path: 'uploadBeforeDate',
                dateSelected: ''
              },
              {
                filterName: 'Uploaded After',
                type: 'datepicker', // etools-datepicker
                path: 'uploadedAfterDate',
                dateSelected: ''
              },
              {
                filterName: 'Document Type',
                type: 'esmm', // etools-datepicker
                path: 'uploadedAfterDate',
                dateSelected: ''
              },
            ]);
          }, 100)
        },

        _updateSelectedFiltersValues: function() {
          this.debounce('updateShownFilters', () => {
            let filtersValues = [
              {
                filterName: 'Uploaded By',
                selectedValue: _.map(this.selectedUnicefUsers, 'value')
              },
              {
                filterName: 'Uploaded Before',
                selectedValue: this.uploadedBeforeDate
              },
              {
                filterName: 'Uploaded After',
                selectedValue: this.uploadedAfterDate
              },
              {
                filterName: 'Document Type',
                selectedValue: this.selectedAttachmentTypes
              }
            ]
          }, 200)
        },

        _filterDocuments: function() {
          const selectedParams = {
            searchString: this.qs,
            attachmentType: _.map(this.selectedAttachmentTypes, 'value'),
            uploadedBy: _.map(this.selectedUnicefUsers, 'value'),
            uploadedBefore: this.uploadedBeforeDate,
            uploadedAfter: this.uploadedAfterDate
          };
          const query = _.assign({}, _.omitBy(selectedParams, _.isEmpty), {
            pageNumber: this.pageNumber,
            pageSize: this.pageSize,
            order: this.sortOrder
          });
          this.$.attachments.query(query);
        },

        _updateUrl: function() {
          if (!this.initComplete || !this.requiredDataLoaded) {
            return;
          }
          const qs = this.buildQueryString();
          this.updateAppState('dashboard/attachments', qs, true);
          if (this.requiredDataLoaded) {
            this._filterDocuments();
          }

        },

        _setSelectedFromCollection: function(param, collection) {
          const itemsFromParam = param.split('|');
          if (!isEmpty(itemsFromParam)) {
            return collection.filter(u => itemsFromParam.indexOf(u.value) > -1)
          }
          return [];
        },

        _handleSortChange: function({detail: {field, direction}}) {

        }

      });
    })();
  </script>
</dom-module>
