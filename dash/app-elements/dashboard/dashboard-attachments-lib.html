<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<link rel="import" href="../../app-behaviors/list-filters-behavior.html">
<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/date-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-with-filters-behavior.html">

<link rel="import" href="../../app-elements/static-common-data/redux-bahaviors/common-static-data-redux-bahavior.html">


<link rel="import"
      href="../../../bower_components/etools-searchable-multiselection-menu/etools-multi-selection-menu.html">
<link rel="import" href="../../../bower_components/etools-datepicker/etools-datepicker-button.html">

<link rel="import" href="dashboard-data/attachments-data.html">

<dom-module id="dashboard-attachments-lib">
  <template>
    <style include="shared-styles list-styles grid-layout-styles">
      .wrap-controls paper-input {
        min-width: 280px;
      }
    </style>
    <attachments-data
        id="attachments"
        filtered-total="{{filteredTotal}}"
        filtered-attachments="{{filteredAttachments}}"
        fire-data-loaded
        on-attachments-loaded="_attachmentsLoaded"
    ></attachments-data>

    <paper-material class="list-panel listControls" elevation="1">
      <div class="wrap-controls">
        <paper-input type="search" autocomplete="off" value="{{qs}}"
                     placeholder="Search by Partner or PD/SSFA"
                     always-float-label>
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
        <template is="dom-repeat" items="[[selectedFilters]]" as="filter">
          <!-- dropdown filters  -->
          <template is="dom-if" if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">
              <etools-multi-selection-menu
                  label="[[filter.filterName]]"
                  placeholder="&#8212;"
                  disabled$="[[!filter.selectionOptions.length]"
                  options="[[filter.selectionOptions]]"
                  option-value="[[filter.optionValue]]"
                  option-label="[[filter.optionLabel]]"
                  selected-values="[[filter.alreadySelected]]"
                  trigger-value-change-event
                  on-etools-selected-items-changed="esmmValueChanged"
                  data-filter-path$="[[filter.path]]">
              </etools-multi-selection-menu>
              <paper-icon-button
                  suffix class="remove-field remove" icon="cancel"
                  on-tap="removeFilter"
                  data-filter-name$="[[filter.filterName]]"
                  data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>
          <!-- date pickers -->
          <template is="dom-if" if="[[filterTypeIs('datepicker', filter.type)]]">
            <div class="filter">
              <paper-input
                  id$="datepicker_parent_[[filter.path]]"
                  label="[[filter.filterName]]"
                  value="[[prettyDate(filter.dateSelected)]]"
                  on-down="openDatePicker"
                  data-selector$="datepicker_[[filter.path]]">
                <etools-datepicker-button
                    prefix
                    id$="datepicker_[[filter.path]]"
                    date="[[prepareDate(filter.dateSelected)]]"
                    format="D MMM YYYY"
                    parent-id$="datepicker_parent_[[filter.path]]"
                    data-filter-path$="[[filter.path]]"
                    on-date-has-changed="_notifyDateChanged"
                    no-init show-clear-btn fire-date-has-changed>
                </etools-datepicker-button>
              </paper-input>
              <paper-icon-button
                  suffix class="remove-field remove" icon="cancel"
                  on-tap="removeFilter"
                  data-filter-name$="[[filter.filterName]]"
                  data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>
        </template>
      </div>
      <div class="fixed-controls">
        <div class="filters-divider"></div>
        <paper-menu-button id="filterMenu" dynamic-align>
          <paper-button class="button dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            add filter
          </paper-button>
          <paper-menu class="dropdown-content">
            <template is="dom-repeat" items="[[availableListFilterOptions]]">
              <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
            </template>
          </paper-menu>
        </paper-menu-button>
      </div>
    </paper-material>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'dashboard-attachments-lib',
        behaviors: [
          dashBehaviors.ListFiltersBehavior,
          dashBehaviors.DateBehavior,
          dashBehaviors.DropdownBehavior,
          dashBehaviors.EtoolsStaticCommonDataReduxBehavior,
          dashBehaviors.PaginationWithFiltersBehavior,
          dashBehaviors.CommonGeneralBehavior,
        ],
        observers: [
          '_updateUrl(qs, pageNumber, pageSize, initComplete, sortOrder, selectedUnicefUsers,' +
          'uploadedAfterDate, uploadedBeforeDate, requiredDataLoaded)',
          '_initListFilters(unicefUsers)',
          '_init(active, unicefUsers)',
        ],
        properties: {
          filteredAttachments: {
            type: Array,
            value: []
          },
          filteredTotal: {
            type: Number,
          },
          qs: {
            type: String
          },
//          docTypes: {
//            type: Array,
//            statePath: 'static.fileTypes'
//          },
          selectedDocTypes: {
            type: Array,
            observer: 'filterChanged'
          },
          unicefUsers: {
            type: Array,
            statePath: 'unicefUsersData'
          },
          selectedUnicefUsers: {
            type: Array,
            observer: 'filterChanged'
          },
          uploadedAfterDate: {
            type: String,
            observer: 'dateChanged'
          },
          uploadedBeforeDate: {
            type: String,
            observer: 'dateChanged'
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          params: {
            type: Array,
            value: function() {
              return [
                {
                  qName: 'qs',
                  propName: 'qs',
                  xf: xs => xs
                },
                {
                  qname: 'sort',
                  propName: 'sortOrder',
                  xf: xs => xs
                },
                {
                  qname: 'uploadedAfter',
                  propName: 'uploadedAfterDate',
                  xf: xs => this.prettyDate(xs, 'YYYY-MM-DD')
                },
                {
                  qname: 'uploadedBefore',
                  propName: 'uploadedBeforeDate',
                  xf: xs => this.prettyDate(xs, 'YYYY-MM-DD')
                },
                {
                  qname: 'uploadedBy',
                  propName: 'selectedUnicefUsers',
                  xf: xs => _.map(xs, 'value').join('|')
                }
              ]
            }
          }
        },

        _init: function(active, unicefUsers /*,fileTypes*/) {
          let params = this.urlParams;
          if (!active || !params) {
            return;
          }
          this.set('initComplete', false);
          this.set('qs', params.qs || '');
          this.set('pageNumber', params.page ? parseInt(params.page) : 1);
          this.set('pageSize', params.size ? parseInt(params.size) : 10);
          this.set('sortOrder', params.sort || 'desc');
          this.set('selectedUnicefUsers', params.uploadedBy ? this._setSelectedFromCollection(params.uploadedBy, this.unicefUsers) : []);
          this.set('uploadedAfterDate', params.uploadedAfter || '');
          this.set('uploadedBeforeDate', params.uploadedBefore || '');
//          this.set('selectedDocTypes', params.docType ? this._setSelectedFromCollection(params.docType, this.docTypes) : []);
          this.set('initComplete', true);
          this._updateSelectedFiltersValues();
        },

        _attachmentsLoaded: function(e) {
          e.stopImmediatePropagation();
          this.set('requiredDataLoaded', true);
        },

        _initListFilters: function(unicefUsers) {
          this.debounce('init-list-filters', () => {
            this.initListFiltersData([
              {
                filterName: 'Uploaded By',
                type: 'esmm',
                optionValue: 'value',
                optionLabel: 'label',
                selectionOptions: this.unicefUsers,
                alreadySelected: [],
                path: 'selectedUnicefUsers'
              },
              {
                filterName: 'Uploaded Before',
                type: 'datepicker', // etools-datepicker
                path: 'uploadBeforeDate',
                dateSelected: ''
              },
              {
                filterName: 'Uploaded After',
                type: 'datepicker', // etools-datepicker
                path: 'uploadedAfterDate',
                dateSelected: ''
              },
              {
                filterName: 'Document Type',
                type: 'esmm', // etools-datepicker
                path: 'uploadedAfterDate',
                dateSelected: ''
              },
            ]);
          },100)
        },

        _updateSelectedFiltersValues: function() {
          this.debounce('updateShownFilters', () => {
            let filtersValues = [
              {
                filterName: 'Uploaded By',
                selectedValue: _.map(this.selectedUnicefUsers, 'value')
              },
              {
                filterName: 'Uploaded Before',
                selectedValue: this.uploadedBeforeDate
              },
              {
                filterName: 'Uploaded After',
                selectedValue: this.uploadedAfterDate
              },
              {
                filterName: 'Document Type',
                selectedValue: this.selectedDocTypes
              }
            ]
          },200)
        },

        _filterDocuments: function() {
          this.$.attachments.query({
            searchString: this.qs,
            documentType: _.map(this.selectedDocTypes, 'value'),
            uploadedBy: _.map(this.selectedUnicefUsers, 'value'),
            uploadedBefore: this.uploadedBeforeDate,
            uploadedAfter: this.uploadedAfterDate
          })
        },

        _updateUrl: function() {
          if (!this.initComplete || !this.requiredDataLoaded) {
            return;
          }
          const qs = this.buildQueryString();
          if (!_.isEmpty(qs)) {
            this.updateAppState('dashboard/attachments', qs, true);
            if (this.requiredDataLoaded) {
              this._filterDocuments();
            }
          } else {
            if (location.search === '') {
              this.updateAppState('dashboard/attachments', qs, false);
            }
          }
        },

        _setSelectedFromCollection: function(param, collection) {
          const itemsFromParam = param.split('|');
          if (!isEmpty(itemsFromParam)) {
            return collection.filter(u => itemsFromParam.indexOf(u.value) > -1)
          }
          return [];
        },

      });
    })();
  </script>
</dom-module>
