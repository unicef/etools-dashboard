<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/etools-dropdown/etools-dropdown.html">
<link rel="import" href="../../../bower_components/etools-dialog/etools-dialog.html">
<link rel="import" href="../../../bower_components/etools-dialog/dynamic-dialog-behavior.html">
<link rel="import" href="../../app-config/etools-app-config.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="dashboard-hact-views/dashboard-hact-detail.html">
<link rel="import" href="dashboard-hact-views/dashboard-hact-charts.html">
<link rel="import" href="dashboard-hact-views/dashboard-hact-general.html">

<link rel="import" href="dashboard-data/partners-data.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-behavior.html">

<dom-module id="dashboard-hact">
  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        --paper-input-container-label: {
          margin-left: 34px;
        };
        --paper-tooltip-opacity: 1;
        width: 100%;
      }

      #query {
        padding-bottom: 8px;
      }

      .hact-list {
        min-width: 1150px;
      }

      .detail-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 36px;
      }

      paper-material.detail-btn {
        padding-top: 0;
        padding-bottom: 0;
      }

      .search-bar {
        padding-bottom: 8px;
        padding-top: 8px;
        box-sizing: border-box;
      }

      .toggle {
        font-size: 12px;
        cursor: pointer;
        font-weight: 500;
        top: 10px;
        z-index: 1;
      }

      .view-toggle {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-bottom: 12px;
      }

      paper-button.curved-left {
        border-radius: 50px 0 0 50px;
        background: rgb(216, 216, 216);
        margin-right: 0;
        padding-right: 1em;
        cursor: pointer;
        padding-bottom: 8px;
      }

      paper-button.curved-right {
        border-radius: 0 50px 50px 0;
        background: rgb(255, 255, 255);
        margin-left: 0;
        padding-left: 1em;
        cursor: pointer;
        padding-bottom: 8px;
      }

      .dark-button {
        background: rgb(216, 216, 216) !important;
      }

      .light-button {
        background: rgb(255, 255, 255) !important;
      }

      .sources-button {
        --iron-icon-fill-color: rgb(26, 155, 252);
      }

      paper-button.detailed-assurance {
        border-radius: 50px;
        background: rgb(255, 255, 255);
        cursor: pointer;
      }

      #sources-btn {
        margin-right: auto;
      }
    </style>
    <app-route
        route="{{route}}"
        pattern="dashboard/hact/:hactTab"
        data="{{routeData}}"
        active="{{activeTab}}"
        query-params="{{queryParams}}"></app-route>

    <partners-data id="partners" filtered-partners="{{filteredPartners}}" total-results="{{totalResults}}"
                   totals="{{totals}}"
                   filtered-total-results="{{filteredTotalResults}}" active="[[active]]" fire-data-loaded show-loading
                   on-partners-loaded="_requiredDataHasBeenLoaded">
    </partners-data>
    <div class="view-toggle">
      <paper-button id="assurancePlan" on-tap="_toggleChartsView" name="assurance" noink class="curved-left">
        <iron-icon class="dark" name="assurance" icon="list"></iron-icon>
        ASSURANCE PLAN
      </paper-button>
      <paper-button id="dashboardCharts" on-tap="_toggleChartsView"  name="charts" noink
                    class="curved-right">
        <iron-icon class="dark" name="charts" icon="assessment"></iron-icon>
        DASHBOARD
      </paper-button>
    </div>
    <iron-pages id="hactPages"
                selected="{{routeData.hactTab}}"
                attr-for-selected="name"
                fallback-selection="assurance">
      <div name="assurance">
        <paper-material class="list-panel search-bar hact-list" elevation="1">
          <div class="wrap-controls">
            <paper-input id="query" type="search" autocomplete="off" value="[[queryString]]" on-keyup="setQuery"
                         placeholder="Type and search"
                         label="Keywords" always-float-label on-search="setQuery">
              <iron-icon icon="search" prefix></iron-icon>
            </paper-input>
          </div>
        </paper-material>

        <paper-material class="hact-list detail-btn" elevation="1">
            <paper-button on-tap="_detailToggle" class="toggle" noink>
              <a class="detailed-assurance">SHOW DETAILED ASSURANCE</a>
            </paper-button>
        </paper-material>

        <iron-pages id="assurance"
                    selected="[[subName]]"
                    attr-for-selected="sub-name"
                    fallback-selection="hact-general">
          <div sub-name="hact-general">
            <dashboard-hact-general
                filtered-partners="[[filteredPartners]]"
                totals="[[totals]]"
                total-results="[[totalResults]]"
                filtered-total-results="[[filteredTotalResults]]">
            </dashboard-hact-general>
          </div>
          <div sub-name="hact-detail">
            <dashboard-hact-detail
                filtered-partners="[[filteredPartners]]"
                totals="[[totals]]"
                total-results="[[totalResults]]"
                filtered-total-results="[[filteredTotalResults]]">
            </dashboard-hact-detail>
          </div>
          <paper-material>
        </iron-pages>
        <data-table-footer page-size="[[pageSize]]" page-number="[[pageNumber]]" visible-range="{{visibleRange}}"
                           filtered-total-results="[[filteredTotalResults]]"
                           on-page-size-changed="pageSizeChanged" on-page-number-changed="pageNumberChanged">
        </data-table-footer>
        </paper-material>
      </div>
      <div name="charts">
        <dashboard-hact-charts active="[[_isActive(hactPage,'charts')]]"></dashboard-hact-charts>
      </div>
    </iron-pages>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'dashboard-hact',
        behaviors: [
          dashBehaviors.CommonGeneralBehavior,
          dashBehaviors.PaginationBehavior,
          etoolsAppConfig.globals
        ],
        properties: {
          filteredPartners: {
            type: Array,
            notify: true
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false,
          },
          debounceTime: {
            type: Number,
            value: 50
          },
          urlParams: {
            type: Object,
          },
          totals: {
            type: Array,
          },
          displayDetail: {
            type: Boolean,
            value: false
          },
          showDash: {
            type: Boolean,
            value: false
          },
          hactPage: {
            type: String,
            notify: true
          },
          graphsActive: {
            type: Boolean,
            value: false,
          },
          routeData: {
            type: Object,
            notify: true
          },
        },

        observers: [
          '_updateUrl(queryString, pageNumber, pageSize,' +
          'sortOrder, requiredDataLoaded, initComplete)',
          '_tabChanged(routeData.hactTab)',
        ],

        _tabChanged: function(hactTab) {
          this.set('hactPage', hactTab);
          if (this.hactPage === 'charts') {
            this.$.assurancePlan.classList.add('light-button');
            this.$.dashboardCharts.classList.add('dark-button');
          } else {
            this.$.assurancePlan.classList.remove('light-button');
            this.$.dashboardCharts.classList.remove('dark-button');
          }
        },

        _filterPartnersData: function() {
          this.debounce('query', function() {
            this.$.partners.query(
              this.queryString,
              this.sortOrder,
              this.pageSize,
              this.pageNumber);
          }, 50);
        },

        _updateUrl: function() {
          if (!this.initComplete || !this.route) {
            return;
          }
           this.set('route.path', 'dashboard/hact/' + this.routeData.hactTab);
          this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
          const qs = this.buildQueryString();
          if (qs !== null) {
            this.updateAppState(this.route.path, qs, true);
            if (this.requiredDataLoaded) {
              this._filterPartnersData();
            }
          } else {
            if (location.search === '') {
              this.updateAppState(this.route.path, qs, false);
            }
            if (this.forceDataRefresh && this.requiredDataLoaded) {
              this._filterPartnersData();
              this.set('forceDataRefresh', false);
            }
          }
        },

        _buildCsvDownloadUrl: function() {
          return this.queryString
            ? this.getEndpoint('partners').url + '?' + 'search=' + this.queryString + '&format=csv'
            : this.getEndpoint('partners').url + '?' + '&format=csv';
        },

        _getProp: function(obj, propStr) {
          if (propStr === 'partner_type') {
            return this._getAbbr(_.get(obj, propStr));
          }
          return _.get(obj, propStr);
        },

        _getAbbr: function(str) {
          return str.length > 12
            ? str
              .split(' ')
              .map(function(word) {
                return word[0].toUpperCase();
              }).join('') : str;
        },

        _getGovernmentDisplay: function(partner, prop, toCurrency) {
          const partnerValue = _.get(partner, prop);
          if (partner.partner_type === 'Government') {
            return '-';
          } else {
            return toCurrency ? this.currencyFormat(partnerValue) : partnerValue;
          }
        },

        _requiredDataHasBeenLoaded: function(e) {
          e.stopImmediatePropagation();
          let filtered = _.get(this, 'filteredPartners', []);
          if (_.isEmpty(filtered)) {
            this.set('forceDataRefresh', true);
          }
          this.set('requiredDataLoaded', true);
          this.init(this.active);
        },

        _toggleChartsView: function({target}) {
          const name = target.getAttribute('name');
          let pages = Polymer.dom(this.root).querySelectorAll('iron-pages');
          if (name != this.hactPage) {
            pages[0].selectNext();
          }
        },

        _detailToggle: function() {
          let pages = Polymer.dom(this.root).querySelectorAll('iron-pages');
          pages[1].selectNext();
          let button = Polymer.dom(this.root).querySelector('.detailed-assurance');
          button.innerText = !this.displayDetail ? 'HIDE DETAILED ASSURANCE' : 'SHOW DETAILED ASSURANCE';
          this.displayDetail = !this.displayDetail;
        },
        _isActive: (current, target) => (current === target),

      });
    })();

  </script>
</dom-module>
