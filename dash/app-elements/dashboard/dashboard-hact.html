<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">

<link rel="import" href="dashboard-data/partners-data.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">




<dom-module id="dashboard-hact">
  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        --paper-input-container-label: {
          margin-left: 34px;
        };
        --paper-tooltip-opacity: 1;
        width: 100%;
      }

      #query {
        padding-bottom: 8px;
      }

      .search-bar {
        padding-bottom: 7px;
        padding-top: 7px;
      }

      .nowrap {
        white-space: nowrap;
      }

      data-table-header data-table-column {
        @apply(--layout-start);
      }

      data-table-row > div > *:not(:last-child) {
        padding-right: 12px;
      }

      data-table-column:not(:last-child) {
        padding-right: 12px;
      }

      .partner-link {
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 0 0 12%;
      }
    </style>
    <partners-data
        id="partners"
        filtered-partners="{{filteredPartners}}"
        total-results="{{totalResults}}"
        fire-data-loaded show-loading
        on-partners-loaded="_requiredDataHasBeenLoaded">
    </partners-data>
    <paper-material class="list-panel search-bar" elevation="1">
      <div class="wrap-controls">
        <paper-input id="query"
                     type="search"
                     autocomplete="off"
                     value="[[queryString]]"
                     on-keyup="_setQuery"
                     placeholder="Type and search"
                     label="Keywords"
                     always-float-label
                     on-search="_setQuery">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
      </div>
    </paper-material>
    <paper-material id="list" elevation="1">
      <data-table-header label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show" no-collapse>
        <data-table-column class="flex nowrap" field="name" sortable>
          Implementing Partner
        </data-table-column>
        <data-table-column class="flex nowrap" field="partner_type">
          Partner Type
        </data-table-column>
        <data-table-column class="flex nowrap" field="shared_partner">
          Shared IP
        </data-table-column>
        <data-table-column class="flex-3" group-heading="CASH TRANSFERS in USD">
          <data-table-column class="nowrap" field="total_ct_cp">
            TOTAL for <br> current CP cycle
          </data-table-column>
          <data-table-column class="nowrap" field="hact_values.planned_cash_transfer">
            PLANNED for <br> current year
          </data-table-column>
          <data-table-column class="nowrap" field="total_ct_cy">
            ACTUAL for <br> current year
          </data-table-column>
        </data-table-column>
        <data-table-column class="flex nowrap" field="hact_values.micro_assessment_needed">
          Micro <br>Assessment
        </data-table-column>
        <data-table-column class="flex nowrap" field="rating">
          Risk Rating
        </data-table-column>
        <data-table-column class="flex-3" group-heading="PROGRAMMATIC VISITS">
          <data-table-column class="flex nowrap" field="hact_values.planned_visits">
            Planned
          </data-table-column>
          <data-table-column class="flex nowrap" field="hact_min_requirements.programmatic">
            M.R
          </data-table-column>
          <data-table-column class="flex nowrap" field="hact_values.programmatic_visits">
            Done
          </data-table-column>
        </data-table-column>
        <data-table-column class="flex-2" group-heading="SPOT CHECKS">
          <data-table-column field="hact_min_requirements.spot_checks">
            M.R
          </data-table-column>
          <data-table-column field="hact_values.spot_checks">
            Done
          </data-table-column>
        </data-table-column>
        <data-table-column class="flex-2" group-heading="AUDITS">
          <data-table-column field="hact_values.audits_mr">
            M.R
          </data-table-column>
          <data-table-column field="hact_values.audits_done">
            Done
          </data-table-column>
        </data-table-column>
        <data-table-column class="flex nowrap" field="hact_values.follow_up_flags">
          Flag for <br> Follow up
        </data-table-column>
      </data-table-header>
      <template is="dom-repeat" items="[[filteredPartners]]" as="partner">
        <data-table-row no-collapse>
          <div slot="row-data">
            <a href="#" class="col-data partner-link">
              [[partner.name]]
              <paper-tooltip position="right">[[partner.name]]</paper-tooltip>
            </a>
            <template is="dom-repeat" items="[[tableFields]]" as="field">
              <span class="col-data flex">[[_getProp(partner, field)]]</span>
            </template>

          </div>
        </data-table-row>
      </template>

    </paper-material>
  </template>
  <script>
    (function() {
      'use strict';
      var _lastListViewed = null;

      Polymer({
        is: "dashboard-hact",
        behaviors: [
            dashBehaviors.CommonGeneralBehavior
        ],

        properties: {
          filteredPartners: {
            type: Array,
            notify: true,
          },
          pageNumber: {
            type: Number
          },
          pageSize: {
            type: Number
          },
          sortOrder: {
            type: String
          },
          queryString: {
            type: String,
            notify: true,
            observer: '_qChanged'
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false
          },
          debounceTime: {
            type: Number,
            value: 50
          },
          urlParams: {
            type: Object
          },

          tableFields: {
            type: Array,
            value: [
              'partner_type',
              'shared_partner',
              'total_ct_cp',
              'hact_values.planned_cash_transfer',
              'total_ct_cy',
              'hact_values.micro_assessment_needed',
              'rating',
              'hact_values.planned_visits',
              'hact_min_requirements.programmatic',
              'hact_values.programmatic_visits',
              'hact_min_requirements.spot_checks',
              'hact_values.spot_checks',
              'hact_values.audits_mr',
              'hact_values.audits_done',
              'hact_values.follow_up_flags'
            ]
          }
        },
        observers: [
          '_init(active)',
          '_updateUrl(queryString, pageNumber, pageSize, sortOrder, requiredDataLoaded)'
        ],
        _init: function (active) {
          var params = this.urlParams;
          if (!active || !params) {
            return
          }
          this.set('initComplete', false);
          this.set('pageNumber', params.page? parseInt(params.page): 1);
          this.set('pageSize', params.size? parseInt(params.size): 10);
          this.set('queryString', params.q? params.q : '');
          this.set('sortOrder', params.sort? params.sort : 'asc');
          this.set('initComplete', true);
        },
        _filterPartnersData: function () {
          this.debounce('query', function () {
            this.$.partners.query(
                this.queryString,
                this.sortOrder,
                this.pageSize,
                this.pageNumber);
          }, 200);
        },
        _updateUrl: function(){
          if (!this.requiredDataLoaded || !this.initComplete) {
            return;
          }
          var qs = this._buildQueryString();
          if (qs !== _lastListViewed){
            _lastListViewed = qs;
            this.updateAppState('dashboard/hact', qs, true);
            if (this.requiredDataLoaded) {
              this._filterPartnersData();
            }
          }else {
            if (location.search === '') {
              this.updateAppState('dashboard/hact', qs, false)
            }
            if (this.forceDataRefresh && this.requiredDataLoaded){
              this._filterPartnersData();
              this.set('forceDataRefresh', false);
            }
          }
        },
        _buildQueryString: function(){
          var qs = [];
          if (this.pageNumber > 1){
            qs.push('page=' + this.pageNumber);
          }
          if (this.pageSize) {
            qs.push('size=' + this.pageSize);
          }
          if (this.queryString) {
            qs.push('q=' + this.queryString);
          }
          if (this.sortOrder){
            qs.push('sort=' + this.sortOrder);
          }
          return qs.join('&');

        },
        _getProp: function (obj, propStr) {
          if (propStr === 'partner_type') {
            return this._getAbbr(_.get(obj, propStr))
          }
          return _.get(obj, propStr)
        },
        _getAbbr: function (str) {
          return _.chain(str)
              .split(' ')
              .map(function (word) {
                return word[0].toUpperCase()
              })
              .join('');
        },
        _setQuery: function () {
          this.set('queryString', this.$.query.value)
        },
        _qChanged: function(q) {
          this.set('debounceTime', 300);
          this.set('pageNumber', 1);
        },
        _requiredDataHasBeenLoaded: function (e) {
          e.stopImmediatePropagation();
          if (_.isUndefined(this.filteredPartners) || (Array.isArray(this.filteredPartners)) && !this.filteredPartners.length) {
            this.set('forceDataRefresh', true);
          }
          this.set('requiredDataLoaded', true);
          this._init(this.active);
          this.fire('global-loading', {active: false});
        }

      })
    })();

  </script>
</dom-module>