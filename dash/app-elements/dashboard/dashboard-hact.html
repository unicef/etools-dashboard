<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/etools-dropdown/etools-dropdown.html">
<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">
<link rel="import" href="../data-table/data-table-footer.html">
<link rel="import" href="dashboard-hact-detail.html">


<link rel="import" href="dashboard-data/partners-data.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-behavior.html">

<dom-module id="dashboard-hact">
  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        --paper-input-container-label: {
          margin-left: 34px;
        };
        --paper-tooltip-opacity: 1;
        width: 100%;
      }

      #query {
        padding-bottom: 8px;
      }

      .hact-list {
        min-width: 1150px;
      }

      /* .detail-list {
        min-width: 1400px;
        padding: 0 0;
      } */

      .buffer {
        background-color: rgb(248, 248, 248);
        border-left: 1px solid rgba(0, 0, 0, 0.24);
      }

      .search-bar {
        padding-bottom: 8px;
        padding-top: 8px;
        box-sizing: border-box;
      }

      .nowrap {
        white-space: nowrap;
      }

      .padded {
        padding-right: 2px;
      }

      .group {
        /* padding-right: 16px; */
        box-sizing: border-box;
      }

      .right {
        text-align: right;
      }

      .center {
        text-align: center;
      }

      .right-side {
        text-align: right;
        border-left: 1px solid rgba(0, 0, 0, 0.24);
        box-sizing: border-box;
        padding-right: 2px;
        min-height: 48px;
      }

      .vertical {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }

      data-table-header data-table-column {
        @apply(--layout-start);
        box-sizing: border-box;
      }

      data-table-row.totals {
        --primary-background-color: var(--medium-theme-background-color);
        --custom-style: {
          background: var(--medium-theme-background-color);
          border-top: 1px solid rgba(0, 0, 0, 0.24);
          box-shadow: inset 0 -1px 0 0 rgba(0, 0, 0, 0.24);
        }
      }

      data-table-column.around {
        --custom-style: {
          @apply(--layout-around-justified);
        }
      }

      data-table-row.totals span {
        font-weight: 500;
      }

      data-table-row:hover {
        background: var(--medium-theme-background-color);
      }

      #center-toggle {
        width: 100%;
        text-align: center;
      }

      #toggle {
        font-size: 12px;
        cursor: pointer;
        font-weight: 500;
      }

      /* .toggle-fields {
        display: none;
        flex-grow: 2;
      } */

      data-table-row > div[slot="row-data"] > div > div {
        display: flex;
        /* flex-flow: row nowrap; */
        align-items: center;
        min-height: 40px;
      }

      data-table-row > div[slot="row-data"] > div:nth-of-type(2) > div > span {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* data-table-header > div > data-table-column > data-table-column {  */
      /* data-table-row > div[slot="row-data"] > div:nth-of-type(2) > div > span { */
        /* text-align: right; */
        /* border-left: 1px solid rgba(0, 0, 0, 0.24); */
        /* box-sizing: border-box; */
        /* display: flex; */
        /* align-items: center; */
        /* flex-direction: row-reverse; */
        /* height: 100%; */
        /* align-items: center; */
        /* justify-content: center; */
      /* } */

      .year-dropdown {
        max-width: 150px;
        padding-left: 20px;
      }

      /* .toggle-container {
        display: flex;
        flex-flow: row nowrap;
        justify-content: space-evenly;
        flex-grow: 1;
      } */

      .year-and-toggles {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      paper-button.curved-left {
        border-radius: 50px 0 0 50px;
        background: rgb(255, 255, 255);
        margin-right: 0;
        padding-right: 1em;
        cursor: pointer;
        padding-bottom: 8px;
      }

      paper-button.curved-right {
        border-radius: 0 50px 50px 0;
        background: rgb(216, 216, 216);
        margin-left: 0;
        padding-left: 1em;
        cursor: pointer;
        padding-bottom: 8px;
      }

      paper-button.detailed-assurance {
        border-radius: 50px;
        background: rgb(255, 255, 255);
        cursor: pointer;
      }

      .partner-link {
        overflow: hidden;
        cursor: pointer;
      }
    </style>

    <partners-data id="partners" filtered-partners="{{filteredPartners}}" total-results="{{totalResults}}" totals="{{totals}}"
      filtered-total-results="{{filteredTotalResults}}" active="[[active]]" fire-data-loaded show-loading on-partners-loaded="_requiredDataHasBeenLoaded">
    </partners-data>
    <div class="year-and-toggles">
      <div class="year-dropdown">
        <etools-dropdown label="Year" options="[[availableYears]]" dropdown-value="2017"></etools-dropdown>
      </div>
      <div>
        <paper-button on-tap="_showPlan" noink class="curved-left">
          <iron-icon class="dark" icon="list"></iron-icon>
          ASSURANCE PLAN
        </paper-button>
        <paper-button on-tap="_showDash" noink class="curved-right">
          <iron-icon class="dark" icon="assessment"></iron-icon>
          DASHBOARD
        </paper-button>
      </div>
    </div>
    <iron-pages selected="0">
      <div>
        <paper-material class="list-panel search-bar hact-list" elevation="1">
          <div class="wrap-controls">
            <paper-input id="query" type="search" autocomplete="off" value="[[queryString]]" on-keyup="setQuery" placeholder="Type and search"
              label="Keywords" always-float-label on-search="setQuery">
              <iron-icon icon="search" prefix></iron-icon>
            </paper-input>
          </div>
        </paper-material>

        <paper-material class="hact-list" elevation="1">
          <div id="center-toggle">
              <paper-button on-tap="_detailToggle" id="toggle" class="detailed-assurance" noink>
                  <!-- <iron-icon class="dark"></iron-icon> -->
                  <a>SHOW DETAILED ASSURANCE</a>
                  
                </paper-button>
            <!-- <a on-tap="_detailToggle" id="toggle"> -->
              <!-- SHOW DETAILED ASSURANCE -->
            <!-- </a> -->
          </div>
        </paper-material>

        <iron-pages selected="0">
          <div>
            <paper-material id="list" class="hact-list" elevation="1">
              <!-- row of table headers -->
              <data-table-header no-collapse>
                <data-table-column class="col-6 layout horizontal" group-heading=" ">
                  <div class="col-5 layout horizontal">
                    <data-table-column class="col-10 nowrap vertical padded fixed" id="name" sortable>
                      IP Name
                    </data-table-column>
                    <data-table-column class="col-2 nowrap vertical padded" id="partner_type">
                      IP Type
                    </data-table-column>
                  </div>
                  <div class="col-3 layout horizontal">
                    <data-table-column class="col-3 vertical nowrap" id="shared_partner">
                      Shared <br>
                      IP
                    </data-table-column>
                    <data-table-column class="col-9 vertical nowrap" id="assessment_type">
                      Assessment Type
                    </data-table-column>
                  </div>
                  <div class="col-4 group layout horizontal">
                    <data-table-column class="col-5 vertical nowrap padded" id="total_ct_cp">
                      Risk Rating
                    </data-table-column>
                    <data-table-column class="col-2 vertical nowrap padded" id="hact_values.planned_cash_transfer">
                      Flags
                    </data-table-column>
                    <data-table-column class="col-5 right vertical padded nowrap" id="total_ct_cy">
                      Cash Transfers <br>
                      1 Jan - 31 Dec
                    </data-table-column>
                  </div>
                </data-table-column>
                <div class="col-6 layout horizontal toggle-container">
                  <data-table-column class="col-4 layout horizontal toggle-container" group-heading="PROGRAMMATIC VISITS">
                    <data-table-column class="col-4 nowrap toggle-container vertical right-side" id="hact_values.micro_assessment_needed">
                      Planned
                    </data-table-column>
                    <data-table-column class="col-4 nowrap vertical right-side" id="rating">
                      Minimum <br> Required
                    </data-table-column>
                    <data-table-column class="col-4 vertical right-side">
                      Completed
                    </data-table-column>
                  </data-table-column>
                  <data-table-column class="col-3 layout horizontal" group-heading="SPOT CHECKS">
                    <data-table-column class="col-1 vertical buffer right-side"></data-table-column>
                    <data-table-column class="col-5 vertical right-side">
                      Minimum <br> Required
                    </data-table-column>
                    <data-table-column class="col-5 vertical right-side">
                      Completed
                    </data-table-column>
                    <data-table-column class="col-1 vertical buffer right-side"></data-table-column>
                  </data-table-column>
                  <data-table-column class="col-4 layout horizontal" group-heading="AUDITS">
                    <data-table-column class="col-4 vertical right-side" id="hact_values.audits_mr">
                      Required
                    </data-table-column>
                    <data-table-column class="col-4 vertical right-side" id="hact_values.audits_done">
                      Completed
                    </data-table-column>
                    <data-table-column class="col-4 vertical right-side">
                      Outstanding <br> Findings
                    </data-table-column>
                  </data-table-column>
                  <data-table-column class="col-1 layout horizontal" group-heading="Hold">
                    <data-table-column class="col-12 vertical right-side" id="hact_values.follow_up_flags">
                      Follow-up
                    </data-table-column>
                  </data-table-column>
                </div>
              </data-table-header>

              <!--Row of Totals-->
              <data-table-row class="totals" no-collapse>
                <div slot="row-data">
                  <div class="col-6 layout horizontal">
                    <div class="col-5 layout horizontal group">
                      <span class="col-10 col-data partner-link padded vertical fixed">
                        Total of [[totalResults]] IPs
                      </span>
                      <span class="col-2 col-data vertical"></span>
                    </div>
                    <div class="col-3 layout horizontal group">
                      <span class="col-3 col-data vertical">[[totals.shared_partner]]</span>
                      <span class="col-9 col-data vertical"></span>
                    </div>
                    <div class="col-4 layout horizontal group">
                        <span class="col-5 col-data vertical"></span>
                        <span class="col-2 col-data vertical"></span>
                        <span class="col-5 col-data padded right">$[[currencyFormat(totals.total_ct_cy)]]</span>
                    </div>
                  </div>
                  <div class="col-6 layout horizontal">
                    <div class="col-4 layout horizontal group">
                      <span class="col-4 right-side">[[totals.planned_visits]]</span>
                      <span class="col-4 right-side">[[totals.programme_visits]]</span>
                      <span class="col-4 right-side">[[totals.programmatic_visits]]</span>
                    </div>
                    <div class="col-3 layout horizontal group">
                      <span class="col-1 right-side"></span>
                      <span class="col-5 right-side">[[totals.mr_spot_checks]]</span>
                      <span class="col-5 right-side">[[totals.spot_checks]]</span>
                      <span class="col-1 right-side"></span>
                    </div>
                    <div class="col-4 layout horizontal group">
                      <span class="col-4 right-side">[[totals.audits_mr]]</span>
                      <span class="col-4 right-side">[[totals.audits_done]]</span>
                      <span class="col-4 right-side"></span>
                    </div>
                    <div class="col-1 layout horizontal group">
                      <span class="col-12 right-side">[[totals.follow_up_flags]]</span>
                    </div>
                  </div>
                </div>
              </data-table-row>

              <template is="dom-repeat" items="[[filteredPartners]]" as="partner">
                <data-table-row no-collapse>
                  <div slot="row-data">
                    <div class="col-6 layout horizontal">
                      <div class="col-5 layout horizontal">
                        <span class="col-10 col-data partner-link padded fixed">
                          <a on-tap="_goToPage" id="[[partner.id]]">
                            [[partner.name]]
                            <paper-tooltip>[[partner.name]]</paper-tooltip>
                          </a>
                        </span>
                        <span class="col-2 col-data">[[partner.partner_type]]
                          <paper-tooltip>[[partner.partner_type]]</paper-tooltip>
                        </span>
                      </div>
                      <div class="col-3 layout horizontal">
                        <span class="col-3 col-data">[[partner.shared_partner]]</span>
                        <span class="col-9 col-data">ASSMT TYPE</span>
                      </div>
                      <div class="col-4 group layout horizontal">
                        <span class="col-5 col-data">[[partner.rating]]</span>
                        <span class="col-2 col-data">FLAGS</span>
                        <span class="col-5 col-data right padded">$[[currencyFormat(partner.total_ct_cy)]]</span>
                      </div>
                    </div>
                    <div class="col-6 layout horizontal">
                      <div class="col-4 layout horizontal group">
                        <span class="col-4 col-data toggler right-side">[[_getGovernmentDisplay(partner,'hact_values.planned_visits')]]</span>
                        <span class="col-4 col-data right-side">[[partner.hact_min_requirements.programme_visits]]</span>
                        <span class="col-4 col-data toggler right-side">[[partner.hact_values.programmatic_visits]]</span>
                      </div>
                      <div class="col-3 layout horizontal group">
                        <span class="col-1 right-side buffer"></span>
                        <span class="col-5 col-data right-side">[[partner.hact_min_requirements.spot_checks]]</span>
                        <span class="col-5 col-data toggler right-side">[[partner.hact_values.spot_checks]]</span>
                        <span class="col-1 right-side buffer"></span>
                      </div>
                      <div class="col-4 layout horizontal group">
                        <span class="col-4 col-data right-side">[[partner.hact_values.audits_mr]]</span>
                        <span class="col-4 col-data right-side">[[partner.hact_values.audits_done]]</span>
                        <span class="col-4 right-side"></span>
                      </div>
                        <div class="col-1 layout horizontal">
                          <span class="col-12 col-data right-side">[[partner.hact_values.follow_up_flags]]</span>
                      </div>
                    </div>
                  </div>
                </data-table-row>
              </template>
              <data-table-footer page-size="[[pageSize]]" page-number="[[pageNumber]]" visible-range="{{visibleRange}}" filtered-total-results="[[filteredTotalResults]]"
                on-page-size-changed="pageSizeChanged" on-page-number-changed="pageNumberChanged">
              </data-table-footer>
            </paper-material>
          </div>
          <div>
            <dashboard-hact-detail 
                              filtered-partners="[[filteredPartners]]" 
                              totals="[[totals]]" 
                              total-results="[[totalResults]]"
                              page-size="[[pageSize]]"
                              page-number="[[pageNumber]]"
                              visible-range="{{visibleRange}}"
                              filtered-total-results="[[filteredTotalResults]]"
                              on-page-size-changed="pageSizeChanged"
                              on-page-number-changed="pageNumberChanged">
            </dashboard-hact-detail>
          </div>
        </iron-pages>
      </div>
      <div>GRAPH ELEMENT</div>
    </iron-pages>
  </template>
  <script>
    (function () {
      'use strict';
      Polymer({
        is: 'dashboard-hact',
        behaviors: [
          dashBehaviors.CommonGeneralBehavior,
          dashBehaviors.PaginationBehavior,
          etoolsAppConfig.globals
        ],
        properties: {
          filteredPartners: {
            type: Array,
            notify: true
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false,
          },
          debounceTime: {
            type: Number,
            value: 50
          },
          urlParams: {
            type: Object,
          },
          totals: {
            type: Array,
          },
          availableYears: {
            type: Array,
            value: [
              {value: '2017', label: '2017'},
              {value: '2016', label: '2016'},
              {value: '2015', label: '2015'},
              {value: '2014', label: '2014'},
            ]
          },
          displayDetail: {
            type: Boolean,
            value: false
          },
          showDash: {
            type: Boolean,
            value: false
          }
        },

        observers: [
          '_updateUrl(queryString, pageNumber, pageSize,' +
          'sortOrder, requiredDataLoaded, initComplete)'
        ],

        _filterPartnersData: function () {
          this.debounce('query', function () {
            this.$.partners.query(
              this.queryString,
              this.sortOrder,
              this.pageSize,
              this.pageNumber);
          }, 50);
        },

        _updateUrl: function () {
          if (!this.initComplete) {
            return;
          }
          this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
          const qs = this.buildQueryString();
          if (qs !== null) {
            this.updateAppState('dashboard/hact', qs, true);
            if (this.requiredDataLoaded) {
              this._filterPartnersData();
            }
          } else {
            if (location.search === '') {
              this.updateAppState('dashboard/hact', qs, false);
            }
            if (this.forceDataRefresh && this.requiredDataLoaded) {
              this._filterPartnersData();
              this.set('forceDataRefresh', false);
            }
          }
        },

        _buildCsvDownloadUrl: function () {
          return this.queryString ?
            this.getEndpoint('partners').url + '?' + 'search=' + this.queryString + '&format=csv' :
            this.getEndpoint('partners').url + '?' + '&format=csv';
        },

        _getProp: function (obj, propStr) {
          if (propStr === 'partner_type') {
            return this._getAbbr(_.get(obj, propStr));
          }
          return _.get(obj, propStr);
        },

        _getAbbr: function (str) {
          return str.length > 12 ?
            str
              .split(' ')
              .map(function (word) {
                return word[0].toUpperCase();
              }).join('') : str;
        },

        _getGovernmentDisplay: function (partner, prop, toCurrency) {
          const partnerValue = _.get(partner, prop);
          if (partner.partner_type === 'Government') {
            return '-';
          } else {
            return toCurrency ? this.currencyFormat(partnerValue) : partnerValue;
          }
        },

        _requiredDataHasBeenLoaded: function (e) {
          e.stopImmediatePropagation();
          let filtered = _.get(this, 'filteredPartners', []);
          if (_.isEmpty(filtered)) {
            this.set('forceDataRefresh', true);
          }
          this.set('requiredDataLoaded', true);
          this.init(this.active);
        },

        _goToPage: function (e) {
          window.location.href = this.baseSite + '/pmp/partners/' + e.target.id + '/details';
        },

        _showDash: function() {
          if (!this.showDash) {
            let pages = Polymer.dom(this.root).querySelectorAll("iron-pages")
            pages[0].selectNext()
            let buttonOne = Polymer.dom(this.root).querySelector(".curved-left")
            buttonOne.style.background = "rgb(216, 216, 216)";
            let buttonTwo = Polymer.dom(this.root).querySelector(".curved-right")
            buttonTwo.style.background = "rgb(255, 255, 255)";
            this.showDash = !this.showDash
          }
        },

        _showPlan: function() {
          if (this.showDash) {
            let pages = Polymer.dom(this.root).querySelectorAll("iron-pages")
            pages[0].selectNext()
            let buttonOne = Polymer.dom(this.root).querySelector(".curved-left")
            buttonOne.style.background = "rgb(255, 255, 255)";
            let buttonTwo = Polymer.dom(this.root).querySelector(".curved-right")
            buttonTwo.style.background = "rgb(216, 216, 216)";
            this.showDash = !this.showDash
          }
        },

        _detailToggle: function() {
          let pages = Polymer.dom(this.root).querySelectorAll("iron-pages")
          pages[1].selectNext()
          let button = Polymer.dom(this.root).querySelector(".detailed-assurance")
          if (!this.displayDetail) {
            button.style.background = "rgb(236, 236, 236)"
          } else {
            button.style.background = "rgb(255, 255, 255)"
          }
          this.displayDetail = !this.displayDetail

        }
      });
    })();

  </script>
</dom-module>