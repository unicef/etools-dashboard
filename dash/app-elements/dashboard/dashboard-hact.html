<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">
<link rel="import" href="../data-table/data-table-footer.html">


<link rel="import" href="dashboard-data/partners-data.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-behavior.html">

<dom-module id="dashboard-hact">
  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors iron-flex-alignment">
      :host {
        --paper-input-container-label: {
          margin-left: 34px;
        };
        --paper-tooltip-opacity: 1;
        width: 100%;
      }

      #query {
        padding-bottom: 8px;
      }

      .hact-list {
        min-width: 1150px;
      }

      .search-bar {
        padding-bottom: 8px;
        padding-top: 8px;
        box-sizing: border-box;
      }

      .nowrap {
        white-space: nowrap;
      }

      .col-4-sub {
        flex: 0 0 calc(33.33333% - 4px);
        flex-basis: calc(33.33333% - 4px);
        max-width: calc(33.33333% - 4px);
      }

      .col-6-sub {
        flex: 0 0 calc(50% - 6px);
        flex-basis: calc(50% - 6px);
        max-width: calc(50% - 6px);
      }

      .col-in-sub {
        text-align: center;
      }

      .col-micro {
        min-width: 86px;
      }

      data-table-header data-table-column {
        @apply(--layout-start);
        box-sizing: border-box;
      }

      data-table-column > data-table-column:last-child {
        padding-right: 0;
      }

      data-table-row > div > div > *:not(:last-child) {
        padding-right: 12px;
      }

      data-table-row > div > div > * {
        box-sizing: border-box;
      }

      data-table-row.totals {
        --primary-background-color: var(--medium-theme-background-color);
        --custom-style: {
          background: var(--medium-theme-background-color);
          border-top: 1px solid rgba(0, 0, 0, 0.24);
          box-shadow: inset 0 -1px 0 0 rgba(0,0,0,0.24);
        }
      }

      data-table-row.totals span{
        font-weight: 500;
      }

      data-table-column {
        padding-right: 12px;
      }

      .partner-link {
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
      }

    </style>
    <partners-data
        id="partners"
        filtered-partners="{{filteredPartners}}"
        total-results="{{totalResults}}"
        totals="{{totals}}"
        active="[[active]]"
        fire-data-loaded show-loading
        on-partners-loaded="_requiredDataHasBeenLoaded">
    </partners-data>
    <paper-material class="list-panel search-bar hact-list" elevation="1">
      <div class="wrap-controls">
        <paper-input id="query"
                     type="search"
                     autocomplete="off"
                     value="[[queryString]]"
                     on-keyup="setQuery"
                     placeholder="Type and search"
                     label="Keywords"
                     always-float-label
                     on-search="setQuery">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
      </div>
    </paper-material>
    <paper-material id="list" class="hact-list" elevation="1">
      <data-table-header label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show" no-collapse>
        <div class="col-3 layout horizontal">
          <data-table-column class="col-6  nowrap" id="name" sortable>
            Implementing Partner
          </data-table-column>
          <data-table-column class="col-3  nowrap" id="partner_type">
            Partner Type
          </data-table-column>
          <data-table-column class="col-3  nowrap" id="shared_partner">
            Shared IP
          </data-table-column>
        </div>
        <data-table-column class="col-3" group-heading="CASH TRANSFERS in USD">
          <data-table-column class="nowrap col-4" id="total_ct_cp">
            TOTAL for <br> current CP cycle
          </data-table-column>
          <data-table-column class="nowrap col-4" id="hact_values.planned_cash_transfer">
            PLANNED for <br> current year
          </data-table-column>
          <data-table-column class="nowrap col-4" id="total_ct_cy">
            ACTUAL for <br> current year
          </data-table-column>
        </data-table-column>
        <data-table-column class="col-micro nowrap" id="hact_values.micro_assessment_needed">
          Micro <br>Assessment
        </data-table-column>
        <div class="col-20 layout horizontal end">
          <data-table-column class="col-4 nowrap" id="rating">
            Risk Rating
          </data-table-column>
          <data-table-column class="col-8" group-heading="PROGRAMMATIC VISITS">
            <data-table-column class="col-4 nowrap" id="hact_values.planned_visits">
              Planned
            </data-table-column>
            <data-table-column class="col-4 nowrap" id="hact_min_requirements.programme_visits">
              M.R
            </data-table-column>
            <data-table-column class="col-4 nowrap" id="hact_values.programmatic_visits">
              Done
            </data-table-column>
          </data-table-column>
        </div>
        <div class="col-30 layout horizontal end">
          <data-table-column class="col-4" group-heading="SPOT CHECKS">
            <data-table-column class="col-6" id="hact_min_requirements.spot_checks">
              M.R
            </data-table-column>
            <data-table-column class="col-6" id="hact_values.spot_checks">
              Done
            </data-table-column>
          </data-table-column>
          <data-table-column class="col-4" group-heading="AUDITS">
            <data-table-column class="col-6" id="hact_values.audits_mr">
              M.R
            </data-table-column>
            <data-table-column class="col-6" id="hact_values.audits_done">
              Done
            </data-table-column>
          </data-table-column>
          <data-table-column class="col-2 nowrap" id="hact_values.follow_up_flags">
            Flag for <br> Follow up
          </data-table-column>
        </div>
      </data-table-header>

      <!--Row of Totals-->
      <data-table-row class="totals" no-collapse>
        <div slot="row-data">
          <div class="col-3 layout horizontal">
              <span class="col-6 col-data partner-link">
                Total of [[totalResults]] IPs
              </span>
            <span class="col-3 col-data "></span>
            <span class="col-3 col-data ">[[totals.shared_partner]]</span>
          </div>
          <div class="col-3 layout horizontal">
            <span class="col-data col-4-sub ">[[currencyFormat(totals.total_ct_cp)]]</span>
            <span class="col-data col-4-sub">[[currencyFormat(totals.planned_cash_transfer)]]</span>
            <span class="col-data col-4-sub">[[currencyFormat(totals.total_ct_cy)]]</span>
          </div>
          <span class="col-data col-micro flex"></span>
          <div class="col-20 layout horizontal">
            <span class="col-data col-4"></span>
            <div class="col-8 layout horizontal">
              <span class="col-data col-4-sub">[[totals.planned_visits]]</span>
              <span class="col-data col-4-sub">[[totals.programme_visits]]</span>
              <span class="col-data col-4-sub">[[totals.programmatic_visits]]</span>
            </div>
          </div>
          <div class="col-30 layout horizontal">
            <div class="col-4 layout horizontal">
              <span class="col-data col-6-sub ">[[totals.mr_spot_checks]]</span>
              <span class="col-data col-6-sub">[[totals.spot_checks]]</span>
            </div>
            <div class="col-4 layout horizontal">
              <span class="col-data col-6-sub">[[totals.audits_mr]]</span>
              <span class="col-data col-6-sub">[[totals.audits_done]]</span>
            </div>
            <span class="col-data col-2 ">[[totals.follow_up_flags]]</span>
          </div>
        </div>
      </data-table-row>

      <template is="dom-repeat" items="[[filteredPartners]]" as="partner">
        <data-table-row no-collapse>
          <div slot="row-data">
            <div class="col-3 layout horizontal">
              <span class="col-6 col-data partner-link">
                <a on-tap="_goToPage" id="[[partner.id]]">
                  [[partner.name]]
                  <paper-tooltip position="right">[[partner.name]]</paper-tooltip>
                </a>
              </span>
              <span class="col-3 col-data ">[[partner.partner_type]]</span>
              <span class="col-3 col-data ">[[partner.shared_partner]]</span>
            </div>
            <div class="col-3 layout horizontal">
              <span class="col-data col-4-sub ">[[currencyFormat(partner.total_ct_cp)]]</span>
              <span class="col-data col-4-sub">[[_getGovernmentDisplay(partner,'hact_values.planned_cash_transfer','true')]]</span>
              <span class="col-data col-4-sub">[[currencyFormat(partner.total_ct_cy)]]</span>
            </div>
            <span class="col-data col-micro flex">[[partner.hact_values.micro_assessment_needed]]</span>
            <div class="col-20 layout horizontal">
              <span class="col-data col-4">[[partner.rating]]</span>
              <div class="col-8 layout horizontal">
                <span class="col-data col-4-sub">[[_getGovernmentDisplay(partner,'hact_values.planned_visits')]]</span>
                <span class="col-data col-4-sub">[[partner.hact_min_requirements.programme_visits]]</span>
                <span class="col-data col-4-sub">[[partner.hact_values.programmatic_visits]]</span>
              </div>
            </div>
            <div class="col-30 layout horizontal">
              <div class="col-4 layout horizontal">
                <span class="col-data col-6-sub ">[[partner.hact_min_requirements.spot_checks]]</span>
                <span class="col-data col-6-sub">[[partner.hact_values.spot_checks]]</span>
              </div>
              <div class="col-4 layout horizontal">
                <span class="col-data col-6-sub">[[partner.hact_values.audits_mr]]</span>
                <span class="col-data col-6-sub">[[partner.hact_values.audits_done]]</span>
              </div>
              <span class="col-data col-2 ">[[partner.hact_values.follow_up_flags]]</span>
            </div>
          </div>
        </data-table-row>
      </template>
      <data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          total-results="[[totalResults]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="pageSizeChanged"
          on-page-number-changed="pageNumberChanged">
      </data-table-footer>
    </paper-material>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'dashboard-hact',
        behaviors: [
          dashBehaviors.CommonGeneralBehavior,
          dashBehaviors.PaginationBehavior,
          etoolsAppConfig.globals
        ],
        properties: {
          filteredPartners: {
            type: Array,
            notify: true
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false,
          },
          debounceTime: {
            type: Number,
            value: 50
          },
          urlParams: {
            type: Object,
          },
          totals: {
            type: Array,
          }
        },

        observers: [
          '_updateUrl(queryString, pageNumber, pageSize,' +
          'sortOrder, requiredDataLoaded, initComplete)'
        ],

        _filterPartnersData: function() {
          this.debounce('query', function() {
            this.$.partners.query(
                this.queryString,
                this.sortOrder,
                this.pageSize,
                this.pageNumber);
          }, 50);
        },
        _updateUrl: function() {
          if (!this.initComplete) {
            return;
          }
          this.set('csvDownloadUrl', this._buildCsvDownloadUrl());

          var qs = this.buildQueryString();
          if (qs !== null) {
            this.updateAppState('dashboard/hact', qs, true);
            if (this.requiredDataLoaded) {
              this._filterPartnersData();
            }
          } else {
            if (location.search === '') {
              this.updateAppState('dashboard/hact', qs, false);
            }
            if (this.forceDataRefresh && this.requiredDataLoaded) {
              this._filterPartnersData();
              this.set('forceDataRefresh', false);
            }
          }
        },

        _buildCsvDownloadUrl: function() {
          return this.queryString ?
              this.getEndpoint('partners').url + '?' + 'search=' + this.queryString + '&format=csv' :
              this.getEndpoint('partners').url + '?' + '&format=csv';
        },
        _getProp: function(obj, propStr) {
          if (propStr === 'partner_type') {
            return this._getAbbr(_.get(obj, propStr));
          }
          return _.get(obj, propStr);
        },
        _getAbbr: function(str) {
          return str.length > 12 ?
              str
                  .split(' ')
                  .map(function(word) {
                    return word[0].toUpperCase();
                  }).join('') : str;
        },

        _getGovernmentDisplay: function(partner,prop,toCurrency) {
          var partnerValue = _.get(partner, prop);
          if (partner.partner_type === 'Government') {
            return '-';
          } else {
            return toCurrency ? this.currencyFormat(partnerValue) : partnerValue;
          }
        },

        _requiredDataHasBeenLoaded: function(e) {
          e.stopImmediatePropagation();
          var filtered = _.get(this, 'filteredPartners', []);
          if (_.isEmpty(filtered)) {
            this.set('forceDataRefresh', true);
          }
          this.set('requiredDataLoaded', true);
          this.init(this.active);
        },
        _goToPage: function(e) {
          window.location.href = this.baseSite + '/pmp/partners/' + e.target.id + '/details';
        },

      });
    })();

  </script>
</dom-module>
