<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">

<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-elements/static-common-data/redux-bahaviors/common-static-data-redux-bahavior.html">
<link rel="import" href="dashboard-data/partnership-data.html">
<dom-module id="dashboard-partnerships">

  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors page-layout-styles">
      .by-type {
        padding: 0;
        @apply(--layout-horizontal);
      }

      span.title {
        color: var(--accent-color);
        font-weight: 500;
      }
      data-table-header data-table-column:not(:first-child) {
        box-sizing: border-box;
        padding-left: 8px;

      }
      .col-small {
        flex: 0 0 8.66666667%;
        max-width: 8.66666667%;
      }
    </style>
    <!--<partnership-data partnership="{{partnership}}" filter="[[filter]]"></partnership-data>-->
    <paper-material class="list-panel listControls" elevation="1">
      <div class="controls-wrapper">
        <paper-input id="query"
                     type="search"
                     autocomplete="off"
                     value="[[queryString]]"
                     on-keyup="_setQuery"
                     placeholder="Search partner name"
                     always-float-label
                     on-search="_setQuery">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
      </div>
    </paper-material>

    <paper-material id="list" elevation="1">
      <data-table-header label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show"  no-collapse>
        <data-table-column class="flex-2">
          Partners
        </data-table-column>
        <data-table-column class="flex-2">
          PD/SSFA Ref #
        </data-table-column>
        <data-table-column class="flex-2">
          Section
        </data-table-column>
        <data-table-column class="flex">
          Field Office
        </data-table-column>
        <data-table-column class="flex">
          Status
        </data-table-column>
        <data-table-column class="flex">
          Start Date <br> End Date
        </data-table-column>
        <data-table-column class="flex">
          Total UNICEF <br>Cash ($)
        </data-table-column>
        <data-table-column class="flex">
          Total UNICEF <br>Supplies ($)
        </data-table-column>
        <data-table-column class="flex">
          CSO <br>Contr. ($)
        </data-table-column>
        <data-table-column class="flex">
          Total <br> Budget ($)
        </data-table-column>
        <data-table-column class="flex">
          $ Disburs. <br>To Date (%)
        </data-table-column>
        <data-table-column class="flex">
          Days Since <br>Last PV
        </data-table-column>
      </data-table-header>
      <template is="dom-repeat" items="[[data.rows]]" as="row">
        <data-table-row no-collapse>
          <div slot="row-data">
            <span class="col-data flex-2 title">
              [[row.title]]
            </span>
            <span class="col-data flex">
              [[row.number_partnerships]]
            </span>
            <span class="col-data flex">
              [[currencyFormat(row.total_value)]]
            </span>
            <span class="col-data flex">
              [[row.percent_active]]
            </span>
          </div>
        </data-table-row>
      </template>
    </paper-material>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'dashboard-partnerships',
        behaviors: [
          dashBehaviors.DropdownBehavior,
          dashBehaviors.EtoolsStaticCommonDataReduxBehavior,
          dashBehaviors.CommonGeneralBehavior
        ],
        observers: [
          'init(active)'
        ],
        properties: {
          country_programme: {
            type: String,
            observer: '_filterChanged'
          },
          office: {
            type: String,
            observer: '_filterChanged'
          },
          countryProgrammeItems: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          officeItems: {
            type: Array,
            statePath: 'offices'
          },
          partnership: {
            type: Object,
            notify: true,
            observer: '_partnershipChanged'
          },
          filter: {
            type: Object,
            notify: true,
          },
          data: {
            type: Object,
            notify: true
          },
          fakeData: {
            type: Array,
            value: [
              {
                partner: 'ABAAD RESOURCE CENTER FOR GENDER',
                number: 'LEBA/PCA2017060623',
                section: 'Communication for Development',
                office: 'Beirut, Tyre',
                status: 'Active',
                start_date: '4 April 2016',
                end_date: '3 April 2017',
                total_unicef_cash: 1077515,
                total_supplies: 12097,
                cso_contribution: '0',
                total_budget: 1077515,
                disburs_to_date: 80,
                days_last_pv: 32
              },
              {
                partner: 'ABAAD RESOURCE CENTER FOR GENDER',
                number: 'LEBA/PCA201623432',
                section: 'Health and Nutrition',
                office: 'Tripoli, Zahle',
                status: 'Terminated',
                start_date: '2 Feb 2017',
                end_date: '30 Dec 2017',
                total_unicef_cash: 264597,
                total_supplies: 23091,
                cso_contribution: 12009,
                total_budget: 264597,
                disburs_to_date: 20,
                days_last_pv: 5
              },
              {
                partner: 'ABAAD RESOURCE CENTER FOR GENDER',
                number: 'PCA/LEBA/2014/05123123',
                section: 'Adolescence & Youth',
                office: 'Tripoli',
                status: 'Active',
                start_date: '16 Jun 2016',
                end_date: '15 Jun 2017',
                total_unicef_cash: 234120,
                total_supplies: 9022,
                cso_contribution: 234340,
                total_budget: 234120,
                disburs_to_date: 0,
                days_last_pv: 12
              },
              {
                partner: 'ACTED',
                number: 'LEBA/PCA2017061231',
                section: 'Communication for Development',
                office: 'Beirut, Tyre',
                status: 'Active',
                start_date: '4 Apr 2016',
                end_date: '3 Apr 2017',
                total_unicef_cash: 1077515,
                total_supplies: 23091,
                cso_contribution: 12009,
                total_budget: 1077212,
                disburs_to_date: 12,
                days_last_pv: 3
              },
              {
                partner: 'ACTED',
                number: 'LEBA/PCA20161223231',
                section: 'Health and Nutrition',
                office: 'Tripoli, Tyre',
                status: 'Terminated',
                start_date: '4 Apr 2016',
                end_date: '3 Apr 2017',
                total_unicef_cash: 341233,
                total_supplies: 12332,
                cso_contribution: 111233,
                total_budget: 3322312,
                disburs_to_date: 39,
                days_last_pv: 9
              },
              {
                partner: 'ACTION CONTRA LA FAIM LIBAN',
                number: 'PCA/LEBA/2014/051212',
                section: 'Advocacy and Communication',
                office: 'Beirut, Tripoli',
                status: 'Active',
                start_date: '12 Jun 2016',
                end_date: '8 Aug 2017',
                total_unicef_cash: 21333122,
                total_supplies: 99812,
                cso_contribution: 299128,
                total_budget: 20129199,
                disburs_to_date: 10,
                days_last_pv: 2
              },
              {
                partner: 'ACTION CONTRA LA FAIM LIBAN',
                number: 'LEBA/SSFA2012121',
                section: 'WASH',
                office: 'Qubbayat',
                status: 'Active',
                start_date: '2 Mar 2016',
                end_date: '20 Sept 2017',
                total_unicef_cash: 927126,
                total_supplies: 28127,
                cso_contribution: 28838,
                total_budget: 65122221,
                disburs_to_date: 39,
                days_last_pv: 10
              },
              {
                partner: 'ABAAD RESOURCE CENTER FOR GENDER',
                number: 'LEBA/PCA201623432',
                section: 'Health and Nutrition',
                office: 'Tripoli, Zahle',
                status: 'Terminated',
                start_date: '2 Feb 2017',
                end_date: '30 Dec 2017',
                total_unicef_cash: 264597,
                total_supplies: 23091,
                cso_contribution: 12009,
                total_budget: 264597,
                disburs_to_date: 20,
                days_last_pv: 5
              },
              {
                partner: 'ACTED',
                number: 'LEBA/PCA2017061231',
                section: 'Communication for Development',
                office: 'Beirut, Tyre',
                status: 'Active',
                start_date: '4 Apr 2016',
                end_date: '3 Apr 2017',
                total_unicef_cash: 1077515,
                total_supplies: 23091,
                cso_contribution: 12009,
                total_budget: 1077212,
                disburs_to_date: 12,
                days_last_pv: 3
              },
              {
                partner: 'ACTED',
                number: 'LEBA/PCA20161223231',
                section: 'Health and Nutrition',
                office: 'Tripoli, Tyre',
                status: 'Terminated',
                start_date: '4 Apr 2016',
                end_date: '3 Apr 2017',
                total_unicef_cash: 341233,
                total_supplies: 12332,
                cso_contribution: 111233,
                total_budget: 3322312,
                disburs_to_date: 39,
                days_last_pv: 9
              },
              {
                partner: 'ACTION CONTRA LA FAIM LIBAN',
                number: 'PCA/LEBA/SSFA2012121',
                section: 'Adolescence & Youth',
                office: 'Tripoli',
                status: 'Active',
                start_date: '12 Jun 2016',
                end_date: '03 Oct 2017',
                total_unicef_cash: 8872821,
                total_supplies: 399192,
                cso_contribution: 21922,
                total_budget: 8819821,
                disburs_to_date: 100,
                days_last_pv: 30
              },
              {
                partner: 'ABAAD RESOURCE CENTER FOR GENDER',
                number: 'PCA/LEBA/2014/05123123',
                section: 'Adolescence & Youth',
                office: 'Tripoli',
                status: 'Active',
                start_date: '16 Jun 2016',
                end_date: '15 Jun 2017',
                total_unicef_cash: 234120,
                total_supplies: 9022,
                cso_contribution: 234340,
                total_budget: 234120,
                disburs_to_date: 0,
                days_last_pv: 12
              },
              {
                partner: 'ACTED',
                number: 'LEBA/PCA2017061231',
                section: 'Communication for Development',
                office: 'Beirut, Tyre',
                status: 'Active',
                start_date: '4 Apr 2016',
                end_date: '3 Apr 2017',
                total_unicef_cash: 1077515,
                total_supplies: 23091,
                cso_contribution: 12009,
                total_budget: 1077212,
                disburs_to_date: 12,
                days_last_pv: 3
              },
              {
                partner: 'ACTED',
                number: 'LEBA/PCA20161223231',
                section: 'Health and Nutrition',
                office: 'Tripoli, Tyre',
                status: 'Terminated',
                start_date: '4 Apr 2016',
                end_date: '3 Apr 2017',
                total_unicef_cash: 341233,
                total_supplies: 12332,
                cso_contribution: 111233,
                total_budget: 3322312,
                disburs_to_date: 39,
                days_last_pv: 9
              },
              {
                partner: 'ACTION CONTRA LA FAIM LIBAN',
                number: 'PCA/LEBA/2014/051212',
                section: 'Advocacy and Communication',
                office: 'Beirut, Tripoli',
                status: 'Active',
                start_date: '12 Jun 2016',
                end_date: '8 Aug 2017',
                total_unicef_cash: 21333122,
                total_supplies: 99812,
                cso_contribution: 299128,
                total_budget: 20129199,
                disburs_to_date: 10,
                days_last_pv: 2
              },
              {
                partner: 'ACTION CONTRA LA FAIM LIBAN',
                number: 'PCA/LEBA/SSFA2012121',
                section: 'Adolescence & Youth',
                office: 'Tripoli',
                status: 'Active',
                start_date: '12 Jun 2016',
                end_date: '03 Oct 2017',
                total_unicef_cash: 8872821,
                total_supplies: 399192,
                cso_contribution: 21922,
                total_budget: 8819821,
                disburs_to_date: 100,
                days_last_pv: 30
              }
            ]
          }
        },
        init: function(active) {
          if (active) {
            if (!this.filter) {
              this.set('filter', {
                country_programme: null,
                office: null
              });
            }
          }
        },
        _filterChanged: function() {
          var filter = {country_programme: null, office: null};
          if (this.country_programme) {
            this.$.cpDropdown.invalid = false;
            filter = {
              country_programme: parseInt(this.country_programme, 10),
              office: parseInt(this.office, 10)
            };
          } else {
            if (this.office) {
              this.$.cpDropdown.invalid = true;
            } else {
              this.$.cpDropdown.invalid = false;
            }
          }
          if (!_.isEqual(this.filter, filter)) {
            this.set('filter', filter);
          }
        },
        _partnershipChanged: function(partnership) {
          var formatted = {
            rows: [
              {
                title: 'Active Programme Documents for this year',
                number_partnerships: partnership.active_this_year_count,
                total_value: partnership.active_this_year_value,
                percent_active: partnership.active_this_year_percentage
              },
              {
                title: 'Active Partnerships approved in previous years',
                number_partnerships: partnership.active_last_year_count,
                total_value: partnership.active_last_year_value,
                percent_active: partnership.active_last_year_percentage
              },
              {
                title: 'Expiring Partnerships in next two months',
                number_partnerships: partnership.expire_in_two_months_count,
                total_value: partnership.expire_in_two_months_value,
                percent_active: partnership.expire_in_two_months_percentage
              }
            ],
            byType: _.values(partnership.partners)
          };
          this.set('data', formatted);
          this.fire('global-loading', {active: false});
        }
      });
    })();
  </script>

</dom-module>
