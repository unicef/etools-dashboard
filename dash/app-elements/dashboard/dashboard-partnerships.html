<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">

<link rel="import" href="../../app-config/etools-app-config.html">

<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">
<link rel="import" href="../data-table/data-table-footer.html">

<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-behaviors/pagination-behavior.html">
<link rel="import" href="../../app-elements/static-common-data/redux-bahaviors/common-static-data-redux-bahavior.html">
<link rel="import" href="dashboard-data/partnership-data.html">
<dom-module id="dashboard-partnerships">

  <template>
    <style include="shared-styles list-styles grid-layout-styles iron-flex iron-flex-factors page-layout-styles">
      .by-type {
        padding: 0;
        @apply(--layout-horizontal);
      }

      span.title {
        color: var(--accent-color);
        font-weight: 500;
      }

      data-table-header data-table-column:not(:first-child), data-table-row span:not(:first-child) {
        box-sizing: border-box;
        padding-left: 8px;

      }

      .right-align {
        text-align: right;
      }
    </style>
    <partnership-data id="partnerships"
                      filtered-partnerships="{{filteredPartnerships}}"
                      fire-data-loaded
                      active="[[active]]"
                      total-results="{{totalResults}}"
                      on-partnerships-loaded="_requiredDataLoaded"></partnership-data>
    <paper-material class="list-panel listControls" elevation="1">
      <div class="controls-wrapper">
        <paper-input id="query"
                     type="search"
                     autocomplete="off"
                     value="[[queryString]]"
                     on-keyup="setQuery"
                     placeholder="Search partner name"
                     always-float-label
                     on-search="setQuery">
          <iron-icon icon="search" prefix></iron-icon>
        </paper-input>
      </div>
    </paper-material>

    <paper-material id="list" elevation="1">
      <data-table-header label="[[visibleRange.0]]-[[visibleRange.1]] of [[totalResults]] results to show" no-collapse>
        <data-table-column class="flex-2" sortable>
          Partners
        </data-table-column>
        <data-table-column class="flex-2">
          PD/SSFA Ref #
        </data-table-column>
        <data-table-column class="flex-2">
          Section
        </data-table-column>
        <data-table-column class="flex">
          Field Office
        </data-table-column>
        <data-table-column class="flex">
          Status
        </data-table-column>
        <data-table-column class="flex">
          Start Date <br> End Date
        </data-table-column>
        <data-table-column class="flex right-align">
          Total UNICEF <br>Cash ($)
        </data-table-column>
        <data-table-column class="flex right-align">
          Total UNICEF <br>Supplies ($)
        </data-table-column>
        <data-table-column class="flex right-align">
          CSO <br>Contr. ($)
        </data-table-column>
        <data-table-column class="flex right-align">
          Total <br> Budget ($)
        </data-table-column>
        <data-table-column class="flex right-align">
          $ Disburs. <br>To Date (%)
        </data-table-column>
        <data-table-column class="flex right-align">
          Days Since <br>Last PV
        </data-table-column>
      </data-table-header>
      <template is="dom-repeat" items="[[filteredPartnerships]]" as="row">
        <data-table-row no-collapse>
          <div slot="row-data">
            <a on-tap="goToPage"
               href="[[baseSite]]/pmp/partners/[[row.partner_id]]/details"
               app-name="pmp"
               page="partners"
               id="[[row.partner_id]]/details"
               class="col-data flex-2 title">
              [[row.partner_name]]
            </a>
            <a on-tap="goToPage"
               href="[[baseSite]]/pmp/interventions/[[row.intervention_id]]/details"
               app-name="pmp"
               page="interventions"
               id="[[row.intervention_id]]/details"
               class="col-data flex-2 title">
              [[row.number]]
            </a>
            <span class="col-data flex-2">
              <template is="dom-repeat" items="{{row.sectors}}" as="">
                [[item]]<br>
              </template>
            </span>
            <span class="col-data flex">
              <template is="dom-repeat" items="{{row.offices_names}}" as="">
                [[item]]<br>
              </template>
            </span>
            <span class="col-data flex">
              [[row.status]]
            </span>
            <span class="col-data flex">
              [[row.start]] <br> [[row.end]]
            </span>
            <span class="col-data flex right-align">
              [[currencyFormat(row.unicef_cash)]]
            </span>
            <span class="col-data flex right-align">
              [[currencyFormat(row.unicef_supplies)]]
            </span>
            <span class="col-data flex right-align">
              [[currencyFormat(row.cso_contribution)]]
            </span>
            <span class="col-data flex right-align">
              [[currencyFormat(row.total_budget)]]
            </span>
            <span class="col-data flex right-align">
              [[_getDisbursements(row.disbursement,row.frs_total_frs_amt)]]%
            </span>
            <span class="col-data flex right-align">
              [[row.days_last_pv]]
            </span>
          </div>
        </data-table-row>
      </template>
      <data-table-footer
          page-size="[[pageSize]]"
          page-number="[[pageNumber]]"
          total-results="[[totalResults]]"
          visible-range="{{visibleRange}}"
          on-page-size-changed="pageSizeChanged"
          on-page-number-changed="pageNumberChanged">
      </data-table-footer>
    </paper-material>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'dashboard-partnerships',
        behaviors: [
          dashBehaviors.DropdownBehavior,
          dashBehaviors.EtoolsStaticCommonDataReduxBehavior,
          dashBehaviors.PaginationBehavior,
          dashBehaviors.CommonGeneralBehavior
        ],
        observers: [
          '_updateUrl(queryString, pageNumber, pageSize,' +
          'sortOrder, requiredDataLoaded, initComplete)'
        ],

        properties: {
          filteredPartnerships: {
            type: Array,
            notify: true,
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false,
          },
          urlParams: {
            type: Object,
          },
        },

        _updateUrl: function() {
          if (!this.initComplete) {
            return;
          }
          var qs = this.buildQueryString();
          if (qs !== null) {
            this.updateAppState('dashboard/partnerships', qs, true);
            if (this.requiredDataLoaded) {
              this._filterPartnershipsData();
            }
          } else {
            if (location.search === '') {
              this.updateAppState('dashboard/partnerships', qs, false);
            }
            if (this.forceDataRefresh && this.requiredDataLoaded) {
              this._filterPartnershipsData();
              this.set('forceDataRefresh', false);
            }
          }
        },

        _filterPartnershipsData: function() {
          this.$.partnerships.query(
              this.queryString,
              this.sortOrder,
              this.pageSize,
              this.pageNumber);
        },

        _requiredDataLoaded: function(e) {
          e.stopImmediatePropagation();
          var filtered = _.get(this, 'filteredPartnerships', []);
          if (_.isEmpty(filtered)) {
            this.set('forceDataRefresh', true);
          }
          this.set('requiredDataLoaded', true);
          this.init(this.active);
        },
        _getDisbursements: function(disb,fr) {
          return disb === '0.00' ? '0': Number(disb)/Number(fr)*100;
        }


      });
    })();
  </script>
</dom-module>
