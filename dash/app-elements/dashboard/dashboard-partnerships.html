<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">


<link rel="import" href="../data-table/data-table-header.html">
<link rel="import" href="../data-table/data-table-column.html">
<link rel="import" href="../data-table/data-table-row.html">

<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../../app-behaviors/dropdown-behavior.html">
<link rel="import" href="../../app-behaviors/common-general-behavior.html">
<link rel="import" href="../../app-elements/static-common-data/redux-bahaviors/common-static-data-redux-bahavior.html">
<link rel="import" href="dashboard-data/partnership-data.html">
<dom-module id="dashboard-partnerships">

  <template>
    <style include="shared-styles list-styles iron-flex iron-flex-factors page-layout-styles">
      .by-type {
        padding: 0;
        @apply(--layout-horizontal);
      }
    </style>
    <partnership-data partnership="{{partnership}}" filter="[[filter]]"></partnership-data>
    <paper-material class="list-panel listControls" elevation="1">
      <div class="controls-wrapper">

        <div class="title-row">
          <h1 sub-title>Partnerships</h1>
        </div>

        <div class="filters-divider"></div>

        <div class="wrap-controls">
          <div class="dropdown-with-clear-btn">
            <paper-icon-button class="clear dark" icon="close" on-tap="clearDropdown"></paper-icon-button>
            <paper-dropdown-menu label="Country Programme" placeholder="Select from list" noink>
              <paper-menu class="dropdown-content" attr-for-selected="id" selected="{{country_programme}}">
                <template is="dom-repeat" items="[[countryProgrammeItems]]">
                  <paper-item id="[[item.id]]">[[item.name]]</paper-item>
                </template>
              </paper-menu>
            </paper-dropdown-menu>
          </div>
          <div class="dropdown-with-clear-btn">
            <paper-icon-button class="clear dark" icon="close" on-tap="clearDropdown"></paper-icon-button>
            <paper-dropdown-menu label="Office" placeholder="Select from list" noink>
              <paper-menu class="dropdown-content" attr-for-selected="id" selected="{{office}}">
                <template is="dom-repeat" items="[[officeItems]]">
                  <paper-item id="[[item.id]]">[[item.name]]</paper-item>
                </template>
              </paper-menu>
            </paper-dropdown-menu>
          </div>
        </div>
      </div>
    </paper-material>

    <paper-material class="list-panel by-type" elevation="1">
      <div class="trip title-row ">
        <h2 sub-title>Partnerships by type</h2>
      </div>
      <div class="trips flex-c">
        <div class="trip trip-type-one flex-c">
          <h1>Bilateral <br>Multilateral</h1>
          [[data.byType.0]]
        </div>
        <div class="trip trip-type-two flex-c">
          <h1>Civil Society <br>Organizations</h1>
          [[data.byType.1]]
        </div>
        <div class="trip trip-type-three flex-c">
          <h1>UN Agency</h1>
          [[data.byType.2]]
        </div>
        <div class="trip trip-type-four flex-c">
          <h1>Government</h1>
          [[data.byType.3]]
        </div>
      </div>
    </paper-material>

    <paper-material id="list" elevation="1">
      <data-table-header no-title no-collapse>
        <data-table-column class="flex-2">
          Partnerships (PD, SHPD, SSFA ToR, DCT to government)
        </data-table-column>
        <data-table-column class="flex">
          Number of Partnerships
        </data-table-column>
        <data-table-column class="flex">
          Total Value of Partnerships
        </data-table-column>
        <data-table-column class="flex">
          % of Active Partnerships
        </data-table-column>
      </data-table-header>
      <template is="dom-repeat" items="[[data.rows]]" as="row">
        <data-table-row no-collapse>
          <div slot="row-data">
            <a href="#" class="col-data flex-2">
              [[row.title]]
            </a>
            <span class="col-data flex">
              [[row.number_partnerships]]
            </span>
            <span class="col-data flex">
              [[row.total_value]]
            </span>
            <span class="col-data flex">
              [[row.percent_active]]%
            </span>
          </div>
        </data-table-row>
      </template>


    </paper-material>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'dashboard-partnerships',
        behaviors: [
          dashBehaviors.DropdownBehavior,
          dashBehaviors.EtoolsStaticCommonDataReduxBehavior,
        ],
        observers: [
          'init(active)',
        ],
        properties: {
          country_programme: {
            type: String,
            observer: '_filterChanged'
          },
          office: {
            type: String,
            observer: '_filterChanged'
          },
          countryProgrammeItems: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          officeItems: {
            type: Array,
            statePath: 'offices'
          },
          partnership: {
            type: Object,
            notify: true,
            observer: '_partnershipChanged'
          },
          filter: {
            type: Object,
            notify: true,
          },
          data: {
            type: Object,
            notify: true
          }
        },
        init: function(active) {
          if (active) {
            this._filterChanged();
          }
        },
        _filterChanged: function() {
          var filter = {
            country_programme: 0,
            office: 0
          }
          if (this.country_programme) {
            filter = {
              country_programme: parseInt(this.country_programme, 10),
              office: parseInt(this.office, 10)
            }
          }
          if(!_.isEqual(this.filter, filter)) {
            this.set('filter', filter);
          }
        },
        _partnershipChanged: function(partnership) {
          var formatted = {
            rows: [
              {
                title: 'Active Programme Documents for this year',
                number_partnerships: partnership.active_this_year_count,
                total_value: partnership.active_this_year_value,
                percent_active: partnership.active_this_year_percentage
              },
              {
                title: 'Active Partnerships approved in previous years',
                number_partnerships: partnership.active_last_year_count,
                total_value: partnership.active_last_year_value,
                percent_active: partnership.active_last_year_percentage
              },
              {
                title: 'Expiring Partnerships in next two months',
                number_partnerships: partnership.expire_in_two_months_count,
                total_value: partnership.expire_in_two_months_value,
                percent_active: partnership.expire_in_two_months_percentage
              }
            ],
            byType: _.values(partnership.partners)
          };
          this.set('data', formatted);
          this.fire('global-loading', {active: false});
        }
      });

    })();
  </script>

</dom-module>
