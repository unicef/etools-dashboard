<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../app-behaviors/data-element-behavior.html">
<link rel="import"
      href="../../../app-elements/static-common-data/redux-bahaviors/common-static-data-redux-bahavior.html">
<link rel="import" href="../../../app-config/etools-app-config.html">

<dom-module id="user-profile-data">

  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 on-success="_handleResponse"
                 on-fail="_handleErrorResponse"></etools-ajax>
  </template>

  <script>
    Polymer({
      is: 'user-profile-data',
      behaviors: [
        dashBehaviors.DataElementBehavior,
        etoolsAppConfig.globals,
        dashBehaviors.EtoolsStaticCommonDataReduxBehavior
      ],
      properties: {
        endpointName: {
          type: String,
          value: 'myProfile'
        },
        userProfile: {
          type: Object,
          notify: true
        }
      },
      actions: {
        setUserProfileData: function(data) {
          return {
            type: 'SET_USER_PROFILE',
            userProfile: data
          };
        },
        setUserPermissions: function (permissions) {
          return {
            type: 'SET_USER_PERMISSIONS',
            permissions: permissions
          };
        }
      },
      saveProfile: function(profile) {
        var url = this.endpoint.url;
        if (_.isEmpty(profile)) {
          return;
        }
        if (!_.isEmpty(profile)) {
          this.fire('global-loading', {message: 'Saving profile data...', active: true});
          this._prepareAndFireRequest('PATCH', profile, url);
        } else {
          this.fire('toast', {
            text: 'There is nothing to save. No change detected on your profile.',
            showCloseBtn: true
          });
        }
      },
      _prepareAndFireRequest: function(method, data, url) {
        this._resetAjax();
        if (!method) {
          method = 'GET';
        }
        this.$.ajax.set('method', method);
        if (typeof data === 'object' && Object.keys(data).length > 0
            && ['PATCH', 'POST'].indexOf(method) > -1) {
          this.$.ajax.set('body', data);
          this.$.ajax.set('url', url);
        }
      },
      _resetAjax: function() {
        this.$.ajax.set('params', null);
        this.$.ajax.set('body', null);
        this.$.ajax.set('url', null);
      },
      _handleResponse: function(response) {
        var user = _.get(response, 'detail', {});
        this._setPermissions(user);
        this.dispatch('setUserProfileData', user);
        this.fire('global-loading');
      },
      _setPermissions: function (user) {
        var _permissions = {};
        var permissionsList = this.getAllPermissions();
        if (!_.isEmpty(user)) {
          permissionsList.defaultPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
          if (!user.is_staff) {
            permissionsList.partnerOnlyPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });
          } else {
            // user is not partner but staff:
            permissionsList.managementPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });

            if (user.partner_staff_member) {
              // staff that has faked partnership by setting partner_staff_member on their profile
              permissionsList.partnerPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            }
          }
        } else {
          //for testing
          permissionsList.superPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
        }
        this.dispatch('setUserPermissions', _permissions);

      }
    });

  </script>

</dom-module>
