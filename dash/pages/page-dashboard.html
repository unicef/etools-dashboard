<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../app-elements/page-header/page-header.html">
<link rel="import" href="../app-elements/page-footer/page-footer.html">

<link rel="import" href="../app-elements/dashboard/dashboard-partnerships.html">
<link rel="import" href="../app-elements/dashboard/dashboard-personalized.html">
<link rel="import" href="../app-elements/dashboard/dashboard-hact.html">
<link rel="import" href="../app-elements/dashboard/dashboard-trips.html">
<link rel="import" href="../app-elements/dashboard/dashboard-map.html">



<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/buttons-styles.html">
<link rel="import" href="../app-config/etools-app-config.html">
<link rel="import" href="../app-behaviors/page-utils-behavior.html">

<dom-module id="page-dashboard">

  <template>

    <style include="page-layout-styles shared-styles buttons-styles">
      :host {
        display: block;
      }
      .top-content-actions-wrapper {
        display: flex;
        align-items: flex-end;
        height: 32px;
      }
      .top-content-action paper-button {
        padding-bottom: 4px
      }
      etools-dropdown {
        max-width: 100px;
      }
    </style>

    <app-route
        route="{{route}}"
        pattern="dashboard/:dashTab"
        active="{{tabsActive}}"
        data="{{routeData}}"
        query-params="{{queryParams}}"></app-route>

    <app-header-layout>
      <div class="page-top-content with-tabs">
        <div class="top-content">
          <div class="top-content-row title-row">
            <h1 main-title>
              [[pageTitle]]
            </h1>
            <div class="top-content-actions-wrapper">
              <div class="top-content-action">
                <etools-dropdown
                            id="exportYear"
                            label="Export Year"
                            options="[[availableYears]]"
                            on-iron-select="_setExportYear"
                            dropdown-value="/api/v2/partners/hact?&format=csv"
                            hide-search hidden$="[[!_isActive(partnershipPage, 'hact')]]">
                </etools-dropdown>
              </div>
              <div class="top-content-action" hidden$="[[!hactActive]]">
                <a target="_blank" href="[[exportUrl]]">
                  <paper-button>
                    <iron-icon icon="file-download"></iron-icon>
                    Export
                  </paper-button>
                </a>
              </div>
              <div class="top-content-action" hidden$="[[!_isActive(partnershipPage,'trips')]]">
                <paper-button class="primary-btn with-prefix" on-tap="_goToAddTrip" >
                  <iron-icon icon="add"></iron-icon>
                  Add New Trip
                </paper-button>
              </div>
              <!--// TODO: implement print-->
              <!--<div class="top-content-action">-->
                <!--<paper-button>-->
                  <!--<iron-icon icon="print"></iron-icon>-->
                  <!--Print-->
                <!--</paper-button>-->
              <!--</div>-->
            </div>
          </div>
          <div class="top-content-row">
            <paper-tabs
                selected="{{routeData.dashTab}}"
                attr-for-selected="name"
                 noink bottom-item>

              <paper-tab name="personalized" link>
                <span class="tab-content">Personalized</span>
              </paper-tab>

              <paper-tab name="hact" link>
                <span class="tab-content">HACT</span>
              </paper-tab>

              <paper-tab name="trips" link>
                <span class="tab-content">Trips</span>
              </paper-tab>

              <paper-tab name="partnerships" link>
                <span class="tab-content">Partnerships</span>
              </paper-tab>

              <paper-tab name="map" link>
                <span class="tab-content">Map</span>
              </paper-tab>

            </paper-tabs>
          </div>
        </div>
      </div>

      <iron-pages id="partnershipPages"
                  selected="{{partnershipPage}}"
                  attr-for-selected="name"
                  fallback-selection="personalized"
                  role="main">
        <div class="page" name="hact">
          <dashboard-hact active="[[_isActive(partnershipPage,'hact')]]"
          route="{{route}}"
          url-params="[[queryParams]]"
                          csv-download-url="{{csvUrl}}"></dashboard-hact>
        </div>
        <div class="page" name="personalized">
          <dashboard-personalized user="[[user]]" active="[[_isActive(partnershipPage,'personalized')]]"
                                  route="{{route}}"></dashboard-personalized>
        </div>
        <div class="page" name="trips">
          <dashboard-trips active="[[_isActive(partnershipPage,'trips')]]" route="{{route}}"></dashboard-trips>
        </div>
        <div class="page" name="partnerships">
          <dashboard-partnerships active="[[_isActive(partnershipPage,'partnerships')]]"
                                  url-params="[[queryParams]]"
                                  csv-download-url="{{csvUrl}}"></dashboard-partnerships>
        </div>
        <div class="page" name="map">
          <dashboard-map active="[[_isActive(partnershipPage,'map')]]"></dashboard-map>
        </div>
      </iron-pages>

    </app-header-layout>

  </template>

  <script>

    Polymer({

      is: 'page-dashboard',
      properties: {
        partnershipPage: {
          type: String,
          notify: true
        },
        routeData: {
          type: Object,
          notify: true
        },
        pageTitle: {
          type: String
        },
        availableYears: {
          type: Array,
          value: [
            {label: '2017', value: '/api/v2/hact/history/?year=2017&format=csv'},
            {label: '2018', value: '/api/v2/partners/hact?&format=csv'}
          ]
        },
      },
      behaviors: [
        etoolsAppConfig.globals,
        dashBehaviors.PageUtilsBehavior
      ],
      observers: [
        '_pageChanged(routeData.dashTab)',
        '_updateUrlTab(routeData.dashTab)',
      ],
      _pageChanged: function(dashTab) {
        this.set('partnershipPage', dashTab);
        dashTab === 'partnerships' ? this.set('pageTitle', 'CSO Dashboard') : this.set('pageTitle', 'Dashboard');
      },
      _updateUrlTab: function(tab) {
        if (!tab) {
          return;
        }
        this.debounce('debounce-url-tab-update', function() {
          this.fire('update-main-path', {path: this.route.path}, {bubbles: false});
        }.bind(this), 50);
      },
      _isActive: function(page, tab) {
        return _.isEqual(page, tab);
      },
      _goToAddTrip: function() {
        window.location.href = this.baseSite +'/t2f/edit-travel/-1';
      },
      _setExportYear: function() {
        this.exportUrl = event.target.dropdownValue;
      },
    });

  </script>

</dom-module>
