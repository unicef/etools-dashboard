<link rel="import"
      href="data-element-mixin.html">
<link rel="import" href="../config/config.html">


<script>
  'use strict';
  window.EtoolsDashboard = window.EtoolsDashboard || {};
  window.EtoolsDashboard.Mixins = window.EtoolsDashboard.Mixins || {};
  /**
   * `user-data` Description
   *
   * @summary ShortDescription.
   * @customElement
   * @polymer
   * @extends {Polymer.Element}
   */
  EtoolsDashboard.Mixins.UserData = (baseClass) =>
    class extends EtoolsDashboard.Mixins.DataElement(baseClass) {
      /**
       * Object describing property-related metadata used by Polymer features
       */
      static get properties() {
        return {
          endpointName: {
            type: String,
            value: 'user'
          },
          user: {
            type: Object,
            readOnly: true,
            notify: true
          },
          permissions: {
            type: Object,
            readOnly: true,
            notify: true,
          }

        };
      }

      _handleMyResponse(user) {
        if (!isEmpty(user)) {
          this._setUserData(user);
        }
      }

      _setUserData(data) {
        var _user = data;
        var _permissions = {};
        var permissionsList = EtoolsDashboard.Config.permissions;

        if (!_.isEmpty(data)) {
          permissionsList.defaultPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
          if (!_user.is_staff) {
            permissionsList.partnerOnlyPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });
          } else {
            // user is not partner but staff:
            permissionsList.managementPermissions.forEach(function(perm) {
              _permissions[perm] = true;
            });

            if (_user.profile.partner_staff_member) {
              // staff that has faked partnership by setting partner_staff_member on their profile
              permissionsList.partnerPermissions.forEach(function(perm) {
                _permissions[perm] = true;
              });
            }
          }
        } else {
          //for testing
          permissionsList.superPermissions.forEach(function(perm) {
            _permissions[perm] = true;
          });
        }
        this._setUser(_user);
        this._setPermissions(_permissions);
      }

      _handleError(rsp, err) {
        this._setUser(null);
        this._setPermissions(null);
      }
    };
</script>