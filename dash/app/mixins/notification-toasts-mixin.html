<link rel="import" href="../../../bower_components/paper-toast/paper-toast.html">

<script>
  'use strict';

  window.EtoolsDashboard = window.EtoolsDashboard || {};
  window.EtoolsDashboard.Mixins = window.EtoolsDashboard.Mixins || {};

  EtoolsDashboard.Mixins.NotificationToastsMixin = (superClass) => class extends superClass {
    constructor() {
      super()
    }

    static get properties() {
      return {
        _toast: {
          type: Object,
          value: null
        },
        _toastQueue: {
          type: Array,
          value: () => { []; }
        },
        currentToastMessage: {
          type: String,
          value: ''
        }
      }
    }

    ready() {
      this.addEventListener('toast', this.queueToast);
      super.ready();
    }

    queueToast(e, detail) {
      e.stopPropagation();
      if (!this._toast) {
        this._toast = document.createElement('paper-toast');
        this.listen(this._toast, 'iron-overlay-closed', 'dequeueToast');
        let closeToastBtn = document.createElement('paper-button');
        closeToastBtn.innerHTML = 'Ok';
        closeToastBtn.setAttribute('class', 'warning-toast-dismiss-btn');
        closeToastBtn.addEventListener('tap', this._toggleToast.bind(this, this._toast));
        Polymer.dom(this._toast).appendChild(closeToastBtn);
        // this.$.layout is app-drawer-layout element from app-shell.html
        let layout = this.$.layout;
        if (layout) {
          Polymer.dom(layout).appendChild(this._toast);
        } else {
          console.warn('app-drawer-layout element from app-shell must have id="layout"');
        }
      }
      if (!this._toastQueue.length) {
        this.push('_toastQueue', detail);
        let toastProperties = this._prepareToastAndGetShowProperties(detail);
        this._showToast(toastProperties);
      } else {
        let alreadyInQueue = this._toastQueue.filter(function(toastDetail) {
          return JSON.stringify(toastDetail) === JSON.stringify(detail);
        });
        if (alreadyInQueue.length === 0) {
          this.push('_toastQueue', detail);
        } // else already in the queue
      }
    }

    dequeueToast() {
      this.shift('_toastQueue');
      if (this._toastQueue.length) {
        let toastProperties = this._prepareToastAndGetShowProperties(this._toastQueue[0]);
        this._showToast(toastProperties);
      }
    }

    _prepareToastAndGetShowProperties(detail) {
      let closeToastBtn = Polymer.dom(this._toast).querySelector('paper-button');
      // clone detail obj
      let toastProperties = JSON.parse(JSON.stringify(detail));
      toastProperties.duration = 0;
      if (typeof detail === 'object' && typeof detail.showCloseBtn !== 'undefined') {
        if (detail.showCloseBtn === true) {
          closeToastBtn.removeAttribute('hidden');
        } else {
          closeToastBtn.setAttribute('hidden', true);
          if (!detail.duration) {
            toastProperties.duration = 5000;
          }
        }
        delete toastProperties.showCloseBtn;
      } else {
        closeToastBtn.setAttribute('hidden', true);
      }
      return toastProperties;
    }

    _toggleToast(toast) {
      if (toast) {
        toast.toggle();
      }
    }

    _showToast(toastProperties) {
      this.set('currentToastMessage', toastProperties.text);
      this._toast.show(toastProperties);
    }
  };
</script>