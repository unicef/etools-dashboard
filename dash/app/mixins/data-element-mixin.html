<link rel="import" href="../../modules/config/config.html">

<script>
  'use strict';

  window.EtoolsDashboard = window.EtoolsDashboard || {};
  window.EtoolsDashboard.Mixins = window.EtoolsDashboard.Mixins || {};

  EtoolsDashboard.Mixins.DataElementMixin = (superClass) => class extends superClass {
    constructor() {
      super()
    }

    static get properties() {
      return {
        endpoint: {
          type: Object,
        },
        data: {
          type: Array,
          readOnly: true,
          notify: true
        },
        endpointName: {
          observer: '_elementReady'
        },
        db: {
          type: Object,
          value: () => { etoolsAppConfig.db }
        },
        fireDataLoaded: {
          type: Boolean,
          value: false
        },
        showLoading: {
          type: Boolean,
          value: false
        }
      }
    }

    _elementReady() {
      if (!this.endpointName) {
        console.warn('Please specify an endpointName property');
      } else {
        this.endpoint = this.getEndpoint(this.endpointName);
      }
    }

    _handleResponse(res) {
      this._setData(res.detail);
      if (this.fireDataLoaded) {
        if (!this.dataLoadedEventName) {
          console.warn('Please specify data loaded event name(dataLoadedEventName property)');
        } else {
          this.fire(this.dataLoadedEventName);
        }
      }
    }

    _handleErrorResponse(response) {
      this.fire('global-loading', {active: false});
      var errors = response.detail.request.detail.request.response;
      if (this.ajaxEl.method === 'POST' || this.ajaxEl.method === 'PATCH') {
        // TODO: improve etools-ajax on-fail event data model (received errors)
        var errorMessage = 'An error occurred during save!';
        if (errors) {
          var errorMessages = ['Errors occurred:\n'];
          if (Array.isArray(errors) && errors.length > 0) {
            errors.forEach(function(err) {
              errorMessages.push(err + '\n');
            });
          } else if (typeof errors === 'object' && Object.keys(errors).length > 0) {
            for (var errField in errors) {
              if (typeof errors[errField] === 'string') {
                errorMessages.push('Field ' + errField + ' - ' + errors[errField] + '\n');
              } else if (typeof errors[errField] === 'object' && Object.keys(errors[errField]).length > 0) {
                for (var errF in errors[errField]) {
                  errorMessages.push('Field ' + errField + '(' + errF + ') - ' + errors[errField][errF] + '\n');
                }
              } else if (Array.isArray(errors[errField]) && errors[errField].length > 0) {
                for(var key in errors[errField]) {
                  errorMessages.push(errors[errField][key] + '\n');
                }
              }
            }
          }
          if (errorMessages.length > 1) {
            errorMessage = errorMessages.join('');
          }
        }
        this.fire('toast', {text: errorMessage, showCloseBtn: true});
      }
    }
  };
</script>
