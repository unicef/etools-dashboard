<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../mixins/common-general-mixin.html">
<link rel="import" href="../../mixins/list-filters-mixin.html">
<link rel="import" href="../../mixins/redux-store-mixin.html">
<link rel="import" href="data/partners-dropdown-data-mixin.html">

<link rel="import" href="data/map-interventions-data.html">

<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../../bower_components/leaflet-map/leaflet-map.html">
<link rel="import" href="../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">

<link rel="import" href="elements/marker-dialog.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/list-styles.html">
<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">

<dom-module id="view-map">
  <template>
    <style include="shared-styles paper-material-styles list-styles page-layout-styles">
      :host {
        --paper-toggle-button-checked-bar-color: #88D4F7;
        /* TODO: replace with app-theme var */
        --paper-toggle-button-checked-button-color: #3baaee;
        /* TODO: replace with app-theme var */
      }

      leaflet-map {
        height: 630px;
      }

      paper-menu {
        max-width: 266px;
      }


      .map {
        display: block;
      }

      .toggler {
        display: flex;
        bottom: 8px;
        margin-bottom: 20px;
        padding-left: 24px;
      }

      p {
        margin: 0;
      }

      paper-toggle-button {
        margin-left: 16px;
      }

      .error {
        color: var(--error-color);
        left: 24px;
        top: 60px;
        position: absolute;
      }
    </style>
    <app-route route="{{route}}"
               pattern="/dash/map"
               active="{{active}}"
               query-params="{{queryParams}}"></app-route>
    <div class="paper-material list-panel listControls"
         elevation="1">
      <div class="wrap-controls">
        <div class="title-row">
          <h1 sub-title>Partnerships</h1>
        </div>
        <p hidden$="[[hasResult]]"
           class="error">No results for this query</p>

      </div>
      <div class="filters-divider"></div>
      <div class="wrap-controls">
        <template is="dom-repeat"
                  items="[[selectedFilters]]"
                  as="filter">

          <template is="dom-if"
                    if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">

              <etools-dropdown label="[[filter.filterName]]"
                                     placeholder="&#8212;"
                                     disabled$="[[!filter.selectionOptions.length]]"
                                     options="[[filter.selectionOptions]]"
                                     option-value="[[filter.optionValue]]"
                                     option-label="[[filter.optionLabel]]"
                                     on-selected-changed="_handleSelect"
                                     trigger-value-change-event
                                     on-etools-selected-items-changed="esmmValueChanged"
                                     >
              </etools-dropdown>
              <paper-icon-button class="remove-field remove"
                                 icon="cancel"
                                 suffix
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>

          </template>
        </template>
      </div>
      <div class="fixed-controls">
        <div class="filters-divider"></div>
        <paper-menu-button id="filterMenu">
          <paper-button class="button"
                        slot="dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            add filter
          </paper-button>
          <paper-listbox slot="dropdown-content">
            <template is="dom-repeat"
                      items="[[availableListFilterOptions]]">
              <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
            </template>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>
    <div class="paper-material map"
         elevation="1">
      <!-- <template is="dom-if"
                if="[[staticDataLoaded]]"> -->
      <leaflet-map fit-to-markers
                   zoom="[[country.initial_zoom]]"
                   longitude="[[country.longitude]]"
                   latitude="[[country.latitude]]">
        <leaflet-tilelayer url="[[leafletUrl]]">
        </leaflet-tilelayer>
        <template is="dom-repeat"
                  items="[[markers]]"
                  as="marker">
          <leaflet-marker id="[[marker.id]]"
                          latitude="[[marker.point.latitude]]"
                          longitude="[[marker.point.longitude]]"
                          on-click="_openModal"></leaflet-marker>
        </template>
      </leaflet-map>
      <!-- </template> -->
    </div>
  </template>

  <script>

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsDashboard.Mixins.CommonGeneral
     * @appliesMixin EtoolsDashboard.Mixins.PartnersDropdownData
     * @appliesMixin EtoolsDashboard.Mixins.ReduxStore
     * @appliesMixin EtoolsDashboard.Mixins.MapInterventionsData
     * @appliesMixin EtoolsDashboard.Mixins.ListFilters
     */
    const EtoolsMapMixin = compose(
      EtoolsDashboard.Mixins.ReduxStore,
      EtoolsDashboard.Mixins.PartnersDropdownData,
      EtoolsDashboard.Mixins.MapInterventionsData,
      EtoolsDashboard.Mixins.ListFilters,
      EtoolsDashboard.Mixins.CommonGeneral
    )(Polymer.Element);

    /**
     * `view-map` Description
     *
     * @summary ShortDescription.
     * @customElement
     * @polymer
     */
    class ViewMap extends EtoolsMapMixin {
      /**
       * String providing the tag name to register the element under.
       */
      static get is() {
        return 'view-map';
      }

      /**
       * Object describing property-related metadata used by Polymer features
       */
      static get properties() {
        return {
          hasResult: {
            type: Boolean,
            value: true
          },
          countryProgrammes: {
            type: Array,
            statePath: 'countryProgrammes'
          },
          country_programme: {
            type: Object
          },
          sectors: {
            type: Array,
            statePath: 'sectors'
          },
          sector: {
            type: String
          },
          statuses: {
            type: Array,
            statePath: 'static.intervention_status'
          },
          userCountry: {
            type: Object,
            statePath: 'userCountry'
          },
          country: {
            type: Object
          },
          status: {
            type: String
          },
          selectedFilters: {
            type: Array
          },
          dashMap: {
            type: Object
          },
          mapFilter: {
            type: Object
          },
          filteredInterventions: {
            type: Array,
            observer: '_plotMarkers'
          },
          partner: {
            type: String
          },
          partners: {
            type: Array,
            value: []
          },
          availableListFilterOptions: {
            type: Array,
            value: []
          },
          staticDataLoaded: {
            type: Boolean,
            value: false
          },
          markerDialog: Object,
          leafletUrl: {
            type: String,
            value: 'https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXRvb2xzIiwiYSI6ImNqMGw4N3NtejAyMDIzMnBocHBsYjBsbXoifQ.VA-gzjqtTu-vr-8Ex9oEpA'
          }
        };
      }

      _handleSelect(e) {
        const { filter } = e.model;
        const { value } = e.detail;
        this.set(filter.path, value);
      }

      static get observers() {
        return [
          '_init(countryProgrammes,sectors,statuses,userCountry,partners)',
          '_filterChanged(country_programme, sector, status, partner)'
        ];
      }

      /**
       * Instance of the element is created/upgraded. Use: initializing state,
       * set up event listeners, create shadow dom.
       * @constructor
       */
      constructor() {
        super();
      }

      /**
       * Use for one-time configuration of your component after local DOM is initialized.
       */
      ready() {
        super.ready();
        L.Icon.Default.imagePath = '../../../dash/images';
        let markerEl = document.createElement('marker-dialog');
        markerEl.setAttribute('id', 'markerDialog');
        Polymer.dom(document.querySelector('body')).appendChild(markerEl);
        this.markerDialog = document.querySelector('#markerDialog');
      }

      _openModal(e) {
        let { id } = e.model.marker;
        let data = clone(this.locationsDict[id]);
        data.sections = data.sections.map((s)=> this.sectors.find((se)=>se.value === Number(s)).label );
        this.markerDialog.data = data;
        this.markerDialog.opened = true;
      }

      _init(countryProgrammes, sectors, statuses, userCountry, partners) {
        if (!countryProgrammes || !sectors || !statuses || !partners || !userCountry) {
          return;
        }


        if (!this.staticDataLoaded) {
          // initialize the intLocMap object
          this.queryMapInterventions('');
          this._validateUserCountry(userCountry);

          // this.fire('global-loading', {
          //   message: 'Loading page data...',
          //   active: true
          // });
        }
        this.set('staticDataLoaded', true);
        // this.fire('global-loading');
        if (_.isEmpty(this.availableListFilterOptions)) {
          this.initListFiltersData([
            {
              filterName: 'Country Programme',
              type: 'esmm',
              optionValue: 'value',
              optionLabel: 'label',
              alreadySelected: null,
              selectionOptions: map(({ name, id }) => ({ label: name, value: id }), countryProgrammes),
              path: 'country_programme'
            },
            {
              filterName: 'Sectors',
              type: 'esmm',
              optionValue: 'value',
              optionLabel: 'label',
              alreadySelected: null,
              selectionOptions: this.sectors,
              path: 'sector'
            },
            {
              filterName: 'Status',
              type: 'esmm',
              optionValue: 'value',
              optionLabel: 'label',
              alreadySelected: null,
              selectionOptions: this.statuses,
              path: 'status'
            },
            {
              filterName: 'Partners',
              type: 'esmm',
              optionValue: 'value',
              optionLabel: 'label',
              alreadySelected: null,
              selectionOptions: this.partners,
              path: 'partner'
            }
          ]);
        }
      }

      _filterChanged(country_programme, sector, status, partner) {
        let newFilter = {};
        if(country_programme && !isEmpty(country_programme)) {
          newFilter['country_programme'] = country_programme;
        }
        if(sector) {
          newFilter['sector'] = sector;
        }
        if(status) {
          newFilter['status'] = status;
        }
        if(partner) {
          newFilter['partner'] = partner;
        }
    
        if (equals(this.mapFilter, newFilter)) {
          return;
        }
        if (isEmpty(newFilter)) {
          this.set('markers', []);
          this.set('showActive', false);
          return;
        }
        this.set('hasResult', true);
        debugger;
        this.set('mapFilter', newFilter);
      }

      // ensure redux items loaded before initializing the filters
      _callLocations(locations) {
        this.queryMapLocations(locations);
      }

      _plotMarkers(locations) {
        if (!locations.length) {
          this.set('hasResult', false);
        }
        this.set('markers', locations);
        // this.fire('global-loading');
      }

      _partnerFilter(filter) {
        return filter.filterName === 'Partners';
      }

      _partnerChanged(val) {
        let id = path(['detail', 'selectedValues', 'id'], val);
        this.set('partner', id);
      }

      _validateUserCountry(userCountry) {
        if (userCountry) {
          if (!userCountry.longitude || !userCountry.latitude) {
            this.set('country', {
              latitude: '40',
              longitude: '38',
              initial_zoom: 2
            });
            console.warn('The current user country does not provide map coordinates');
          } else {
            this.set('country', userCountry);
          }
        }
      }
    }

    window.customElements.define(ViewMap.is, ViewMap);
  </script>
</dom-module>