<link rel="import" href="../../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../../../styles/shared-styles.html">
<link rel="import" href="../../../styles/list-styles.html">
<link rel="import" href="../../../styles/filter-styles.html">
<link rel="import" href="../../../styles/partnerships-styles.html">
<link rel="import" href="../../../styles/page-layout-styles.html">
<link rel="import" href="../../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="../../../../../bower_components/iron-icons/maps-icons.html">

<link rel="import" href="../../../config/config.html">

<link rel="import" href="../../../components/data-table/data-table-header.html">
<link rel="import" href="../../../components/data-table/data-table-column.html">
<link rel="import" href="../../../components/data-table/data-table-row.html">
<link rel="import" href="../../../components/data-table/data-table-footer.html">

<link rel="import" href="../../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../../bower_components/iron-icon/iron-icon.html">

<link rel="import"
      href="../../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">

<link rel="import" href="../../../mixins/date-mixin.html">
<link rel="import" href="../../../mixins/common-general-mixin.html">
<link rel="import" href="../../../mixins/list-filters-mixin.html">
<link rel="import" href="../../../mixins/pagination-with-filters-mixin.html">
<link rel="import" href="../../../mixins/redux-store-mixin.html">
<link rel="import" href="../../../endpoints/endpoints-mixin.html">

<link rel="import" href="../data/partnership-dashboard-data.html">

<dom-module id="cso-dashboard">
  <template>
    <style include="shared-styles grid-layout-styles iron-flex page-layout-styles 
                    paper-material-styles list-styles filter-styles partnerships-styles">

     .cso-title {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 8px;
      }

      .map-icon {
        color: var(--dark-icon-color);
        position: absolute;
        right: 24px;
        transform: translateY(-50%);
        display: none;
        cursor: pointer;
      }

      data-table-row:hover .last-pv {
        display: none;
      }

      data-table-row:hover .map-icon {
        display: block;
      }
      .blue-text {
        color: #24a0fc;
      }

      

    </style>

    <partnership-dashboard-data id="partnershipsDashboard"
                                filtered-partnerships-dashboard="{{filteredPartnershipsDashboard}}"
                                fire-data-loaded
                                active="[[active]]"
                                total-results="{{totalResults}}"
                                on-partnerships-dashboard-loaded="_requiredDataLoaded"
                                list-data-path="filteredPartnershipsDashboard"
                                preset-filters="{{presetFilters}}"
                                all-partners="{{allPartners}}"
    ></partnership-dashboard-data>

    <div class="paper-material list-panel" elevation="1">
      <span class="alerts-title">Alerts </span><span class="alerts-comment">(click to filter the list)</span>
      <div class="alerts-panel">
        <template is="dom-repeat"
                  items="[[presetFilters]]"
                  as="presets">
          <div on-tap="_showPresetFilter" class="alert-row" no-collapse>
            <div class="divider"></div>
            <div slot="row-data">
              <div class="col-1 alerts-total">[[presets.filteredPartnershipsDashboard.length]]</div>
              <div class="col-10 filter-name">[[presets.title]] <i>[[presets.status]]</i></div>
              <paper-icon-button class="remove-field remove red clear-button col-1"
                                icon="clear">
              </paper-icon-button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div id="customFilterPanel" class="paper-material list-panel listControls" elevation="1">
      <div class="wrap-controls">
        <paper-input id="query"
                    type="search"
                    autocomplete="off"
                    value="{{qs}}"
                    placeholder="Search"
                    always-float-label>
          <iron-icon icon="search"
                    slot="prefix"></iron-icon>
        </paper-input>

        <template is="dom-repeat"
                  items="[[selectedFilters]]"
                  as="filter">

          <!-- dropdown filters  -->
          <template is="dom-if"
                    if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">
              <etools-dropdown-multi label="[[filter.filterName]]"
                                    placeholder="&#8212;"
                                    disabled$="[[!filter.selectionOptions.length]]"
                                    options="[[filter.selectionOptions]]"
                                    option-value="[[filter.optionValue]]"
                                    option-label="[[filter.optionLabel]]"
                                    trigger-value-change-event
                                    on-etools-selected-items-changed="esmmValueChanged"
                                    data-filter-path$="[[filter.path]]"
                                    min-width="300px"
                                    horizontal-align="left"
                                    no-dynamic-align>
              </etools-dropdown-multi>
            </div>
          </template>
        </template>
      </div>
      <div class="fixed-controls">
        <div class="filters-divider"></div>
        <paper-menu-button id="filterMenu"
                          ignore-select
                          dynamic-align>
          <paper-button class="button"
                        slot="dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            filters
          </paper-button>
          <paper-listbox multi slot="dropdown-content" selected-values="[2]">
            <template is="dom-repeat"
                      items="[[listFilterOptions]]">
              <paper-icon-item on-tap="selectFilter">
                <iron-icon icon="check" slot="item-icon" hidden$="[[!item.selected]]"></iron-icon>
                [[item.filterName]]
              </paper-icon-item>
            </template>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>

    <div class="paper-material"
        id="list"
        elevation="1">
      <data-table-header no-collapse>
        <data-table-column class="col-2" field="name" sortable>
          Partner
        </data-table-column>
        <data-table-column class="col-1" sortable>
          Cost Centre
        </data-table-column>
        <data-table-column class="col-1" sortable>
          Section
        </data-table-column>
        <div class="col-6 layout horizontal">
          <data-table-column class="col-3 right-align" field="total_ct_cp" sortable>
            Cash in the<br>
            Current CP Cycle (USD)
          </data-table-column>
          <data-table-column class="col-3 right-align" field="total_ct_ytd" sortable>
            Cash in the<br>
            Current Year (USD)
          </data-table-column>
          <data-table-column class="col-3 right-align">
            Outstanding<br>
            DCT >6 Months
          </data-table-column>
          <data-table-column class="col-3 right-align">
            Outstanding<br>
            DCT >9 Months
          </data-table-column>
        </div>
        <data-table-column class="col-1 right-align" field="action_points" sortable>
          Action<br>
          Points
        </data-table-column>
        <data-table-column class="col-1 right-align" field="days_last_pv" sortable>
          Days Since<br>
          Last PV
        </data-table-column>
      </data-table-header>

      <template id="partnerListTemplate"
                items="{{filteredPartnershipsDashboard}}"
                filter="{{computeFilter(currentFilter)}}"
                is="dom-repeat"
                as="row">
        <data-table-row no-collapse>
          <div slot="row-data">
            <div class="col-2">
              <a href="[[baseSite]]/pmp/partners/[[row.id]]/details"
                app-name="pmp"
                page="partners"
                id="[[row.id]]/details"
                class="cso-title">
                  [[row.name]]
                  <paper-tooltip fit-to-visible-bounds>
                    [[row.name]]
                  </paper-tooltip>
              </a>
            </div>
            <div class="col-data col-1 sections">
              <!-- <template is="dom-repeat"
                        items="{{dividerSplit(row.locations)}}">
                [[item]]
                <br>
              </template> -->
              -
            </div>
            <div class="col-data col-1 sections">
              <span class="pad-top-4">
                <template is="dom-repeat"
                          items="{{commaSplit(row.sections)}}">
                  [[item]]
                  <br>
                </template>
              </span>
            </div>
            <div class="col-6 layout horizontal">
              <span class="col-3 right-align">
                [[row.total_ct_cp]]
              </span>
              <span class="col-3 right-align">
                [[row.total_ct_ytd]]
              </span>
              <span class="col-3 right-align">
                -
                <!-- [[row.outstanding_dct_amount_6_to_9_months_usd]] -->
              </span>
              <span class="col-3 right-align">
                -
                <!-- [[row.outstanding_dct_amount_more_than_9_months_usd]] -->
              </span>
            </div>
            <div class="col-1 right-align blue-text">
              [[row.action_points]]
            </div>
            <div class="col-1 col-data right-align">
              <span class="last-pv">[[displayNonZero(row.days_last_pv)]]</span>
              <iron-icon on-click="goToMaps"
                             class="map-icon"
                             icon="maps:map"></iron-icon>
            </div>
          </div>
        </data-table-row>
      </template>
      <data-table-footer id="csoDashboardFooter"
                        page-size="[[pageSize]]"
                        page-number="[[pageNumber]]"
                        visible-range="{{visibleRange}}"
                        on-page-size-changed="pageSizeChanged"
                        filtered-total-results="[[totalResults]]"
                        on-page-number-changed="pageNumberChanged">
      </data-table-footer>
    </div>
  </template>

  <script>
    'use strict';

    /**
      * @polymer
      * @mixinFunction
      * @appliesMixin EtoolsDashboard.Mixins.CommonGeneral
      * @appliesMixin EtoolsDashboard.Mixins.ReduxStore
      * @appliesMixin EtoolsDashboard.Mixins.ListFilters
      * @appliesMixin EtoolsDashboard.Mixins.PaginationWithFilters
      * @appliesMixin EtoolsDashboard.Mixins.Date
      * @appliesMixin EtoolsDashboard.Mixins.Endpoints
      */
      const CsoDashboardMixin = compose(
      EtoolsDashboard.Mixins.CommonGeneral,
      EtoolsDashboard.Mixins.ReduxStore,
      EtoolsDashboard.Mixins.ListFilters,
      EtoolsDashboard.Mixins.Endpoints,
      EtoolsDashboard.Mixins.PaginationWithFilters,
      EtoolsDashboard.Mixins.Date
      )(Polymer.Element);

    /**
    * @polymer
    * @customElement
    */
    class CsoDashboard extends CsoDashboardMixin {
      static get is() { return 'cso-dashboard'; }

      static get properties() {
        return {
          filteredPartnershipsDashboard: {
            type: Array,
            notify: true,
            observer: 'rangeChanged'
          },
          allPartners: {
            type: Array,
            value: [],
            observer: '_initListFilters'
          },
          allPartnersSet: {
            type: Boolean,
            value: false
          },
          currentFilter: {
            type: String,
            value: 'custom'
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          urlParams: {
            type: Object
          },
          sectors: {
            type: Array,
            statePath: 'sectors'
          },
          selectedSectors: {
            type: Array,
            observer: 'filterChanged'
          },
          selectedPartners: {
            type: Array,
            observer: 'filterChanged',
            value: []
          },
          // selectedCostCentres: {
          //   type: Array,
          //   observer: 'filterChanged'
          // },
          // selectedOustanding: {
          //   type: Boolean,
          //   value: false,
          //   observer: 'filterChanged'
          // },
          visibleRange: {
            type: Array,
            observer: 'rangeChanged'
          },
          pageNumber: {
            type: Number
          },
          route: {
            type: Object
          },
          params: {
            type: Array,
            value: function() {
              return [
                {
                  qName: 'qs',
                  propName: 'qs',
                  xf: identity
                },
                {
                  qName: 'sort',
                  propName: 'sortOrder',
                  xf: identity
                },
                {
                  qName: 'sortBy',
                  propName: 'orderBy',
                  xf: identity
                },
                {
                  qName: 'sectors',
                  propName: 'selectedSectors',
                  xf: compose(join('|'), map(prop('value')))
                },
                {
                  qName: 'name',
                  propName: 'selectedPartners',
                  xf: compose(join('|'), map(prop('name')))
                }
              ];
            }
          }
        };
      }

      static get observers() {
        return [
          '_updateUrl(qs, pageNumber, pageSize, sortOrder, orderBy, requiredDataLoaded, initComplete, selectedSectors, selectedPartners, selectedOffices, active)',
          '_init(active, sectors, requiredDataLoaded)'
        ];
      }

      _init(active, sectors, requiredDataLoaded) {
        let params = this.queryParams;
        if (!active || !sectors || !requiredDataLoaded) {
          return;
        }
        debugger;
        this.set('initComplete', false);
        this.set('qs', params.qs ? params.qs : '');
        this.set('pageNumber', params.page ? parseInt(params.page) : 1);
        this.set('pageSize', params.size ? parseInt(params.size) : 10);
        this.set('sortOrder', params.sort ? params.sort : 'asc');
        this.set('orderBy', params.orderBy || '');
        this.set('selectedSectors', params.sectors ? this._setSelectedSectors(params.sectors) : []);
        this.set('selectedPartners', params.partners ? this._setSelectedPartners(params.partners) : []);
    
        this._initListFilters();
        this.set('initComplete', true);
        this._updateSelectedFiltersValues();
      }

      _initListFilters() {
        if (!this.allPartnersSet) {
          this.initListFiltersData([
            {
              filterName: 'Partner Name',
              type: 'esmm',
              optionValue: 'id',
              optionLabel: 'name',
              selectionOptions: this.allPartners,
              alreadySelected: [],
              path: 'selectedPartners',
              selected: false
            },
            {
              filterName: 'Section/Cluster',
              type: 'esmm',
              optionValue: 'value',
              optionLabel: 'label',
              selectionOptions: this.sectors,
              alreadySelected: [],
              path: 'selectedSectors',
              selected: false
            }
            // {
            //   filterName: 'Cost Centre',
            //   type: 'esmm',
            //   optionValue: 'id',
            //   optionLabel: 'name',
            //   selectionOptions: this.offices,
            //   alreadySelected: [],
            //   path: 'selectedOffices',
            //   selected: false
            // },
            // {
            //   filterName: 'Outstanding DCT >9?',
            //   type: 'esmm',
            //   optionValue: 'value',
            //   optionLabel: 'label',
            //   selectionOptions: this.costCentres,
            //   alreadySelected: [],
            //   path: 'selectedOutstanding',
            //   selected: false
            // },
          ]);
        }
        if (this.allPartners.length) {
          this.set('allPartnersSet', true);
        }
      }

      _updateSelectedFiltersValues() {
        this.updateFiltersDebouncer = Polymer.Debouncer.debounce(
          this.updateFiltersDebouncer,
          Polymer.Async.timeOut.after(20), () => {
          let filtersValues = [
            {
              filterName: 'Section/Cluster',
              selectedValue: map(prop('value'), this.selectedSectors)
            },
            {
              filterName: 'Partner Name',
              selectedValue: map(prop('name', this.selectedPartners))
            }
          ];
          this.updateShownFilters(filtersValues);
        });
      }

      rangeChanged() {
        this._initListFilters;
        if (this.currentFilter !== 'custom') {
          this.$.partnerListTemplate.items = this.presetFilters[this.currentFilter-1].filteredPartnershipsDashboard.slice(
              this.visibleRange[0]-1,
              this.visibleRange[1]
            );
        } else if (this.filteredPartnershipsDashboard) {
          this.$.partnerListTemplate.items = this.filteredPartnershipsDashboard.slice(
              this.visibleRange[0]-1,
              this.visibleRange[1]
            );
        }
      }

      _updateUrl(query, pageNumber, pageSize, sortOrder, orderBy, requiredDataLoaded,
        initComplete, selectedSectors, selectedPartners) {
          if (!this.initComplete || !this.requiredDataLoaded) {
            debugger;
          return;
        }

        this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
        const qs = this.buildQueryString();
        const currentRoute = this.route.prefix + this.route.path;
        if (qs !== null) {
          this.updateAppState(currentRoute, qs, true);
          if (this.requiredDataLoaded) {
            this._filterPartnershipsDashboardData();
          }
        } else {
          if (location.search === '') {
            this.updateAppState(currentRoute, qs, false);
          }
          if (this.forceDataRefresh && this.requiredDataLoaded) {
            this._filterPartnershipsDashboardData();
            this.set('forceDataRefresh', false);
          }
        }
      }

      _buildCsvDownloadUrl() {
        let query = this.params.reduce((acc, { qName, propName, xf }) => {
          return isEmpty(this[propName]) ? acc
            : `${acc}${qName}=${xf(this[propName])}&`;
        }, '');
        query = query.split('|').join(',');
        return `${this.getEndpoint('partnershipsDashboard').url}/?${query}format=csv`;
      }

      _filterPartnershipsDashboardData() {
        this.$.partnershipsDashboard.query({
          searchString: this.qs,
          sectors: map(prop('label'), this.selectedSectors),
          name: this.selectedPartners,
          // costCentre: this.selectedOffices,
          orderBy: this.orderBy,
          order: this.sortOrder,
          pageSize: this.pageSize,
          pageNumber: this.pageNumber
        });
      }

      _requiredDataLoaded(event) {
        event.stopImmediatePropagation();
        const listDataPath = event.target.getAttribute('list-data-path');
        const list = this.get(listDataPath);

        if (typeof list === 'undefined' ||
          (Array.isArray(list) && list.length === 0)) {
          this.set('forceDataRefresh', true);
        }
        this.set('requiredDataLoaded', true);
        debugger;
      }

      _setSelectedSectors(sectorsStr) {
        const sectorsArr = sectorsStr.split('|');
        if (!isEmpty(sectorsArr)) {
          const selectedSectors = this.sectors.filter((s) => {
            return sectorsArr.indexOf(s.value) > -1;
          });
          return selectedSectors;
        }
        return [];
      }

      goToMaps(event) {
        let partnerId = event.model.__data.row.id;
        window.location = `/dash/map?&partners=${partnerId}`;
      }

      dividerSplit(string) {
        return string ? string.split('|') : ['-'];
      }

      _showPresetFilter(event) {
        let filterDiv = event.currentTarget.lastElementChild;
        let clickedFilter = event.model.__data.presets;

        // reset styling for all filter buttons
        this.shadowRoot.querySelectorAll('paper-icon-button.clear-button').forEach(
          (b) => b.style.opacity = '0'
        );
        this.shadowRoot.querySelectorAll('.filter-name').forEach(
          (r) => r.style.color = ''
        );

        if (this.currentFilter === clickedFilter.id) {
          this.set('currentFilter', 'custom');
        } else {
          // style selected filter button as pressed
          filterDiv.lastElementChild.style.opacity = '1';
          filterDiv.children[1].style.color = '#0099FF';
          this.set('currentFilter', clickedFilter.id);
        }

        // reset to first results page of new filter
        this.set('visibleRange', [1, 10]);
        this.rangeChanged();
        this.pageNumber = 1;

        // toggle custom filters visibility and footer totals source
        if (this.currentFilter === 'custom') {
          this.$.customFilterPanel.hidden = false;
          this.$.csoDashboardFooter.filteredTotalResults = this.totalResults;
        } else {
          this.$.customFilterPanel.hidden = true;
          this.$.csoDashboardFooter.filteredTotalResults = clickedFilter.total;
        }
      }

      computeFilter(filter) {
        return (row)=> {
          switch (filter) {
            case 'custom':
              return true;
            case '1':
              return row.alert_no_recent_pv === true;
            case '2':
              return row.alert_no_pv === true;
          }
        };
      }
    }

    window.customElements.define(CsoDashboard.is, CsoDashboard);
  </script>
</dom-module>