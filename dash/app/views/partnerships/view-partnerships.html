<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../../bower_components/polymer/lib/utils/debounce.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/list-styles.html">
<link rel="import" href="../../styles/page-layout-styles.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../styles/grid-layout-styles.html">
<link rel="import" href="../../../../bower_components/paper-styles/element-styles/paper-material-styles.html">

<link rel="import" href="../../styles/dash-icons.html">

<link rel="import" href="../../config/config.html">

<link rel="import" href="../../components/data-table/data-table-header.html">
<link rel="import" href="../../components/data-table/data-table-column.html">
<link rel="import" href="../../components/data-table/data-table-row.html">
<link rel="import" href="../../components/data-table/data-table-footer.html">

<link rel="import" href="../../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../../bower_components/app-route/app-route.html">


<link rel="import"
      href="../../../../bower_components/etools-dropdown/etools-dropdown-multi.html">
<link rel="import" href="../../../../bower_components/etools-datepicker/etools-datepicker-button.html">
<link rel="import" href="../../../../bower_components/etools-info-tooltip/etools-info-tooltip.html">

<link rel="import" href="../../mixins/date-mixin.html">
<link rel="import" href="../../mixins/common-general-mixin.html">
<link rel="import" href="../../mixins/list-filters-mixin.html">
<link rel="import" href="../../mixins/pagination-with-filters-mixin.html">
<link rel="import" href="../../mixins/redux-store-mixin.html">
<link rel="import" href="../../endpoints/endpoints-mixin.html">

<link rel="import" href="../../components/etools-date-input.html">

<link rel="import" href="data/partnership-data.html">

<dom-module id="view-partnerships">
  <template>
    <style include="shared-styles grid-layout-styles iron-flex iron-flex-layout page-layout-styles paper-material-styles list-styles">
      .no-header-line {
        --header-bottom-line: none;
      }
  
      .by-type {
        padding: 0;
        @apply --layout-horizontal;
      }
  
      span.title {
        color: var(--accent-color);
        font-weight: 500;
      }
    
      data-table-row span:not(:first-child),
      data-table-header data-table-column:not(:first-child) data-table-header data-table-column data-table-column,
      data-table-header div data-table-column data-table-column {
        box-sizing: border-box;
      }
  
      data-table-row div[slot="row-data"] div span,
      data-table-header div data-table-column data-table-column {
        padding-right: 8px;
      }
  
      data-table-row div[slot="row-data"] div:not(:first-child) span,
      data-table-header div data-table-column data-table-column {
        justify-content: flex-end;
      }
  
      data-table-row div[slot="row-data"] div span {
        display: flex;
      }

      data-table-header {
        height: 95px;
      }

      #query {
        padding-left: 24px;
      }
  
      .right-align {
        text-align: right;
      }
  
      div.sections {
        height: 48px;
        white-space: normal;
        overflow-y: scroll;
      }
  
      div.sections>span {
        vertical-align: middle;
        line-height: normal
      }
  
      div div span {
        height: 48px;
        align-items: center;
      }
  
      .blue-col {
        background-color: rgb(222, 242, 254);
        max-width: 100%;
      }
  
      .green-col {
        background-color: rgb(237, 247, 223);
        max-width: 100%;
      }
  
      .justify-end {
        justify-content: flex-end;
      }
  
      .to-date {
        background-image: -webkit-linear-gradient(135deg, rgb(222, 242, 254) 50%, rgb(237, 247, 223) 50%);
        height: 48px;
        max-width: 48px;
      }
  
      .red-icon {
        fill: rgb(231, 66, 45);
      }
  
      .blue-icon {
        fill: rgb(26, 154, 250);
      }
  
      data-table-row div div span.ip-pd {
        display: block;
        padding-top: 4px;
        padding-right: 8px;
      }
  
      .right-nudge {
        padding-right: 8px;
        box-sizing: border-box;
      }
  
      .no-padding {
        padding: 0;
      }
  
      .status {
        padding-left: 8px;
      }

      .divider {
        background-color: rgba(0, 0, 0, 0.3);
        height: 1px;
      }

      data-table-row.alert-row,
      .alert-row div[slot="row-data"],
      .alert-row div[slot="row-data"] data-table-column {
        height: 36px;
        width: 100%;
      }

      paper-icon-button.remove-field.remove.red {
        top: 0;
      }

      .alerts-panel {
        display: flex;
        flex-wrap: wrap;
        flex-direction: column;
        height: 148px;
      }

      .filter-name {
        cursor: pointer;
        white-space: nowrap;
      }

      .filter-name:hover {
        color: #0099FF;
      }

      .list-panel a {
        padding-right: 0;
      }

      .alerts-title {
        color: rgba(0,0,0,0.54);
        font-size: 13px;
        font-weight: 500;
        line-height: 15px;
      }
      
      .alerts-comment {
        color: rgba(0,0,0,0.54);
        font-size: 10px;
        font-weight: 500;
        line-height: 15px;
      }

      .alerts-total {
        text-align: right;
        padding-right: 16px;
      }

      .clear-button {
        opacity: 0.0;
      }

      .blocked-partner-container {
        background-color: #FFA149;
        @apply --layout-vertical;
        @apply --layout-center-justified;
        -webkit-border-radius: 50%;
        -moz-border-radius: 50%;
        border-radius: 50%;
      }

      .delete-partner {
        color: #ea4022;
        position: relative;
        bottom: 3px;
      }
      
      .delete-partner:after {
        content: "\00d7";
        color: rgba(255, 255, 255, 1);
        position: absolute;
        z-index: 1;
        bottom: 4.5px;
        width: 12px;
        height: 12px;
        left: 5.5px;
        font-weight: bold;
        font-size: xx-small;
      }

      .blocked-partner-container,
      .delete-partner {
        height: 16px;
        width: 16px;
        flex-basis: auto;
        align-items: center;
      }

      iron-icon.blocked-partner {
        color: rgba(255, 255, 255, 1);
        height: 12px;
        width: 12px;
      }

      .title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .partner-icons-group {
        display: inline-flex;
      }

    </style>
    <app-route route="{{route}}"
               pattern="/dash/partnerships"
               active="{{active}}"
               query-params="{{queryParams}}"></app-route>
  
    <partnership-data id="partnerships"
                      filtered-partnerships="{{filteredPartnerships}}"
                      fire-data-loaded
                      active="[[active]]"
                      total-results="{{totalResults}}"
                      on-partnerships-loaded="_requiredDataLoaded"
                      list-data-path="filteredPartnerships"
                      preset-filters="{{presetFilters}}">
    </partnership-data>
  
    <div class="paper-material list-panel" elevation="1">
      <span class="alerts-title">Alerts </span><span class="alerts-comment">(click to filter the list)</span>
      <div class="alerts-panel">
        <template is="dom-repeat"
                  items="[[presetFilters]]"
                  as="presets">
          <div on-tap="_showPresetFilter" class="alert-row" no-collapse>
            <div class="divider"></div>
            <div slot="row-data">
              <div class="col-1 alerts-total">[[presets.filteredPartnerships.length]]</div>
              <div class="col-10 filter-name">[[presets.title]] <i>[[presets.status]]</i></div>
              <paper-icon-button class="remove-field remove red clear-button col-1"
                                 icon="clear">
              </paper-icon-button>
            </div>
          </div>
        </template>
      </div>
    </div>

    <div id="customFilterPanel" class="paper-material list-panel listControls" elevation="1">
      <div class="wrap-controls">
        <paper-input id="query"
                     type="search"
                     autocomplete="off"
                     value="{{qs}}"
                     placeholder="Search"
                     always-float-label>
          <iron-icon icon="search"
                     slot="prefix"></iron-icon>
        </paper-input>
  
        <template is="dom-repeat"
                  items="[[selectedFilters]]"
                  as="filter">
  
          <!-- dropdown filters  -->
          <template is="dom-if"
                    if="[[filterTypeIs('esmm', filter.type)]]">
            <div class="filter esmm">
              <etools-dropdown-multi label="[[filter.filterName]]"
                                     placeholder="&#8212;"
                                     disabled$="[[!filter.selectionOptions.length]]"
                                     options="[[filter.selectionOptions]]"
                                     option-value="[[filter.optionValue]]"
                                     option-label="[[filter.optionLabel]]"
                                     selected-values="[[filter.alreadySelected]]"
                                     trigger-value-change-event
                                     on-etools-selected-items-changed="esmmValueChanged"
                                     data-filter-path$="[[filter.path]]">
              </etools-dropdown-multi>
              <paper-icon-button suffix
                                 class="remove-field remove"
                                 icon="cancel"
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>
  
          <!-- date pickers -->
          <template is="dom-if"
                    if="[[filterTypeIs('datepicker', filter.type)]]">
            <div class="filter">
              <etools-date-input id$="datepicker_[[filter.path]]"
                                 label="[[filter.filterName]]"
                                 placeholder="&#8212;"
                                 value="{{filter.dateSelected}}"
                                 format="D MMM YYYY"
                                 on-date-has-changed="_filterDateHasChanged"
                                 data-filter-path$="[[filter.path]]"
                                 fire-date-has-changed
                                 no-init
                                 show-clear-btn>
              </etools-date-input>
  
              <paper-icon-button suffix
                                 class="remove-field remove"
                                 icon="cancel"
                                 on-tap="removeFilter"
                                 data-filter-name$="[[filter.filterName]]"
                                 data-reset-path$="[[filter.path]]">
              </paper-icon-button>
            </div>
          </template>
        </template>
      </div>
      <div class="fixed-controls">
        <div class="filters-divider"></div>
        <paper-menu-button id="filterMenu"
                           dynamic-align>
          <paper-button class="button"
                        slot="dropdown-trigger">
            <iron-icon icon="filter-list"></iron-icon>
            add filter
          </paper-button>
          <paper-listbox slot="dropdown-content">
            <template is="dom-repeat"
                      items="[[availableListFilterOptions]]">
              <paper-item on-tap="selectFilter">[[item.filterName]]</paper-item>
            </template>
          </paper-listbox>
        </paper-menu-button>
      </div>
    </div>
  
    <div class="paper-material"
         id="list"
         elevation="1">
      <data-table-header no-collapse>
        <data-table-column class="col-5 no-header-line"
                           group-heading="blank"
                           transparent>
          <data-table-column class="col-5" sortable>
            IP Name
            <br>PD/SSFA Ref #
          </data-table-column>
          <div class="col-5 layout horizontal">
            <data-table-column class="col-4">
              Section
            </data-table-column>
            <data-table-column class="col-5">
              Field Office
            </data-table-column>
            <data-table-column class="col-3 status">
              Status
            </data-table-column>
          </div>
          <data-table-column class="col-2">
            Start Date
            <br>End Date
          </data-table-column>
        </data-table-column>
        <div class="col-7 layout horizontal">
          <data-table-column class="col-5"
                             group-heading="PLANNED BUDGET">
            <data-table-column class="col-2 right-align">
              PD Cur.
            </data-table-column>
            <data-table-column class="col-5 right-align">
              UNICEF
              <br>Supplies
            </data-table-column>
            <data-table-column class="col-5 right-align">
              UNICEF
              <br>Cash
            </data-table-column>
          </data-table-column>
          <data-table-column class="col-5 right-nudge"
                             group-heading="FUNDS RESERVED & DISBURSED">
            <data-table-column class="col-3 right-align">
              FR Cur.
            </data-table-column>
            <data-table-column class="col-5 right-align">
              FR
              <br>Amount
            </data-table-column>
            <data-table-column class="col-4 right-align">
              Actual
              <br>Disbursm.
            </data-table-column>
          </data-table-column>
          <data-table-column class="col-2 no-header-line"
                             group-heading="blank"
                             transparent>
            <data-table-column class="col-6 right-align">
              Disburs.
              <br>To Date
            </data-table-column>
            <data-table-column class="col-6 right-align">
              Days
              <br>Since
              <br>Last PV
            </data-table-column>
          </data-table-column>
        </div>
      </data-table-header>
  
      <template id="csoListTemplate"
                items="{{filteredPartnerships}}"
                filter="{{computeFilter(currentFilter)}}"
                is="dom-repeat"
                as="row">
        <data-table-row no-collapse>
          <div slot="row-data">
            <div class="col-5 layout horizontal">
              <span class="col-data layout-horizontal col-5 ip-pd">
                <div class="partner-icons-group" hidden="[[!_eitherTrue(row.partner_blocked, row.partner_marked_for_deletion)]]">
                  <div class="blocked-partner-container" hidden="[[!row.partner_blocked]]">
                    <iron-icon class="blocked-partner" icon="block"></iron-icon>
                    <paper-tooltip fit-to-visible-bounds>"Partner blocked"</paper-tooltip>
                  </div>
                  <div class="delete-container" hidden="[[!row.partner_marked_for_deletion]]">
                    <iron-icon class="delete-partner" icon="delete"></iron-icon>
                    <paper-tooltip fit-to-visible-bounds>"Partner marked for deletion"</paper-tooltip>
                  </div>
                </div>
                  <a href="[[baseSite]]/pmp/partners/[[row.partner_id]]/details"
                    app-name="pmp"
                    page="partners"
                    id="[[row.partner_id]]/details"
                    class="title">
                      [[row.partner_name]]
                      <paper-tooltip fit-to-visible-bounds>
                        [[row.partner_name]]
                      </paper-tooltip>
                  </a>
                <br>
                <a href="[[baseSite]]/pmp/interventions/[[row.intervention_id]]/details"
                  app-name="pmp"
                  page="interventions"
                  id="[[row.intervention_id]]/details"
                  class="title">
                    [[row.number]]
                    <paper-tooltip fit-to-visible-bounds>[[row.number]]</paper-tooltip>
                </a>
              </span>
              <span class="col-5">
                <span class="col-data col-4">
                  <div class="sections">
                    <span>
                      <template is="dom-repeat"
                                items="{{commaSplit(row.sections)}}">
                        [[item]]
                        <br>
                      </template>
                    </span>
                  </div>
                </span>
                <span class="col-data col-5">
                  <template is="dom-repeat"
                            items="{{commaSplit(row.offices_names)}}">
                    [[item]]
                    <br>
                  </template>
                </span>
                <span class="col-data col-3 status">
                  [[capitalizeWord(row.status)]]
                </span>
              </span>
              <span class="col-data col-2 date">
                [[prettyDate(row.start)]]
                <br> [[prettyDate(row.end)]]
              </span>
            </div>
            <div class="col-7 layout horizontal">
              <div class="col-5 layout horizontal">
                <span class="col-data col-2 right-align">
                  [[row.budget_currency]]
                </span>
                <span class="col-data col-5 right-align">
                  [[currencyFormat(row.unicef_supplies)]]
                </span>
                <span class="col-data col-5 right-align blue-col">
                  [[currencyFormat(row.unicef_cash)]]
                </span>
              </div>
              <div class="col-5 layout horizontal right-nudge">
                <span class="col-data col-3 right-align">
                  <iron-icon hidden="[[_checkSigned(row.status, row.all_currencies_are_consistent)]]"
                             icon="dash-custom-icons:not-equal"
                             class="blue-icon"></iron-icon>
                  <paper-tooltip hidden="[[_checkSigned(row.status, row.all_currencies_are_consistent)]]">
                    FR currency does not match PD currency.
                    <br> Disbursement to date % cannot calculate.
                  </paper-tooltip>
                  <iron-icon hidden="[[_checkAllCurrenciesConsistent(row.status, row.all_currencies_are_consistent, row.fr_currencies_are_consistent)]]"
                
                             icon="dash-custom-icons:1+"
                             class="blue-icon">
                  </iron-icon>
                  <paper-tooltip hidden="[[_checkSigned(row.status, row.fr_currencies_are_consistent)]]">
                    More than 1 FR currency is available. FR Amount
                    <br> and Actual Disbursements cannot be displayed.
                  </paper-tooltip>
                  [[row.fr_currency]]
                </span>
                <span class="col-data col-5 right-align">
                  <iron-icon hidden="[[_isEqual(row.status, row.unicef_cash, row.frs_total_frs_amt)]]"
                             icon="dash-custom-icons:not-equal"
                             class="red-icon">
                    [[_displayDisbursement(row.disbursement)]]
                  </iron-icon>
                  <paper-tooltip hidden="[[_isEqual(row.status, row.unicef_cash, row.frs_total_frs_amt)]]">
                    FR amount does not equal to planned UNICEF cash
                  </paper-tooltip>
                  [[currencyFormat(row.frs_total_frs_amt)]]
                </span>
                <span class="col-data col-4 right-align green-col">
                  <iron-icon hidden="[[_checkSigned(row.status, row.fr_currencies_are_consistent)]]"
                             icon="dash-custom-icons:not-equal"
                             class="blue-icon">
                  </iron-icon>
                  <paper-tooltip hidden="[[_checkSigned(row.status, row.fr_currencies_are_consistent)]]">
                    Disbursement currency does not match FR currency
                  </paper-tooltip>
                  <span hidden="[[!_checkSigned(row.status, row.fr_currencies_are_consistent)]]">[[_displayDisbursement(row.disbursement)]]</span>
                </span>
              </div>
              <div class="col-2 layout horizontal justify-end">
                <span class="col-data col-6 right-align to-date">
                  [[_getDisbPercent(row.disbursement_percent)]]
                </span>
                <span class="col-data col-6 right-align">
                  [[displayNonZero(row.days_last_pv)]]
                </span>
              </div>
            </div>
          </div>
        </data-table-row>
      </template>
      <data-table-footer id="csoDashboardFooter"
                         page-size="[[pageSize]]"
                         page-number="[[pageNumber]]"
                         visible-range="{{visibleRange}}"
                         on-page-size-changed="pageSizeChanged"
                         filtered-total-results="[[totalResults]]"
                         on-page-number-changed="pageNumberChanged">
      </data-table-footer>
    </div>
  </template>

  <script>
    'use strict';

    /**
     * @polymer
     * @mixinFunction
     * @appliesMixin EtoolsDashboard.Mixins.CommonGeneral
     * @appliesMixin EtoolsDashboard.Mixins.ReduxStore
     * @appliesMixin EtoolsDashboard.Mixins.ListFilters
     * @appliesMixin EtoolsDashboard.Mixins.PaginationWithFilters
     * @appliesMixin EtoolsDashboard.Mixins.Date
     */
    const ViewPartnershipsMixins = compose(
      EtoolsDashboard.Mixins.CommonGeneral,
      EtoolsDashboard.Mixins.ReduxStore,
      EtoolsDashboard.Mixins.ListFilters,
      EtoolsDashboard.Mixins.Endpoints,
      EtoolsDashboard.Mixins.PaginationWithFilters,
      EtoolsDashboard.Mixins.Date
      )(Polymer.Element);
    
    /**
     * `view-partnerships` Description
     *
     * @summary ShortDescription.
     * @customElement
     * @polymer
     */
    class ViewPartnerships extends ViewPartnershipsMixins {
      static get is() { return 'view-partnerships'; }

      /**
       * Object describing property-related metadata used by Polymer features
       */
      static get properties() {
        return {
          filteredPartnerships: {
            type: Array,
            notify: true,
            observer: 'rangeChanged'
          },
          currentFilter: {
            type: String,
            value: 'custom'
          },
          forceDataRefresh: {
            type: Boolean,
            value: false
          },
          requiredDataLoaded: {
            type: Boolean,
            value: false
          },
          initComplete: {
            type: Boolean,
            value: false
          },
          csvDownloadUrl: {
            type: String,
            notify: true
          },
          urlParams: {
            type: Object
          },
          sectors: {
            type: Array,
            statePath: 'sectors'
          },
          statuses: {
            type: Array,
            statePath: 'static.intervention_status'
          },
          offices: {
            type: Array,
            statePath: 'offices'
          },
          selectedSectors: {
            type: Array,
            observer: 'filterChanged'
          },
          selectedOffices: {
            type: Array,
            observer: 'filterChanged'
          },
          selectedStatuses: {
            type: Array,
            observer: 'filterChanged'
          },
          startAfterDate: {
            type: String,
            observer: 'dateChanged'
          },
          startBeforeDate: {
            type: String,
            observer: 'dateChanged'
          },
          endBeforeDate: {
            type: String,
            observer: 'dateChanged'
          },
          endAfterDate: {
            type: String,
            observer: 'dateChanged'
          },
          visibleRange: {
            type: Array,
            observer: 'rangeChanged'
          },
          pageNumber: {
            type: Number
          },
          route: {
            type: Object
          },
          params: {
            type: Array,
            value: function() {
              return [
                {
                  qName: 'qs',
                  propName: 'qs',
                  xf: identity
                },
                {
                  qName: 'sort',
                  propName: 'sortOrder',
                  xf: identity
                },
                {
                  qName: 'sectors',
                  propName: 'selectedSectors',
                  xf: compose(join('|'), map(prop('value')))
                },
                {
                  qName: 'offices',
                  propName: 'selectedOffices',
                  xf: compose(join('|'), map(prop('name')))
                },
                {
                  qName: 'status',
                  propName: 'selectedStatuses',
                  xf: compose(join('|'), map(prop('value')))
                },
                {
                  qName: 'startAfter',
                  propName: 'startAfterDate',
                  xf: (xs) => this.prettyDate(xs, 'YYYY-MM-DD')
                },
                {
                  qName: 'endBefore',
                  propName: 'endBeforeDate',
                  xf: (xs) => this.prettyDate(xs, 'YYYY-MM-DD')
                },
                {
                  qName: 'startBefore',
                  propName: 'startBeforeDate',
                  xf: (xs) => this.prettyDate(xs, 'YYYY-MM-DD')
                },
                {
                  qName: 'endAfter',
                  propName: 'endAfterDate',
                  xf: (xs) => this.prettyDate(xs, 'YYYY-MM-DD')
                }
              ];
            }
          }
        };
      }

      static get observers() {
        return [
          '_updateUrl(qs, pageNumber, pageSize, sortOrder, requiredDataLoaded, initComplete, selectedSectors, selectedOffices, selectedStatuses, startAfterDate, endBeforeDate, startBeforeDate, endAfterDate)',
          '_initListFilters(sectors, statuses, offices)',
          '_init(active, sectors, statuses, offices)'
        ];
      }

      _init(active, sectors, statuses, offices) {
        let params = this.queryParams;
        let staticLoaded = this._allHaveValues('sectors', 'statuses', 'offices');
        if (!active || !staticLoaded) {
          return;
        }
        this.set('initComplete', false);
        this.set('qs', params.qs ? params.qs : '');
        this.set('pageNumber', params.page ? parseInt(params.page) : 1);
        this.set('pageSize', params.size ? parseInt(params.size) : 10);
        this.set('sortOrder', params.sort ? params.sort : 'asc');
        this.set('selectedSectors', params.sectors ? this._setSelectedSectors(params.sectors) : []);
        this.set('selectedOffices', params.offices ? this._setSelectedOffices(params.offices) : []);
        this.set('selectedStatuses', params.status ? this._setSelectedStatuses(params.status) : this._setSelectedStatuses('signed|active|ended|suspended|terminated'));
        this.set('startAfterDate', params.startAfter ? params.startAfter : '');
        this.set('endBeforeDate', params.endBefore ? params.endBefore : '');
        this.set('startBeforeDate', params.startBefore ? params.startBefore : '');
        this.set('endAfterDate', params.endAfter ? params.endAfter : '');
        this.set('initComplete', true);
        this._updateSelectedFiltersValues();
        // the following should be removed when the final two preset filters are enabled
        if (this.shadowRoot.querySelectorAll('.alert-row').length > 0) {
          this.shadowRoot.querySelectorAll('.alert-row')[6].style.color = 'rgb(144,144,144)'
          this.shadowRoot.querySelectorAll('.alert-row')[6].children[1].children[0].innerText = "-"
          this.shadowRoot.querySelectorAll('.alert-row')[6].children[1].children[1].classList.remove('filter-name')
          this.shadowRoot.querySelectorAll('.alert-row')[7].style.color = 'rgb(144,144,144)'
          this.shadowRoot.querySelectorAll('.alert-row')[7].children[1].children[0].innerText = "-"
          this.shadowRoot.querySelectorAll('.alert-row')[7].children[1].children[1].classList.remove('filter-name')
        }
      }

      _initListFilters(sectors, statuses, offices) {
        if (!this._allHaveValues('sectors', 'statuses', 'offices')) {
          return;
        }
        this.initListFiltersData([
          {
            filterName: 'Section/Cluster',
            type: 'esmm',
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: this.sectors,
            alreadySelected: [],
            path: 'selectedSectors'
          },
          {
            filterName: 'Field Office',
            type: 'esmm',
            optionValue: 'id',
            optionLabel: 'name',
            selectionOptions: this.offices,
            alreadySelected: [],
            path: 'selectedOffices'
          },
          {
            filterName: 'Status',
            type: 'esmm',
            optionValue: 'value',
            optionLabel: 'label',
            selectionOptions: this.statuses.slice(1),
            alreadySelected: [],
            path: 'selectedStatuses'
          },
          {
            filterName: 'Starts After',
            type: 'datepicker', // etools-datepicker
            path: 'startAfterDate',
            dateSelected: ''
          },
          {
            filterName: 'Ends Before',
            type: 'datepicker', // etools-datepicker
            path: 'endBeforeDate',
            dateSelected: ''
          },
          {
            filterName: 'Starts Before',
            type: 'datepicker', // etools-datepicker
            path: 'startBeforeDate',
            dateSelected: ''
          },
          {
            filterName: 'Ends After',
            type: 'datepicker', // etools-datepicker
            path: 'endAfterDate',
            dateSelected: ''
          }
        ]);

      }

      _updateSelectedFiltersValues() {
        this.updateFiltersDebouncer = Polymer.Debouncer.debounce(
          this.updateFiltersDebouncer,
          Polymer.Async.timeOut.after(20), () => {
          let filtersValues = [
            {
              filterName: 'Section/Cluster',
              selectedValue: map(prop('value'), this.selectedSectors)
            },
            {
              filterName: 'Field Office',
              selectedValue: map(prop('id'), this.selectedOffices)
            },
            {
              filterName: 'Status',
              selectedValue: map(prop('value'), this.selectedStatuses)
            },
            {
              filterName: 'Starts After',
              selectedValue: this.startAfterDate
            },
            {
              filterName: 'Starts Before',
              selectedValue: this.startBeforeDate
            },
            {
              filterName: 'Ends Before',
              selectedValue: this.endBeforeDate
            },
            {
              filterName: 'Ends After',
              selectedValue: this.endAfterDate
            }
          ];
          this.updateShownFilters(filtersValues);
        });
      }

      rangeChanged() {
        if (this.currentFilter !== 'custom') {
          this.$.csoListTemplate.items = this.presetFilters[this.currentFilter-1].filteredPartnerships.slice(
              this.visibleRange[0]-1,
              this.visibleRange[1]
            );
        } else if (this.filteredPartnerships) {
          this.$.csoListTemplate.items = this.filteredPartnerships.slice(
              this.visibleRange[0]-1,
              this.visibleRange[1]
            );
        }
      }

      _updateUrl(query, pageNumber, pageSize, sortOrder, requiredDataLoaded,
        initComplete, selectedSectors, selectedOffices, selectedStatuses, startAfterDate, endBeforeDate, startBeforeDate, endAfterDate) {
        if (!this.initComplete || !this.requiredDataLoaded) {
          return;
        }
        this.set('csvDownloadUrl', this._buildCsvDownloadUrl());
        const qs = this.buildQueryString();
        const currentRoute = this.route.prefix + this.route.path;
        if (qs !== null) {
          this.updateAppState(currentRoute, qs, true);
          if (this.requiredDataLoaded) {
            this._filterPartnershipsData();
          }
        } else {
          if (location.search === '') {
            this.updateAppState(currentRoute, qs, false);
          }
          if (this.forceDataRefresh && this.requiredDataLoaded) {
            this._filterPartnershipsData();
            this.set('forceDataRefresh', false);
          }
        }
      }

      _buildCsvDownloadUrl() {
        let query = this.params.reduce((acc, { qName, propName, xf }) => {
          return isEmpty(this[propName]) ? acc
            : `${acc}${qName}=${xf(this[propName])}&`;
        }, '');
        query = query.split('|').join(',');
        return `${this.getEndpoint('cso_dashboard').url}/?${query}format=csv`;
      }

      _filterPartnershipsData() {
        this.$.partnerships.query({
          searchString: this.qs,
          sectors: map(prop('label'), this.selectedSectors),
          offices: map(prop('name'), this.selectedOffices),
          status: map(prop('value'), this.selectedStatuses),
          startAfterDate: this.startAfterDate,
          endBeforeDate: this.endBeforeDate,
          startBeforeDate: this.startBeforeDate,
          endAfterDate: this.endAfterDate,
          order: this.sortOrder,
          pageSize: this.pageSize,
          pageNumber: this.pageNumber
        });
      }

      _notifyDateChanged(event) {
        this._filterDateHasChanged(event);
        this._updateSelectedFiltersValues();
      }

      _requiredDataLoaded(event) {
        event.stopImmediatePropagation();
        const listDataPath = event.target.getAttribute('list-data-path');
        const list = this.get(listDataPath);

        if (typeof list === 'undefined' ||
          (Array.isArray(list) && list.length === 0)) {
          this.set('forceDataRefresh', true);
        }
        this.set('initComplete', false);
        this.set('requiredDataLoaded', true);
        this._init(this.active);
      }

      _setSelectedOffices(officesStr) {
        let officesIdsArr = officesStr.split('|');
        if (!isEmpty(officesIdsArr)) {
          officesIdsArr = officesIdsArr.map((n) => parseInt(n, 10));
          return this.offices.filter((o) => officesIdsArr.includes(parseInt(o.id, 10)));
        }
        return [];
      }

      _setSelectedSectors(sectorsStr) {
        const sectorsArr = sectorsStr.split('|');
        if (!isEmpty(sectorsArr)) {
          const selectedSectors = this.sectors.filter((s) => {
            return sectorsArr.indexOf(s.value) > -1;
          });
          return selectedSectors;
        }
        return [];
      }

      _setSelectedStatuses(statuses) {
        const statusesStrArr = statuses.split('|');
        if (isEmpty(this.statuses)) {
          return [];
        }
        return this.statuses.filter((status) => {
          return statusesStrArr.indexOf(status.value) > -1;
        });
      }

      _getDisbPercent(perc) {
        return perc === '0.00' ? '0'
          : perc === '!Error! (currencies do not match)' ? 'N/A'
            : `${Number(perc).toFixed(0)}%`;
      }

      _displayDisbursement(val) {
        let nonZero = this.displayNonZero(val);
        return Number(nonZero) ? this.currencyFormat(nonZero) : nonZero;
      }

      _isEqual(status, first, second) {
        return status === 'signed' ? true : (first === second);
      }

      _checkAllCurrenciesConsistent(status, all_currencies_are_consistent, fr_currencies_are_consistent) {
        return status === 'signed' ? true :
          (!all_currencies_are_consistent) ? true :
            (!fr_currencies_are_consistent) ? false : true;
      }

      _checkSigned(status, value) {
        return status === 'signed' ? true : value;
      }

      _eitherTrue(flag1, flag2) {
        return flag1 || flag2 ? true : false
      }

      _showPresetFilter(event) {
        let filterDiv = event.currentTarget.lastElementChild;
        let clickedFilter = event.model.__data.presets;
        // temporarily disables last two filters until data is ready
        if (clickedFilter.id === '7' || clickedFilter.id === '8') {
          return;
        }

        // reset styling for all filter buttons
        this.shadowRoot.querySelectorAll('paper-icon-button.clear-button').forEach(
          b => b.style.opacity = '0'
        );
        this.shadowRoot.querySelectorAll('.filter-name').forEach(
          r => r.style.color = ''
        );

        if (this.currentFilter === clickedFilter.id) {
          this.set('currentFilter', 'custom');
        } else {
          // style selected filter button as pressed
          filterDiv.lastElementChild.style.opacity = '1';
          filterDiv.children[1].style.color = '#0099FF';
          this.set('currentFilter', clickedFilter.id);
        }

        // reset to first results page of new filter
        this.set('visibleRange', [1, 10]);
        this.rangeChanged();
        this.pageNumber = 1;

        // toggle custom filters visibility and footer totals source
        if (this.currentFilter === 'custom') {
          this.$.customFilterPanel.hidden = false;
          this.$.csoDashboardFooter.filteredTotalResults = this.totalResults;
        } else {
          this.$.customFilterPanel.hidden = true;
          this.$.csoDashboardFooter.filteredTotalResults = clickedFilter.total;
        }
      }

      computeFilter(filter) {
        return function(row) {
          let eq = (stts) => stts === row.status;
          switch(filter) {
            case 'custom':
              return true;
              break;
            case '1':
              return row.status === 'signed'
                && (Date.parse(row.start) < new Date().getTime())
                && !row.frs_total_frs_amt;
              break;
            case '2':
              return ['active', 'ended', 'suspended'].some(eq)
                && (row.unicef_cash === row.frs_total_frs_amt);
              break;
            case '3':
              return ['active', 'ended'].some(eq) && (parseInt(row.days_last_pd) < 180);
              break;
            case '4':
              return ['active', 'suspended'].some(eq)
                && (Date.parse(row.end) < (new Date().getTime() + 2592000000));
              break;
            case '5':
              return row.status === 'ended' && (row.disbursement < row.frs_total_frs_amt);
              break;
            case '6':
              return row.status === 'ended' && !row.has_final_partnership_review;
              break;
            case '7':
              return true;
              break;
            case '8':
              return true;
              break;
          }
        };
      }
    }

    window.customElements.define(ViewPartnerships.is, ViewPartnerships);
  </script>
</dom-module>