<link rel="import" href="../../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../config/config.html">
<link rel="import" href="../../../../bower_components/etools-ajax/etools-ajax.html">
<link rel="import" href="../../mixins/data-element-mixin.html">

<dom-module id="partners-data">
  <template>
    <etools-ajax id="ajax"
                 endpoint="[[endpoint]]"
                 caching-storage="custom"
                 dexie-db-collection="partners"
                 on-success="_handleResponse">
    </etools-ajax>
  </template>

  <script>
    'use strict';
    // const requiredMixin = curry(compose(EtoolsDashboard.Mixins.DataElement));
    // const PartnersDataMixin = requiredMixin(Polymer.Element);
    /**
    * @polymer
    * @customElement
    * @appliesMixin EtoolsDashboard.Mixins.DataElement
    // * @extends {EtoolsDashboard.Mixins.DataElement}
    */
    class PartnersData extends EtoolsDashboard.Mixins.DataElement(Polymer.Element) {
      static get is() { return 'partners-data'; }

      static get properties() {
        return {
          endpointName: {
            type: String,
            value: 'partners'
          },
          currentQuery: {
            type: Object,
            value: null
          },
          filteredPartners: {
            type: Array,
            readOnly: true,
            notify: true
          },
          totalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },
          filteredTotalResults: {
            type: Number,
            readOnly: true,
            notify: true
          },
          totals: {
            type: Array,
            notify: true,
            readOnly: true
          },
          dataLoadedEventName: {
            type: String,
            value: 'partners-loaded'
          },
          loadedInitially: {
            type: Boolean,
            value: false
          },
          resultsTotals: {
            type: Boolean,
            value: false
          }
        }
      }

      static get observers() {
        return [ 'init(active)' ]
      }

      init(active) {
        if (active && !this.loadedInitially) {
          this.dispatchEvent(new CustomEvent('global-loading', {message: 'Loading partners data...', active: true}));
          this._elementReady();
          this.set('loadedInitially', true);
        }
      }
      
      query(searchString, order, pageSize, pageNumber) {
        let self = this;
        this.db.partners.toArray().then(res=> {
          self._setTotals(self._computeTotals(res));
          self._setTotalResults(res.length);
        });
        this.db.transaction('r', this.db.partners, ()=> {
          let queryResult = self.db.partners.orderBy('name');
          if (order === 'desc') {
            queryResult = queryResult.reverse();
          }
          if (!_.isEmpty(searchString)) {
            queryResult = queryResult.filter(function(partner) {
              return _.includes(partner.name.toLowerCase(), searchString.toLowerCase()) || _.includes(partner.vendor_number, searchString);
            });
          }
          return Dexie.Promise.all([
            queryResult.count(),
            // Use clone() as offset() and limit() otherwise mutates the same query that is counted
            queryResult.clone()
                .offset((pageNumber - 1) * pageSize)
                .limit(pageSize)
                .toArray()]);
        }).then(function(countAndResult) {
          self.fire('global-loading');
          self._setFilteredTotalResults(countAndResult[0]);
          self._setFilteredPartners(countAndResult[1]);
        }).catch(function(error) {
          console.error('Error querying partners: ', error);
        });
      }

      _computeTotals(results) {
        let _flattenObject = (ob) => {
          let toReturn = {};
          for (let i in ob) {
            if (!ob.hasOwnProperty(i)) continue;
            if ((typeof ob[i]) == 'object') {
              let flatObject = _flattenObject(ob[i]);
              for (let x in flatObject) {
                if (!flatObject.hasOwnProperty(x)) continue;
                toReturn[i + '_' + x] = flatObject[x];
              }
            } else {
              toReturn[i] = ob[i];
            }
          }
          return toReturn;
        }
        this.resultsTotals = true;
        return _(results).reduce((sum, obj)=> {
          let picked = _(obj).pick([
            'shared_with',
            'total_ct_ytd',
            'hact_values',
            'net_ct_cy',
            'hact_min_requirements',
            'outstanding_findings',
            'reported_cy',
            'planned_engagement'
          ]).value();
          picked = _flattenObject(picked)
          picked['shared_with'] = obj['shared_with']
          _(picked).each((val, key)=> {
            let currValue = sum[key] ? sum[key] : 0;
            if (key === 'shared_with') {
              sum[key] = currValue + (val === null ? 0 : 1);
            } else {
              sum[key] = currValue + Number(val);
            }
          });
          return sum;
        }, {});
      }
    }

    window.customElements.define(PartnersData.is, PartnersData);
  </script>
</dom-module>
